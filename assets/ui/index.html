<!-- Included from: ./components/data/CDN.html -->
<!--
  CDN URL injection and font loading
  This must come first to ensure CDN_ASSETS_URL is available for other components
-->

<!-- CDN URL injection -->
<div id="get-cdn" style="display: none">{{CDN_ASSETS_URL}}</div>

<script>
  // Extract CDN_ASSETS_URL from injected DOM (fallback to relative root)
  try {
    const cdnDiv = document.getElementById("get-cdn");
    if (cdnDiv && typeof cdnDiv.textContent === "string") {
      const val = cdnDiv.textContent.trim();
      if (val) window.CDN_ASSETS_URL = val;
    }
    if (!window.CDN_ASSETS_URL) window.CDN_ASSETS_URL = "";
  } catch {}

  // Dynamically inject Fredoka font-face rules with CDN support
  (function () {
    const cdn = (window.CDN_ASSETS_URL || "").replace(/\/$/, "");
    const basePath = cdn ? `${cdn}/fonts` : "../fonts";

    const fontFaces = [
      { weight: 300, file: "Fredoka-Light.ttf" },
      { weight: 400, file: "Fredoka-Regular.ttf" },
      { weight: 500, file: "Fredoka-Medium.ttf" },
      { weight: 600, file: "Fredoka-SemiBold.ttf" },
      { weight: 700, file: "Fredoka-Bold.ttf" },
    ];

    const style = document.createElement("style");
    style.textContent = fontFaces
      .map(
        (ff) => `
      @font-face {
        font-family: "Fredoka";
        src: url("${basePath}/${ff.file}") format("truetype");
        font-weight: ${ff.weight};
        font-style: normal;
        font-display: swap;
      }
    `
      )
      .join("\n");

    document.head.appendChild(style);
  })();
</script>


<!-- Included from: ./components/data/PlayerId.html -->
<!--
  PlayerId Component
  Stores the current player's ID in the DOM for use by Scene UI templates.
  This allows Scene UIs to filter visibility based on the current player.
-->

<script>
  (function () {
    let playerId = undefined;

    hytopia.onData((data) => {
      function setPlayerId(id) {
        playerId = id;
        // Create an invisible element and store the player ID in it
        const playerIdElement = document.createElement("div");
        playerIdElement.id = "playerId";
        // Store player ID in data attribute
        playerIdElement.dataset.playerId = playerId;
        playerIdElement.style.display = "none";
        document.body.appendChild(playerIdElement);
      }

      // Handle INIT event with playerId in payload
      if (data.type === "INIT" && data.payload?.playerId && !playerId) {
        setPlayerId(data.payload.playerId);
      }
      // Handle direct playerId for backwards compatibility
      else if (data.playerId && !playerId) {
        setPlayerId(data.playerId);
      }
    });
  })();
</script>


<!-- Included from: ./core.html -->
<!--
  Core utilities and global functions
  Includes number formatting and global state initialization
-->

<script>
  // Global function to show/hide HUD elements when modals are open
  window.setModalOpen = function(isOpen) {
    if (isOpen) {
      document.body.classList.add('modal-open');
    } else {
      document.body.classList.remove('modal-open');
    }
  };

  // Check if any modal is currently open (has .visible class)
  window.isAnyModalOpen = function() {
    // Check all known modal IDs
    const modalIds = [
      'pickaxe-modal',
      'miner-modal',
      'rebirth-modal',
      'pets-modal',
      'egg-modal',
      'maps-modal',
      'merchant-ui',
      'gem-trader-ui',
      'mine-reset-upgrade-ui'
    ];

    for (const id of modalIds) {
      const modal = document.getElementById(id);
      if (modal && modal.classList.contains('visible')) {
        return true;
      }
    }
    return false;
  };

  // Format number for popups - max 3 digits (including decimals) followed by letter suffix
  function formatPopupNumber(value) {
    if (value < 0) return '-' + formatPopupNumber(-value);
    if (value === 0) return '0';

    // Helper to format with exactly max 3 digits total (including decimals, excluding decimal point)
    const formatWithMax3Digits = (num, suffix) => {
      // Count digits in integer part
      const intPart = Math.floor(num);
      const intDigits = intPart.toString().length;

      // If integer part is 3+ digits, show as integer (e.g., 100-999)
      if (intDigits >= 3) {
        return Math.round(num).toString() + suffix;
      }

      // If integer part is 2 digits (10-99), can add 1 decimal place to make 3 digits total
      if (intDigits === 2) {
        const with1Dec = num.toFixed(1);
        const digitsCount = with1Dec.replace('.', '').length;
        if (digitsCount <= 3) {
          return with1Dec.replace(/\.0+$/, '') + suffix;
        }
        // If adding decimal exceeds 3 digits, show as integer
        return Math.round(num).toString() + suffix;
      }

      // If integer part is 1 digit (1-9), can add up to 2 decimal places to make 3 digits total
      if (intDigits === 1) {
        const with2Dec = num.toFixed(2);
        const digitsCount = with2Dec.replace('.', '').length;
        if (digitsCount <= 3) {
          return with2Dec.replace(/\.0+$/, '') + suffix;
        }
        // Try 1 decimal place
        const with1Dec = num.toFixed(1);
        const digitsCount1 = with1Dec.replace('.', '').length;
        if (digitsCount1 <= 3) {
          return with1Dec.replace(/\.0+$/, '') + suffix;
        }
        // Fallback to integer
        return Math.round(num).toString() + suffix;
      }

      // For numbers < 1 (intDigits === 0), show up to 3 significant digits
      // This is rare for power gains, but handle it
      const with3Dec = num.toFixed(3);
      const digitsCount = with3Dec.replace('.', '').replace(/^0+/, '').length;
      if (digitsCount <= 3) {
        return with3Dec.replace(/\.?0+$/, '').replace(/^0\./, '0.') + suffix;
      }
      return num.toFixed(2).replace(/\.?0+$/, '') + suffix;
    };

    // Handle very large numbers (same structure as formatNumber)
    if (value >= 1e36) {
      const num = value / 1e36;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'UDe');
      return formatWithMax3Digits(num, 'UDe');
    }
    if (value >= 1e33) {
      const num = value / 1e33;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'UDe');
      return formatWithMax3Digits(num, 'De');
    }
    if (value >= 1e30) {
      const num = value / 1e30;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'De');
      return formatWithMax3Digits(num, 'No');
    }
    if (value >= 1e27) {
      const num = value / 1e27;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'No');
      return formatWithMax3Digits(num, 'Oc');
    }
    if (value >= 1e26) {
      const num = value / 1e26;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'Oc');
      return formatWithMax3Digits(num, 'Oc');
    }
    if (value >= 1e24) {
      const num = value / 1e24;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'Oc');
      return formatWithMax3Digits(num, 'Sp');
    }
    if (value >= 1e21) {
      const num = value / 1e21;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'Sp');
      return formatWithMax3Digits(num, 'Sx');
    }
    if (value >= 1e18) {
      const num = value / 1e18;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'Sx');
      return formatWithMax3Digits(num, 'Qn');
    }
    if (value >= 1e15) {
      const num = value / 1e15;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'Qn');
      return formatWithMax3Digits(num, 'Q');
    }
    if (value >= 1e12) {
      const num = value / 1e12;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'Q');
      return formatWithMax3Digits(num, 'T');
    }
    if (value >= 1e9) {
      const num = value / 1e9;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'T');
      return formatWithMax3Digits(num, 'B');
    }
    if (value >= 1e6) {
      const num = value / 1e6;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'B');
      return formatWithMax3Digits(num, 'M');
    }
    if (value >= 1e3) {
      const num = value / 1e3;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'M');
      return formatWithMax3Digits(num, 'K');
    }
    // Less than 1000 - show as integer (max 3 digits naturally)
    return Math.round(value).toString();
  }

  // Global number formatting function - limits to 1-2 decimal places max with letter abbreviations
  function formatNumber(value) {
    if (value < 0) return '-' + formatNumber(-value);
    if (value === 0) return '0';

    // Helper to format with 1-2 decimal places and remove trailing zeros
    const formatWithSuffix = (num, suffix) => {
      // Try 1 decimal place first
      const with1Dec = num.toFixed(1);
      if (with1Dec.endsWith('.0')) {
        // If it ends in .0, show as integer
        return Math.round(num).toString() + suffix;
      }
      // Try 2 decimal places if needed
      const with2Dec = num.toFixed(2);
      if (with2Dec.endsWith('.00')) {
        // If it ends in .00, show as integer
        return Math.round(num).toString() + suffix;
      }
      // Remove trailing zeros (e.g., 1.50 -> 1.5, 2.30 -> 2.3)
      return with2Dec.replace(/\.?0+$/, '') + suffix;
    };

    // Handle very large numbers
    if (value >= 1e36) {
      const num = value / 1e36;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'UDe');
      return formatWithSuffix(num, 'UDe');
    }
    if (value >= 1e33) {
      const num = value / 1e33;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'UDe');
      return formatWithSuffix(num, 'De');
    }
    if (value >= 1e30) {
      const num = value / 1e30;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'De');
      return formatWithSuffix(num, 'No');
    }
    if (value >= 1e27) {
      const num = value / 1e27;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'No');
      return formatWithSuffix(num, 'Oc');
    }
    if (value >= 1e26) {
      const num = value / 1e26;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'Oc');
      return formatWithSuffix(num, 'Oc');
    }
    if (value >= 1e24) {
      const num = value / 1e24;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'Oc');
      return formatWithSuffix(num, 'Sp');
    }
    if (value >= 1e21) {
      const num = value / 1e21;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'Sp');
      return formatWithSuffix(num, 'Sx');
    }
    if (value >= 1e18) {
      const num = value / 1e18;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'Sx');
      return formatWithSuffix(num, 'Qn');
    }
    if (value >= 1e15) {
      const num = value / 1e15;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'Qn');
      return formatWithSuffix(num, 'Q');
    }
    if (value >= 1e12) {
      const num = value / 1e12;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'Q');
      return formatWithSuffix(num, 'T');
    }
    if (value >= 1e9) {
      const num = value / 1e9;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'T');
      return formatWithSuffix(num, 'B');
    }
    if (value >= 1e6) {
      const num = value / 1e6;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'B');
      return formatWithSuffix(num, 'M');
    }
    if (value >= 1e3) {
      const num = value / 1e3;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'M');
      return formatWithSuffix(num, 'K');
    }
    // Less than 1000 - show as integer
    return Math.round(value).toString();
  }
</script>


<!-- Included from: ./components/SceneUITemplates.html -->
<!--
  SceneUI Templates
  Registers templates for training:prompt, egg:prompt, and shop:prompt
  These are used by the server to create floating UI elements attached to world objects
-->

<script>
  // Register SceneUI templates as soon as hytopia is available
  // This ensures templates are available when server creates SceneUIs
  (function registerSceneUITemplates() {
    if (window.__trainingSceneTemplatesRegistered) return;

    // Wait for hytopia to be available
    if (typeof hytopia === 'undefined') {
      setTimeout(registerSceneUITemplates, 10);
      return;
    }

    window.__trainingSceneTemplatesRegistered = true;
    if (!window.__sceneUiReadySent && typeof hytopia?.sendData === 'function') {
      window.__sceneUiReadySent = true;
      hytopia.sendData({ type: 'SCENE_UI_READY' });
    }

    // Training rock prompt template
    // Uses playerStates dictionary for player-specific visibility
    // Two-mode display: 'far' mode shows rock info, 'close' mode shows interaction prompt
    hytopia.registerSceneUITemplate('training:prompt', (_id, onState) => {
      const root = document.createElement('div');
      root.className = 'scene-training-prompt'; // Start hidden until player state is checked

      // Create content container for mode-based rendering
      const content = document.createElement('div');
      content.className = 'scene-training-prompt__content';
      root.appendChild(content);

      // Helper to get current player ID from DOM (set by PlayerId.html component)
      function getCurrentPlayerId() {
        const playerIdElement = document.getElementById('playerId');
        return playerIdElement?.dataset?.playerId;
      }

      // Handle state updates
      onState(state => {
        const data = state || {};

        // Check player-specific visibility using playerStates dictionary
        const currentPlayerId = getCurrentPlayerId();
        const playerStates = data.playerStates || {};

        console.log('[TrainingUI] State update received:', {
          currentPlayerId,
          playerStatesKeys: Object.keys(playerStates),
          playerStates: JSON.stringify(playerStates),
        });

        // If playerStates exists and we have a player ID, use player-specific visibility
        if (currentPlayerId && Object.keys(playerStates).length > 0) {
          const playerState = playerStates[currentPlayerId];
          console.log('[TrainingUI] Player state for', currentPlayerId, ':', playerState);

          // Only show if this player's state says visible
          if (playerState?.visible === true) {
            root.classList.add('visible');
            root.style.display = 'flex';

            // Toggle locked state based on player's canTrain
            if (playerState.canTrain === false) {
              root.classList.add('locked');
            } else {
              root.classList.remove('locked');
            }

            // Determine mode (far or close)
            const mode = playerState.mode || 'far';
            console.log('[TrainingUI] Mode for player', currentPlayerId, ':', mode, '(raw:', playerState.mode, ')');

            // Remove existing mode classes
            root.classList.remove('mode-far', 'mode-close');
            root.classList.add('mode-' + mode);
            console.log('[TrainingUI] Applied classes:', root.className);

            // Render content based on mode
            if (mode === 'close') {
              console.log('[TrainingUI] Rendering CLOSE mode content');
              // Close mode - show interaction key + "Train" text
              content.innerHTML = `
                <div class="scene-training-prompt__interaction">
                  <div class="scene-training-prompt__key">E</div>
                  <div class="scene-training-prompt__action">Train</div>
                </div>
              `;
            } else {
              console.log('[TrainingUI] Rendering FAR mode content');
              // Far mode - show rock info (icon, requirements, power gain)
              const rockName = playerState.rockName || data.rockName || 'Training Rock';
              const powerGain = playerState.powerGain || data.powerGainText || '+1 Power';
              const requirementText = data.requirementText || '0 Required';
              const rebirthText = data.rebirthText || '0 Rebirths';
              const powerGainText = data.powerGainText || '+1 Power';

              content.innerHTML = `
                <div class="scene-training-prompt__icon">\uD83D\uDCA5</div>
                <div class="scene-training-prompt__copy">
                  <div class="scene-training-prompt__requirement">${requirementText}</div>
                  <div class="scene-training-prompt__or">OR</div>
                  <div class="scene-training-prompt__rebirth">${rebirthText}</div>
                  <div class="scene-training-prompt__power-gain">${powerGainText}</div>
                </div>
              `;
            }
          } else {
            root.classList.remove('visible');
            root.style.display = 'none';
          }
        } else {
          // Fallback: use global visible flag if no playerStates (backwards compatibility)
          if (data.visible === false) {
            root.classList.remove('visible');
            root.style.display = 'none';
          } else {
            root.classList.add('visible');
            root.style.display = 'flex';

            // Default to far mode for backwards compatibility
            root.classList.remove('mode-far', 'mode-close');
            root.classList.add('mode-far');

            const requirementText = data.requirementText || '0 Required';
            const rebirthText = data.rebirthText || '0 Rebirths';
            const powerGainText = data.powerGainText || '+1 Power';

            content.innerHTML = `
              <div class="scene-training-prompt__icon">\uD83D\uDCA5</div>
              <div class="scene-training-prompt__copy">
                <div class="scene-training-prompt__requirement">${requirementText}</div>
                <div class="scene-training-prompt__or">OR</div>
                <div class="scene-training-prompt__rebirth">${rebirthText}</div>
                <div class="scene-training-prompt__power-gain">${powerGainText}</div>
              </div>
            `;
          }

          // Toggle locked state
          if (data.canTrain === false) {
            root.classList.add('locked');
          } else {
            root.classList.remove('locked');
          }
        }
      });

      return root;
    });

    // Egg station prompt template
    hytopia.registerSceneUITemplate('egg:prompt', (_id, onState) => {
      const root = document.createElement('div');
      root.className = 'scene-egg-prompt visible';

      const icon = document.createElement('div');
      icon.className = 'scene-egg-prompt__icon';
      icon.textContent = '\uD83E\uDD5A'; // ðŸ¥š
      root.appendChild(icon);

      const copy = document.createElement('div');
      copy.className = 'scene-egg-prompt__copy';
      root.appendChild(copy);

      const title = document.createElement('div');
      title.className = 'scene-egg-prompt__title';
      title.textContent = 'Egg';
      copy.appendChild(title);

      const subtitle = document.createElement('div');
      subtitle.className = 'scene-egg-prompt__subtitle';
      subtitle.textContent = 'Open eggs here';
      copy.appendChild(subtitle);

      const cost = document.createElement('div');
      cost.className = 'scene-egg-prompt__cost';
      cost.textContent = '0 gold';
      copy.appendChild(cost);

      onState(state => {
        const data = state || {};
        if (data.title !== undefined) title.textContent = data.title;
        if (data.subtitle !== undefined) {
          subtitle.textContent = data.subtitle;
          // Hide subtitle if empty so this looks like the reference (name + cost only).
          subtitle.style.display = data.subtitle ? 'block' : 'none';
        }
        if (data.costText !== undefined) cost.textContent = data.costText;

        if (data.visible === false) root.classList.remove('visible');
        else root.classList.add('visible');
      });

      return root;
    });

    // Shop prompt template (merchant, gem trader, timer upgrade)
    hytopia.registerSceneUITemplate('shop:prompt', (_id, onState) => {
      const root = document.createElement('div');
      root.className = 'scene-shop-prompt visible';

      const title = document.createElement('div');
      title.className = 'scene-shop-prompt__title';
      title.textContent = 'Shop';
      root.appendChild(title);

      const subtitle = document.createElement('div');
      subtitle.className = 'scene-shop-prompt__subtitle';
      subtitle.textContent = 'Interact to open';
      root.appendChild(subtitle);

      onState(state => {
        const data = state || {};
        if (data.title !== undefined) title.textContent = data.title;
        if (data.subtitle !== undefined) subtitle.textContent = data.subtitle;

        if (data.kind) {
          root.classList.remove('scene-shop-prompt--ore', 'scene-shop-prompt--timer', 'scene-shop-prompt--upgrades');
          root.classList.add(`scene-shop-prompt--${data.kind}`);
        }

        if (data.visible === false) root.classList.remove('visible');
        else root.classList.add('visible');
      });

      return root;
    });

  })();
</script>


<!-- Included from: ./components/SetupAndEventHandlers.html -->

<script>
  // Format number for popups - max 3 digits (including decimals) followed by letter suffix
  function formatPopupNumber(value) {
    if (value < 0) return '-' + formatPopupNumber(-value);
    if (value === 0) return '0';
    
    // Helper to format with exactly max 3 digits total (including decimals, excluding decimal point)
    const formatWithMax3Digits = (num, suffix) => {
      // Count digits in integer part
      const intPart = Math.floor(num);
      const intDigits = intPart.toString().length;
      
      // If integer part is 3+ digits, show as integer (e.g., 100-999)
      if (intDigits >= 3) {
        return Math.round(num).toString() + suffix;
      }
      
      // If integer part is 2 digits (10-99), can add 1 decimal place to make 3 digits total
      if (intDigits === 2) {
        const with1Dec = num.toFixed(1);
        const digitsCount = with1Dec.replace('.', '').length;
        if (digitsCount <= 3) {
          return with1Dec.replace(/\.0+$/, '') + suffix;
        }
        // If adding decimal exceeds 3 digits, show as integer
        return Math.round(num).toString() + suffix;
      }
      
      // If integer part is 1 digit (1-9), can add up to 2 decimal places to make 3 digits total
      if (intDigits === 1) {
        const with2Dec = num.toFixed(2);
        const digitsCount = with2Dec.replace('.', '').length;
        if (digitsCount <= 3) {
          return with2Dec.replace(/\.0+$/, '') + suffix;
        }
        // Try 1 decimal place
        const with1Dec = num.toFixed(1);
        const digitsCount1 = with1Dec.replace('.', '').length;
        if (digitsCount1 <= 3) {
          return with1Dec.replace(/\.0+$/, '') + suffix;
        }
        // Fallback to integer
        return Math.round(num).toString() + suffix;
      }
      
      // For numbers < 1 (intDigits === 0), show up to 3 significant digits
      // This is rare for power gains, but handle it
      const with3Dec = num.toFixed(3);
      const digitsCount = with3Dec.replace('.', '').replace(/^0+/, '').length;
      if (digitsCount <= 3) {
        return with3Dec.replace(/\.?0+$/, '').replace(/^0\./, '0.') + suffix;
      }
      return num.toFixed(2).replace(/\.?0+$/, '') + suffix;
    };
    
    // Handle very large numbers (same structure as formatNumber)
    if (value >= 1e36) {
      const num = value / 1e36;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'UDe');
      return formatWithMax3Digits(num, 'UDe');
    }
    if (value >= 1e33) {
      const num = value / 1e33;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'UDe');
      return formatWithMax3Digits(num, 'De');
    }
    if (value >= 1e30) {
      const num = value / 1e30;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'De');
      return formatWithMax3Digits(num, 'No');
    }
    if (value >= 1e27) {
      const num = value / 1e27;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'No');
      return formatWithMax3Digits(num, 'Oc');
    }
    if (value >= 1e26) {
      const num = value / 1e26;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'Oc');
      return formatWithMax3Digits(num, 'Oc');
    }
    if (value >= 1e24) {
      const num = value / 1e24;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'Oc');
      return formatWithMax3Digits(num, 'Sp');
    }
    if (value >= 1e21) {
      const num = value / 1e21;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'Sp');
      return formatWithMax3Digits(num, 'Sx');
    }
    if (value >= 1e18) {
      const num = value / 1e18;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'Sx');
      return formatWithMax3Digits(num, 'Qn');
    }
    if (value >= 1e15) {
      const num = value / 1e15;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'Qn');
      return formatWithMax3Digits(num, 'Q');
    }
    if (value >= 1e12) {
      const num = value / 1e12;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'Q');
      return formatWithMax3Digits(num, 'T');
    }
    if (value >= 1e9) {
      const num = value / 1e9;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'T');
      return formatWithMax3Digits(num, 'B');
    }
    if (value >= 1e6) {
      const num = value / 1e6;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'B');
      return formatWithMax3Digits(num, 'M');
    }
    if (value >= 1e3) {
      const num = value / 1e3;
      if (num >= 1000) return formatWithMax3Digits(num / 1000, 'M');
      return formatWithMax3Digits(num, 'K');
    }
    // Less than 1000 - show as integer (max 3 digits naturally)
    return Math.round(value).toString();
  }

  // Global number formatting function - limits to 1-2 decimal places max with letter abbreviations
  function formatNumber(value) {
    if (value < 0) return '-' + formatNumber(-value);
    if (value === 0) return '0';
    
    // Helper to format with 1-2 decimal places and remove trailing zeros
    const formatWithSuffix = (num, suffix) => {
      // Try 1 decimal place first
      const with1Dec = num.toFixed(1);
      if (with1Dec.endsWith('.0')) {
        // If it ends in .0, show as integer
        return Math.round(num).toString() + suffix;
      }
      // Try 2 decimal places if needed
      const with2Dec = num.toFixed(2);
      if (with2Dec.endsWith('.00')) {
        // If it ends in .00, show as integer
        return Math.round(num).toString() + suffix;
      }
      // Remove trailing zeros (e.g., 1.50 -> 1.5, 2.30 -> 2.3)
      return with2Dec.replace(/\.?0+$/, '') + suffix;
    };
    
    // Handle very large numbers
    if (value >= 1e36) {
      const num = value / 1e36;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'UDe');
      return formatWithSuffix(num, 'UDe');
    }
    if (value >= 1e33) {
      const num = value / 1e33;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'UDe');
      return formatWithSuffix(num, 'De');
    }
    if (value >= 1e30) {
      const num = value / 1e30;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'De');
      return formatWithSuffix(num, 'No');
    }
    if (value >= 1e27) {
      const num = value / 1e27;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'No');
      return formatWithSuffix(num, 'Oc');
    }
    if (value >= 1e26) {
      const num = value / 1e26;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'Oc');
      return formatWithSuffix(num, 'Oc');
    }
    if (value >= 1e24) {
      const num = value / 1e24;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'Oc');
      return formatWithSuffix(num, 'Sp');
    }
    if (value >= 1e21) {
      const num = value / 1e21;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'Sp');
      return formatWithSuffix(num, 'Sx');
    }
    if (value >= 1e18) {
      const num = value / 1e18;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'Sx');
      return formatWithSuffix(num, 'Qn');
    }
    if (value >= 1e15) {
      const num = value / 1e15;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'Qn');
      return formatWithSuffix(num, 'Q');
    }
    if (value >= 1e12) {
      const num = value / 1e12;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'Q');
      return formatWithSuffix(num, 'T');
    }
    if (value >= 1e9) {
      const num = value / 1e9;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'T');
      return formatWithSuffix(num, 'B');
    }
    if (value >= 1e6) {
      const num = value / 1e6;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'B');
      return formatWithSuffix(num, 'M');
    }
    if (value >= 1e3) {
      const num = value / 1e3;
      if (num >= 1000) return formatWithSuffix(num / 1000, 'M');
      return formatWithSuffix(num, 'K');
    }
    // Less than 1000 - show as integer
    return Math.round(value).toString();
  }

  window.addEventListener('DOMContentLoaded', () => {
    console.log('[UI] DOMContentLoaded, setting up UI');
    setupMobileButtons();
    setupRightClickCamera();
    setupPowerHud();
    setupMerchantUI();
    setupMineResetUpgradeUI();
    setupGemTraderUI();
    setupEggStationUI();
    setupKeyboardDebug();
    console.log('[UI] UI setup complete');
  });

  // Also try setting up immediately if DOM is already loaded
  if (document.readyState === 'loading') {
    console.log('[UI] DOM is still loading, waiting for DOMContentLoaded');
  } else {
    console.log('[UI] DOM already loaded, setting up UI immediately');
    setupMobileButtons();
    setupRightClickCamera();
    setupPowerHud();
    setupMerchantUI();
    setupMineResetUpgradeUI();
    setupGemTraderUI();
    setupEggStationUI();
    setupKeyboardDebug();
  }

  /**
   * Debug keyboard input to see what's blocking movement
   */
  function setupKeyboardDebug() {
    // Log all keydown events
    window.addEventListener('keydown', (e) => {
      const wasdKeys = ['KeyW', 'KeyA', 'KeyS', 'KeyD'];
      if (wasdKeys.includes(e.code)) {
        console.log('[DEBUG] Keydown:', e.code, {
          defaultPrevented: e.defaultPrevented,
          target: e.target?.tagName,
          targetId: e.target?.id,
          targetClass: e.target?.className,
          isTrusted: e.isTrusted
        });
      }
    }, true); // Use capture phase to catch early

    // Log all keyup events
    window.addEventListener('keyup', (e) => {
      const wasdKeys = ['KeyW', 'KeyA', 'KeyS', 'KeyD'];
      if (wasdKeys.includes(e.code)) {
        console.log('[DEBUG] Keyup:', e.code, {
          defaultPrevented: e.defaultPrevented,
          target: e.target?.tagName
        });
      }
    }, true);

    // Check if hytopia is available and can receive input
    if (typeof hytopia !== 'undefined') {
      console.log('[DEBUG] Hytopia available:', {
        hasPressInput: typeof hytopia.pressInput === 'function',
        hasLockPointer: typeof hytopia.lockPointer === 'function'
      });
    } else {
      console.warn('[DEBUG] Hytopia not available yet');
    }

    // Check document focus
    console.log('[DEBUG] Document focus:', {
      activeElement: document.activeElement?.tagName,
      activeElementId: document.activeElement?.id,
      hasFocus: document.hasFocus()
    });

    // Monitor focus changes
    window.addEventListener('focus', () => {
      console.log('[DEBUG] Window gained focus');
      // Ensure document can receive keyboard input
      if (document.activeElement && document.activeElement.tagName === 'BODY') {
        document.body.focus();
      }
    });
    window.addEventListener('blur', () => {
      console.log('[DEBUG] Window lost focus');
    });

    // Ensure body can receive focus for keyboard events
    document.body.setAttribute('tabindex', '-1');
    
    // Click on body to ensure focus
    document.addEventListener('click', (e) => {
      // If clicking on UI root (which has pointer-events: none), focus body
      if (e.target && e.target.closest && e.target.closest('.ui-root')) {
        // Don't interfere with UI clicks
        return;
      }
      // Focus body to ensure keyboard events work
      if (document.activeElement && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
        document.body.focus();
      }
    }, true);
  }

  function setupMobileButtons() {
    const mobileInteractButton = document.getElementById('mobile-interact-button');
    const mobileJumpButton = document.getElementById('mobile-jump-button');

    if (mobileInteractButton) {
      mobileInteractButton.addEventListener('touchstart', e => {
        e.preventDefault();
        mobileInteractButton.classList.add('active');
        hytopia.pressInput('ml', true);
      });

      mobileInteractButton.addEventListener('touchend', e => {
        e.preventDefault();
        mobileInteractButton.classList.remove('active');
        hytopia.pressInput('ml', false);
      });
    }

    if (mobileJumpButton) {
      mobileJumpButton.addEventListener('touchstart', e => {
        e.preventDefault();
        mobileJumpButton.classList.add('active');
        hytopia.pressInput(' ', true);
      });

      mobileJumpButton.addEventListener('touchend', e => {
        e.preventDefault();
        mobileJumpButton.classList.remove('active');
        hytopia.pressInput(' ', false);
      });
    }
  }

  /**
   * Roblox-style camera: mouse stays free; hold right click to look around.
   * Uses lockPointer(lock, maintainInput=true) so movement keys keep working
   * even when the pointer is unlocked for UI interaction.
   */
  function setupRightClickCamera() {
    let rightMouseHeld = false;

    const lockPointerSafe = (lock) => {
      if (typeof hytopia === 'undefined' || typeof hytopia.lockPointer !== 'function') return;
      try {
        hytopia.lockPointer(lock, true);
        console.log('[DEBUG] Pointer lock set to:', lock);
      } catch (err) {
        console.warn('[UI] lockPointer failed', err);
      }
    };

    // Try locking pointer initially - Hytopia may require this for keyboard input
    // The maintainInput=true parameter should allow movement even when locked
    console.log('[DEBUG] Attempting initial pointer lock for keyboard input');
    lockPointerSafe(true);
    
    // If that doesn't work, unlock after a short delay to allow UI interaction
    setTimeout(() => {
      console.log('[DEBUG] Unlocking pointer after initial lock attempt');
      lockPointerSafe(false);
    }, 100);

    // Prevent context menu so RMB can be used for camera look
    window.addEventListener('contextmenu', e => {
      e.preventDefault();
    });

    // Prevent mouse wheel from zooming the camera, but allow wheel in scrollable UI.
    const getScrollableAncestor = (el) => {
      let node = el;
      while (node && node !== document.body) {
        if (node instanceof HTMLElement) {
          const style = window.getComputedStyle(node);
          const canScrollY = (style.overflowY === 'auto' || style.overflowY === 'scroll');
          const canScrollX = (style.overflowX === 'auto' || style.overflowX === 'scroll');
          const hasScrollY = node.scrollHeight > node.clientHeight;
          const hasScrollX = node.scrollWidth > node.clientWidth;
          if ((canScrollY && hasScrollY) || (canScrollX && hasScrollX)) {
            return node;
          }
        }
        node = node.parentElement;
      }
      return null;
    };

    window.addEventListener('wheel', e => {
      const target = e.target;
      const scrollable = target instanceof HTMLElement ? getScrollableAncestor(target) : null;
      const isFormElement = target && (target.tagName === 'TEXTAREA' || target.tagName === 'INPUT');

      if (!scrollable && !isFormElement) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        return false;
      }
    }, { passive: false, capture: true });

    window.addEventListener('mousedown', e => {
      if (e.button !== 2) return;
      e.preventDefault();
      rightMouseHeld = true;
      lockPointerSafe(true);
    });

    window.addEventListener('mouseup', e => {
      if (e.button !== 2) return;
      rightMouseHeld = false;
      lockPointerSafe(false);
    });

    // Safety: release pointer if focus is lost
    window.addEventListener('blur', () => {
      if (!rightMouseHeld) return;
      rightMouseHeld = false;
      lockPointerSafe(false);
    });
  }


  /**
   * Setup Merchant UI
   * Handles merchant selling interface
   */
  function setupMerchantUI() {
    const merchantUI = document.getElementById('merchant-ui');
    const merchantUIClose = document.getElementById('merchant-ui-close');
    const merchantUISellAll = document.getElementById('merchant-ui-sell-all');

    if (!merchantUI || !merchantUIClose || !merchantUISellAll) {
      console.warn('[UI] Merchant UI elements not found');
      return;
    }

    // Close button handler
    merchantUIClose.addEventListener('click', () => {
      console.log('[UI] Merchant UI close clicked');
      merchantUI.classList.remove('visible');
      hytopia.sendData({ type: 'CLOSE_MERCHANT_UI' });
      setTimeout(() => {
        if (window.isAnyModalOpen && !window.isAnyModalOpen()) {
          if (window.setModalOpen) window.setModalOpen(false);
        }
      }, 10);
    });

    // Sell All button handler
    merchantUISellAll.addEventListener('click', () => {
      console.log('[UI] Sell All clicked');
      hytopia.sendData({ type: 'SELL_ALL' });
    });
  }

  /**
   * Setup Mine Reset Upgrade UI
   * Handles mine reset upgrade interface
   */
  function setupMineResetUpgradeUI() {
    const upgradeUI = document.getElementById('mine-reset-upgrade-ui');
    const upgradeUIClose = document.getElementById('mine-reset-upgrade-ui-close');
    const upgradeButton = document.getElementById('mine-reset-upgrade-button');

    if (!upgradeUI || !upgradeUIClose || !upgradeButton) {
      console.warn('[UI] Mine Reset Upgrade UI elements not found');
      return;
    }

    // Close button handler
    upgradeUIClose.addEventListener('click', () => {
      console.log('[UI] Mine Reset Upgrade UI close clicked');
      upgradeUI.classList.remove('visible');
      hytopia.sendData({ type: 'CLOSE_MINE_RESET_UPGRADE_UI' });
      setTimeout(() => {
        if (window.isAnyModalOpen && !window.isAnyModalOpen()) {
          if (window.setModalOpen) window.setModalOpen(false);
        }
      }, 10);
    });

    // Purchase button handler - only process if not bought/disabled
    upgradeButton.addEventListener('click', (e) => {
      // Prevent click if button is disabled or bought
      if (upgradeButton.disabled || upgradeButton.classList.contains('bought')) {
        e.preventDefault();
        e.stopPropagation();
        return;
      }
      console.log('[UI] Mine Reset Upgrade button clicked');
      hytopia.sendData({ type: 'PURCHASE_MINE_RESET_UPGRADE' });
    });

    // Hover effect for button - only if not bought/disabled
    upgradeButton.addEventListener('mouseenter', () => {
      if (!upgradeButton.disabled && !upgradeButton.classList.contains('bought')) {
        console.log('[UI] Hovering over 2M button - button should increase in size');
        upgradeButton.style.transform = 'scale(1.05)';
      }
    });

    upgradeButton.addEventListener('mouseleave', () => {
      upgradeButton.style.transform = 'scale(1)';
    });
  }

  /**
   * Update Mine Reset Upgrade UI with player data
   */
  function updateMineResetUpgradeUI(hasUpgrade, cost, gold) {
    const upgradeUI = document.getElementById('mine-reset-upgrade-ui');
    const upgradeButton = document.getElementById('mine-reset-upgrade-button');
    const upgradeStatus = document.getElementById('mine-reset-upgrade-status');
    const buttonText = upgradeButton?.querySelector('.mine-reset-upgrade-ui__button-text');

    if (!upgradeUI || !upgradeButton || !upgradeStatus || !buttonText) return;

    if (hasUpgrade) {
      buttonText.textContent = 'Bought!';
      upgradeButton.disabled = true;
      upgradeButton.classList.add('bought');
      upgradeButton.classList.add('disabled'); // Also add disabled class for styling
      upgradeButton.style.pointerEvents = 'none'; // Prevent any interaction
      upgradeButton.style.cursor = 'default';
      upgradeStatus.textContent = 'You have already purchased this upgrade!';
      upgradeStatus.className = 'mine-reset-upgrade-ui__status mine-reset-upgrade-ui__status--bought';
    } else {
      buttonText.textContent = formatNumber(cost);
      upgradeButton.disabled = false;
      upgradeButton.classList.remove('bought');
      upgradeButton.style.pointerEvents = 'auto'; // Re-enable interaction
      upgradeButton.style.cursor = 'pointer';
      const canAfford = gold >= cost;
      if (canAfford) {
        upgradeButton.classList.remove('disabled');
        upgradeStatus.textContent = `You have ${formatNumber(gold)} gold`;
        upgradeStatus.className = 'mine-reset-upgrade-ui__status mine-reset-upgrade-ui__status--can-afford';
      } else {
        upgradeButton.classList.add('disabled');
        upgradeStatus.textContent = `You need ${formatNumber(cost - gold)} more gold`;
        upgradeStatus.className = 'mine-reset-upgrade-ui__status mine-reset-upgrade-ui__status--cannot-afford';
      }
    }
  }

  /**
   * Setup Gem Trader UI
   * Handles gem trader upgrades interface
   */
  function setupGemTraderUI() {
    const gemTraderUI = document.getElementById('gem-trader-ui');
    const gemTraderUIClose = document.getElementById('gem-trader-ui-close');

    if (!gemTraderUI || !gemTraderUIClose) {
      console.warn('[UI] Gem Trader UI elements not found');
      return;
    }

    // Close button handler
    gemTraderUIClose.addEventListener('click', () => {
      console.log('[UI] Gem Trader UI close clicked');
      gemTraderUI.classList.remove('visible');
      setTimeout(() => {
        if (window.isAnyModalOpen && !window.isAnyModalOpen()) {
          if (window.setModalOpen) window.setModalOpen(false);
        }
      }, 10);
    });
  }

  /**
   * Setup Egg Station UI
   * Handles egg station/hatching interface
   */
  function setupEggStationUI() {
    const eggModal = document.getElementById('egg-modal');
    const eggModalClose = eggModal?.querySelector('[data-close="egg-modal"]');

    if (!eggModal) {
      console.warn('[UI] Egg Station UI elements not found');
      return;
    }

    // Close button handler
    if (eggModalClose) {
      eggModalClose.addEventListener('click', () => {
        console.log('[UI] Egg Station UI close clicked');
        eggModal.classList.remove('visible');
        hytopia.sendData({ type: 'CLOSE_EGG_MODAL' });
        setTimeout(() => {
          if (window.isAnyModalOpen && !window.isAnyModalOpen()) {
            if (window.setModalOpen) window.setModalOpen(false);
          }
        }, 10);
      });
    }

    // Open 1 egg button
    const open1Btn = document.getElementById('egg-open-1');
    if (open1Btn) {
      open1Btn.addEventListener('click', () => {
        console.log('[UI] Open 1 egg clicked');
        hytopia.sendData({ type: 'OPEN_EGG', count: 1 });
      });
    }

    // Open 3 eggs button
    const open3Btn = document.getElementById('egg-open-3');
    if (open3Btn) {
      open3Btn.addEventListener('click', () => {
        console.log('[UI] Open 3 eggs clicked');
        hytopia.sendData({ type: 'OPEN_EGG', count: 3 });
      });
    }

    // Auto open button
    const autoBtn = document.getElementById('egg-auto');
    if (autoBtn) {
      autoBtn.addEventListener('click', () => {
        console.log('[UI] Auto open eggs clicked');
        hytopia.sendData({ type: 'TOGGLE_AUTO_HATCH' });
      });
    }
  }

  /**
   * Update Gem Trader UI with upgrade data
   */
  function updateGemTraderUI(upgrades, gems) {
    const gemTraderUIContent = document.getElementById('gem-trader-ui-content');
    if (!gemTraderUIContent) return;

    // Clear existing items
    gemTraderUIContent.innerHTML = '';

    // Upgrade definitions
    const upgradeDefs = [
      {
        key: 'moreGems',
        title: 'More Gems',
        icon: 'ðŸ’Ž',
        getEffect: (level) => {
          // UI shows level, backend is level + 1 (always 1 ahead)
          const displayLevel = level;
          const nextDisplayLevel = level + 1;
          return `${displayLevel}x -> ${nextDisplayLevel}x`;
        },
        getLevelProgress: (level) => {
          // TODO: Get max level from somewhere when defined
          const maxLevel = 50;
          return `${level}/${maxLevel}`;
        },
      },
      {
        key: 'moreRebirths',
        title: 'More Rebirths',
        icon: 'ðŸ”„',
        getEffect: (level) => {
          return `${level} -> ${level + 1}`;
        },
        getLevelProgress: (level) => {
          const maxLevel = 35;
          return `${level}/${maxLevel}`;
        },
      },
      {
        key: 'moreCoins',
        title: 'More Coins',
        icon: 'ðŸ’°',
        getEffect: (level) => {
          // Display shows bonus percentage: level 0 = 0%, level 1 = 10%, etc.
          // Backend multiplier is 1.0 + (level * 0.1), so level 1 = 1.1x (110% total)
          const currentPercent = level * 10;
          const nextPercent = (level + 1) * 10;
          return `${currentPercent}% -> ${nextPercent}%`;
        },
        getLevelProgress: (level) => {
          const maxLevel = 160; // 0-159 = 160 total levels
          return `${level}/${maxLevel}`;
        },
      },
      {
        key: 'moreDamage',
        title: 'More Damage',
        icon: 'â›ï¸',
        getEffect: (level) => {
          // Display shows bonus percentage: level 0 = 0%, level 1 = 10%, etc.
          // Backend multiplier is 1.0 + (level * 0.1), so level 1 = 1.1x (110% total)
          const currentPercent = level * 10;
          const nextPercent = (level + 1) * 10;
          return `${currentPercent}% -> ${nextPercent}%`;
        },
        getLevelProgress: (level) => {
          const maxLevel = 50; // 0-49 = 50 total levels
          return `${level}/${maxLevel}`;
        },
      },
    ];

    for (const upgradeDef of upgradeDefs) {
      const upgradeData = upgrades[upgradeDef.key];
      if (!upgradeData) continue;

      const level = upgradeData.level || 0;
      const cost = upgradeData.cost || 0;
      const canAfford = upgradeData.canAfford || false;

      // Create upgrade item container
      const item = document.createElement('div');
      item.className = 'gem-trader-ui__upgrade-item';

      // Icon with arrow overlay
      const iconContainer = document.createElement('div');
      iconContainer.className = 'gem-trader-ui__icon-container';
      const icon = document.createElement('div');
      icon.className = 'gem-trader-ui__icon';
      icon.textContent = upgradeDef.icon;
      const arrowOverlay = document.createElement('div');
      arrowOverlay.className = 'gem-trader-ui__arrow-overlay';
      arrowOverlay.textContent = 'â†‘';
      iconContainer.appendChild(icon);
      iconContainer.appendChild(arrowOverlay);
      item.appendChild(iconContainer);

      // Upgrade details (title, effect, level, cost)
      const details = document.createElement('div');
      details.className = 'gem-trader-ui__details';

      // Title
      const title = document.createElement('div');
      title.className = 'gem-trader-ui__upgrade-title';
      title.textContent = upgradeDef.title;
      details.appendChild(title);

      // Effect (current -> next)
      const effect = document.createElement('div');
      effect.className = 'gem-trader-ui__effect';
      effect.textContent = upgradeDef.getEffect(level);
      details.appendChild(effect);

      // Level progress and cost container
      const levelCostContainer = document.createElement('div');
      levelCostContainer.className = 'gem-trader-ui__level-cost-container';

      // Level progress
      const levelProgress = document.createElement('div');
      levelProgress.className = 'gem-trader-ui__level-progress';
      const levelArrow = document.createElement('span');
      levelArrow.className = 'gem-trader-ui__level-arrow';
      levelArrow.textContent = 'â†‘';
      levelProgress.appendChild(levelArrow);
      const levelText = document.createElement('span');
      levelText.textContent = upgradeDef.getLevelProgress(level);
      levelProgress.appendChild(levelText);
      levelCostContainer.appendChild(levelProgress);

      // Cost
      const costContainer = document.createElement('div');
      costContainer.className = 'gem-trader-ui__cost';
      const gemIcon = document.createElement('span');
      gemIcon.className = 'gem-trader-ui__gem-icon';
      gemIcon.textContent = 'ðŸ’Ž';
      costContainer.appendChild(gemIcon);
      const costText = document.createElement('span');
      costText.textContent = formatNumber(cost);
      costContainer.appendChild(costText);
      levelCostContainer.appendChild(costContainer);

      details.appendChild(levelCostContainer);
      item.appendChild(details);

      // Upgrade button
      const upgradeButton = document.createElement('button');
      upgradeButton.className = `gem-trader-ui__upgrade-button ${canAfford ? 'can-afford' : 'cannot-afford'}`;
      upgradeButton.textContent = '+';
      upgradeButton.disabled = !canAfford;
      upgradeButton.addEventListener('click', () => {
        console.log(`[UI] Upgrade ${upgradeDef.key} clicked`);
        hytopia.sendData({ type: 'PURCHASE_UPGRADE', upgradeType: upgradeDef.key });
      });
      item.appendChild(upgradeButton);

      gemTraderUIContent.appendChild(item);
    }
  }

  /**
   * Update Merchant UI with inventory data
   */
  function updateMerchantUI(inventory, totalValue, gold, oreSellValues) {
    const merchantUIContent = document.getElementById('merchant-ui-content');
    if (!merchantUIContent) return;

    // Clear existing items
    merchantUIContent.innerHTML = '';

    // Get ore data for values (matching ORE_DATABASE from OreData.ts and ISLAND2_ORE_DATABASE from Ores.ts)
    // Colors are hex values from the ore data files
    const oreData = {
      // Island 1 ores
      'stone': { name: 'Stone', value: 2, color: '#808080' },
      'deepslate': { name: 'Deepslate', value: 5, color: '#2F2F2F' },
      'coal': { name: 'Coal', value: 6, color: '#1A1A1A' },
      'iron': { name: 'Iron', value: 10, color: '#C0C0C0' },
      'tin': { name: 'Tin', value: 15, color: '#D3D3D3' },
      'cobalt': { name: 'Cobalt', value: 50, color: '#0047AB' },
      'pyrite': { name: 'Pyrite', value: 100, color: '#FFD700' },
      'gold': { name: 'Gold', value: 250, color: '#FFD700' },
      'obsidian': { name: 'Obsidian', value: 500, color: '#000000' },
      'ruby': { name: 'Ruby', value: 1000, color: '#E0115F' },
      'diamond': { name: 'Diamond', value: 2000, color: '#B9F2FF' },
      'amber': { name: 'Amber', value: 3500, color: '#FFBF00' },
      'quartz': { name: 'Quartz', value: 5000, color: '#F5F5DC' },
      'topaz': { name: 'Topaz', value: 10000, color: '#FFC87C' },
      'emerald': { name: 'Emerald', value: 20000, color: '#50C878' },
      'relic': { name: 'Relic', value: 50000, color: '#8B7355' },
      'amethyst': { name: 'Amethyst', value: 75000, color: '#9966CC' },
      'sapphire': { name: 'Sapphire', value: 150000, color: '#0F52BA' },
      'luminite': { name: 'Luminite', value: 250000, color: '#00FF00' },
      'prismatic': { name: 'Prismatic', value: 350000, color: '#E0E0E0' },
      'sunstone': { name: 'Sunstone', value: 450000, color: '#FFA500' },
      'mithrial': { name: 'Mithrial', value: 600000, color: '#C0C0C0' },
      'astralite': { name: 'Astralite', value: 800000, color: '#708090' },
      'dragonstone': { name: 'Dragonstone', value: 1500000, color: '#8B0000' },
      // Island 2 ores
      'dunestone': { name: 'Dunestone', value: 1000, color: '#8B7D6B' },
      'driftite': { name: 'Driftite', value: 15000, color: '#A8A8A8' },
      'anchorite': { name: 'Anchorite', value: 30000, color: '#4A4A4A' },
      'barnacite': { name: 'Barnacite', value: 35000, color: '#6B4423' },
      'seaglassium': { name: 'Seaglassium', value: 100000, color: '#87CEEB' },
      'shellchromite': { name: 'Shellchromite', value: 250000, color: '#F5DEB3' },
      'turtlite': { name: 'Turtlite', value: 650000, color: '#228B22' },
      'prismarine': { name: 'Prismarine', value: 2500000, color: '#00CED1' },
      'opalstone': { name: 'Opalstone', value: 4000000, color: '#E6E6FA' },
      'azurite': { name: 'Azurite', value: 7500000, color: '#007FFF' },
      'mangrovite': { name: 'Mangrovite', value: 19000000, color: '#8B4513' },
      'basaltite': { name: 'Basaltite', value: 15000000, color: '#2F2F2F' },
      'reefium': { name: 'Reefium', value: 25000000, color: '#FF6347' },
      'kelpite': { name: 'Kelpite', value: 27500000, color: '#2E8B57' },
      'sunstonite': { name: 'Sunstonite', value: 40000000, color: '#FFD700' },
      'riptidite': { name: 'Riptidite', value: 75000000, color: '#4682B4' },
      'trenchite': { name: 'Trenchite', value: 100000000, color: '#191970' },
      'stormium': { name: 'Stormium', value: 150000000, color: '#708090' },
      'lavastone': { name: 'Lavastone', value: 200000000, color: '#FF4500' },
      'wreckite': { name: 'Wreckite', value: 250000000, color: '#8B4513' },
      'biolumite': { name: 'Biolumite', value: 300000000, color: '#00FF00' },
      'oceanium': { name: 'Oceanium', value: 400000000, color: '#0000CD' },
      'palmitite': { name: 'Palmitite', value: 400000000, color: '#FFE4B5' },
      'tradewindite': { name: 'Tradewindite', value: 1750000000, color: '#87CEFA' },
    };

    // Create ore items
    const oreTypes = Object.keys(inventory).filter(oreType => inventory[oreType] > 0);
    
    // Debug: Log inventory and oreData keys
    console.log('[MerchantUI] Inventory keys:', oreTypes);
    console.log('[MerchantUI] OreData keys count:', Object.keys(oreData).length);
    
    if (oreTypes.length === 0) {
      const emptyMessage = document.createElement('div');
      emptyMessage.style.padding = '20px';
      emptyMessage.style.textAlign = 'center';
      emptyMessage.style.color = '#aaa';
      emptyMessage.textContent = 'No ores in inventory';
      merchantUIContent.appendChild(emptyMessage);
      return;
    }

    // Sort ores by value (highest first)
    oreTypes.sort((a, b) => {
      const valueA = oreData[a]?.value || 0;
      const valueB = oreData[b]?.value || 0;
      return valueB - valueA;
    });

    for (const oreType of oreTypes) {
      const amount = inventory[oreType];
      const data = oreData[oreType];
      
      // Debug: Log missing ores
      if (!data) {
        console.warn(`[MerchantUI] No data found for ore type: ${oreType}`);
        continue;
      }
      
      if (amount <= 0) continue;

      const item = document.createElement('div');
      item.className = 'merchant-ui__ore-item';

      // Ore info (left side)
      const oreInfo = document.createElement('div');
      oreInfo.className = 'merchant-ui__ore-info';

      const oreName = document.createElement('div');
      oreName.className = 'merchant-ui__ore-name';
      oreName.style.color = data.color; // Use actual hex color from ore data
      oreName.textContent = `${data.name} (x${amount})`;
      oreInfo.appendChild(oreName);

      item.appendChild(oreInfo);

      // Value (middle)
      const oreValue = document.createElement('div');
      oreValue.className = 'merchant-ui__ore-value';
      const coinIcon = document.createElement('span');
      coinIcon.className = 'merchant-ui__coin-icon';
      oreValue.appendChild(coinIcon);
      const valueText = document.createElement('span');
      // Use oreSellValues if provided (includes all multipliers), otherwise use base value
      const sellPrice = oreSellValues && oreSellValues[oreType] !== undefined 
        ? oreSellValues[oreType] 
        : data.value;
      valueText.textContent = formatNumber(sellPrice);
      oreValue.appendChild(valueText);
      item.appendChild(oreValue);

      // Sell button (right side)
      const sellButton = document.createElement('button');
      sellButton.className = 'merchant-ui__sell-button';
      sellButton.textContent = 'Sell';
      sellButton.addEventListener('click', () => {
        console.log(`[UI] Sell ${oreType} clicked`);
        hytopia.sendData({ type: 'SELL_ORE', oreType });
      });
      item.appendChild(sellButton);

      merchantUIContent.appendChild(item);
    }
  }

  function setupPowerHud() {
    const powerValueEl = document.getElementById('power-value');
    const moneyValueEl = document.getElementById('money-value');
    const gemsValueEl = document.getElementById('gems-value');
    const winsValueEl = document.getElementById('wins-value');
    const rebirthsValueEl = document.getElementById('rebirths-value');
    const powerGainLayer = document.getElementById('power-gain-layer');
    const trainingPromptEl = document.getElementById('training-prompt');
    const trainingPromptTitleEl = document.getElementById('training-prompt-title');
    const trainingPromptSubtitleEl = document.getElementById('training-prompt-subtitle');
    const trainingPromptKeyEl = document.getElementById('training-prompt-key');

    // Mining UI elements
    const miningHudEl = document.getElementById('mining-hud');
    const damageDisplayEl = document.getElementById('damage-display');
    const minedOreLayerEl = document.getElementById('mined-ore-layer');
    const damagePopupLayerEl = document.getElementById('damage-popup-layer');
    const blockHealthBarEl = document.getElementById('block-health-bar');
    const blockHealthBarNameEl = document.getElementById('block-health-bar-name');
    const blockHealthBarFillEl = document.getElementById('block-health-bar-fill');
    const blockHealthBarTextEl = document.getElementById('block-health-bar-text');
    const blockRewardDisplayEl = document.getElementById('block-reward-display');
    const mineResetTimerEl = document.getElementById('mine-reset-timer');
    const mineResetTimerTextEl = document.getElementById('mine-reset-timer-text');
    const miningDepthCounterEl = document.getElementById('mining-depth-counter');
    const miningDepthCounterTextEl = document.getElementById('mining-depth-counter-text');

    console.log('[UI] Setting up power HUD');
    console.log('[UI] powerValueEl:', powerValueEl);
    console.log('[UI] powerGainLayer:', powerGainLayer);

    const minerButton = document.getElementById('miner-button');
    const pickaxeButton = document.getElementById('pickaxe-button');
    const rebirthButton = document.getElementById('rebirth-button');
    const petsButton = document.getElementById('pets-button');
    const mapsButton = document.getElementById('maps-button');
    const minerModal = document.getElementById('miner-modal');
    const pickaxeModal = document.getElementById('pickaxe-modal');
    const rebirthModal = document.getElementById('rebirth-modal');
    const petsModal = document.getElementById('pets-modal');
    const mapsModal = document.getElementById('maps-modal');
    const eggModal = document.getElementById('egg-modal');

    // Array of all modals for closing others when opening one
    const allModals = [minerModal, pickaxeModal, rebirthModal, petsModal, mapsModal, eggModal].filter(Boolean);

    const minerGridEl = document.getElementById('miner-grid');
    const mapsListEl = document.getElementById('maps-list');
    const minerDetailName = document.getElementById('miner-detail-name');
    const minerDetailStats = document.getElementById('miner-detail-stats');
    const minerDetailBadge = document.getElementById('miner-detail-badge');
    const minerDetailIcon = document.getElementById('miner-detail-icon');
    const pickaxeGridEl = document.getElementById('pickaxe-grid');
    const pickaxeDetailName = document.getElementById('pickaxe-detail-name');
    const pickaxeDetailIcon = document.getElementById('pickaxe-detail-icon');
    const pickaxeDetailStats = document.getElementById('pickaxe-detail-stats');
    const pickaxeDetailCost = document.getElementById('pickaxe-detail-cost');

    // Pets UI elements (grid)
    const petsGridEl = document.getElementById('pets-grid');
    const petsOwnedCountEl = document.getElementById('pets-owned-count');
    const petsEquippedCountEl = document.getElementById('pets-equipped-count');
    const petsMultiplierSumEl = document.getElementById('pets-multiplier-sum');
    const petsEquipBestBtn = document.getElementById('pets-equip-best');
    const petsUnequipAllBtn = document.getElementById('pets-unequip-all');
    const petsTrashToggleBtn = document.getElementById('pets-trash-toggle');
    const petsDeleteBarEl = document.getElementById('pets-delete-bar');
    const petsDeleteTextEl = document.getElementById('pets-delete-text');
    const petsDeleteConfirmBtn = document.getElementById('pets-delete-confirm');
    const petsDeleteCancelBtn = document.getElementById('pets-delete-cancel');
    const petDetailPanelEl = document.getElementById('pet-detail-panel');
    const petDetailCloseEl = document.getElementById('pet-detail-close');
    const petDetailNameEl = document.getElementById('pet-detail-name');
    const petDetailImageEl = document.getElementById('pet-detail-image');
    const petDetailMultEl = document.getElementById('pet-detail-mult');
    const petDetailRarityEl = document.getElementById('pet-detail-rarity');
    const petDetailActionEl = document.getElementById('pet-detail-action');

    // Egg station UI elements
    const eggModalTitleEl = document.getElementById('egg-modal-title');
    const eggStationNameEl = document.getElementById('egg-station-name');
    const eggStationCostEl = document.getElementById('egg-station-cost');
    const eggStationGoldEl = document.getElementById('egg-station-gold');
    const eggStationInvEl = document.getElementById('egg-station-inv');
    const eggStationStatusEl = document.getElementById('egg-station-status');
    const eggOpen1Btn = document.getElementById('egg-open-1');
    const eggOpen3Btn = document.getElementById('egg-open-3');
    const eggAutoBtn = document.getElementById('egg-auto');
    const eggResultsListEl = document.getElementById('egg-results-list');
    const eggShopGridEl = document.getElementById('egg-shop-grid');
    const eggTabsEl = document.getElementById('egg-tabs');
    const eggStationIconEl = document.getElementById('egg-station-icon');
    const eggHatchOverlayEl = document.getElementById('egg-hatch-overlay');
    const eggHatchSlotsEl = document.getElementById('egg-hatch-slots');

    // Setup miner button click handler
    if (minerButton) {
      minerButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        hytopia.sendData({ type: 'MODAL_OPENED', modalType: 'miner' });
        hytopia.sendData({ type: 'OPEN_MINER_SHOP' });
      });
    }

    // Setup pickaxe button click handler
    if (pickaxeButton) {
      pickaxeButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('[UI] Pickaxe button clicked');
        // Immediately notify server that modal is opening (before sending shop data request)
        // This prevents any click events from triggering mining
        hytopia.sendData({ type: 'MODAL_OPENED', modalType: 'pickaxe' });
        hytopia.sendData({ type: 'OPEN_PICKAXE_SHOP' });
      });
    }

    // Setup rebirth button click handler
    if (rebirthButton) {
      rebirthButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('[UI] Rebirth button clicked');
        // Immediately notify server that modal is opening (before sending rebirth data request)
        // This prevents any click events from triggering mining
        hytopia.sendData({ type: 'MODAL_OPENED', modalType: 'rebirth' });
        hytopia.sendData({ type: 'OPEN_REBIRTH_UI' });
      });
    }

    // Setup pets button click handler (HUD below rebirth)
    if (petsButton) {
      petsButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        // Always start with delete mode OFF when opening the pets UI.
        // This ensures the delete bar stays hidden until the trashcan is clicked.
        state.pets.deleteMode = false;
        state.pets.deleteSelected = {};
        state.pets.selectedPetInstanceId = null;
        if (petsDeleteBarEl) petsDeleteBarEl.hidden = true;
        if (petDetailPanelEl) petDetailPanelEl.hidden = true;

        hytopia.sendData({ type: 'MODAL_OPENED', modalType: 'pets' });
        hytopia.sendData({ type: 'REQUEST_PET_STATE' });
        showModal(petsModal);
        petsButton.blur();
        window.focus();
      });
    }

    // Setup maps button click handler (HUD below pets)
    if (mapsButton) {
      mapsButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        hytopia.sendData({ type: 'MODAL_OPENED', modalType: 'maps' });
        hytopia.sendData({ type: 'OPEN_WORLDS_PANEL' });
        showModal(mapsModal);
        mapsButton.blur();
        window.focus();
      });
    }

    // Setup modal close handlers
    document.addEventListener('click', (e) => {
      // Use closest to find the close button (handles clicks on text/children inside button)
      const closeButton = e.target.closest('.pickaxe-modal__close, .modal__close, .rebirth-modal__close, .maps-modal__close');
      
      if (closeButton) {
        const modalId = closeButton.getAttribute('data-close');
        if (modalId) {
          const modal = document.getElementById(modalId);
          if (modal) {
            e.preventDefault();
            e.stopPropagation();
            hideModal(modal); // Use hideModal to notify server
            console.log(`[UI] Closed modal: ${modalId}`);
          }
        }
      }
    });
    const rebirthOptionsEl = document.getElementById('rebirth-options');
    const rebirthBadge = document.getElementById('rebirth-badge');

    const state = {
      power: 0,
      gold: 0,
      gems: 0,
      wins: 0,
      rebirths: 0,
      miner: {
        currentTier: -1,
        selectedTier: -1,
        miners: [],
      },
      pickaxe: {
        currentTier: 0,
        selectedTier: undefined,
        pickaxes: [],
      },
      rebirth: {
        options: [],
        power: 0,
        rebirths: 0,
        maxRebirths: 0,
      },
      prompt: {
        visible: false,
        rockName: 'Training Rock',
        requirements: { power: 0, rebirths: 0 },
        canTrain: false,
        powerPerHit: 0,
        actionKey: 'E',
      },
      mining: {
        isMining: false,
        isInMine: false,
        currentOre: null,
        damage: 0,
        lastBlockInfo: null, // Store last known block info to prevent UI disappearing during fast mining
      },
      pets: {
        pets: [],
        ownedCount: 0,
        ownedCap: 50,
        equippedCount: 0,
        equippedCap: 8,
        multiplierSum: 0,
        trainingMultiplier: 1,
        selectedPetInstanceId: null,
        deleteMode: false,
        deleteSelected: {}, // map instanceId -> true (inventory only)
      },
      eggStation: {
        inProximity: false,
        stationId: null,
        stationName: 'Egg Station',
        eggType: 'stone',
        defaultOpenCount: 1,
        costGold: 0,
        lastHatch: [],
        eggPets: [],
        autoDeletePets: [],
        autoEnabled: false,
        autoArmed: false,
        autoCount: 1,
        stations: [], // All available stations in the current group
      },
    };

    const EGG_HATCH_SHAKE_MS = 2000;
    const EGG_HATCH_TOTAL_MS = 3000;
    const EGG_HATCH_COOLDOWN_MS = 1000;
    let eggHatchInProgress = false;
    let currentEggHatch = null;

    const resetEggHatchOverlay = () => {
      if (currentEggHatch?.cleanupTimer) {
        clearTimeout(currentEggHatch.cleanupTimer);
      }
      currentEggHatch = null;
      eggHatchInProgress = false;
      if (eggHatchOverlayEl) eggHatchOverlayEl.hidden = true;
      if (eggHatchSlotsEl) eggHatchSlotsEl.innerHTML = '';
      if (eggModal && state.eggStation.inProximity) {
        eggModal.classList.remove('hatch-hidden');
      }
    };

    const buildEggHatchSlots = (count) => {
      if (!eggHatchSlotsEl) return [];
      eggHatchSlotsEl.innerHTML = '';
      const slots = [];
      for (let i = 0; i < count; i++) {
        const slot = document.createElement('div');
        slot.className = 'egg-hatch-slot';

        const egg = document.createElement('div');
        egg.className = 'egg-hatch-egg';

        const particles = document.createElement('div');
        particles.className = 'egg-hatch-particles';

        const result = document.createElement('div');
        result.className = 'egg-hatch-result';

        const thumb = document.createElement('div');
        thumb.className = 'egg-hatch-result__thumb';
        thumb.textContent = 'ðŸ¥š';

        const name = document.createElement('div');
        name.className = 'egg-hatch-result__name';
        name.textContent = 'Hatching...';

        result.appendChild(thumb);
        result.appendChild(name);
        slot.appendChild(egg);
        slot.appendChild(particles);
        slot.appendChild(result);
        eggHatchSlotsEl.appendChild(slot);
        slots.push(slot);
      }
      return slots;
    };

    const renderEggHatchResults = (results) => {
      if (!currentEggHatch || !currentEggHatch.slots) return;
      const list = Array.isArray(results) ? results : [];
      currentEggHatch.slots.forEach((slot, index) => {
        const entry = list[index] || null;
        const nameEl = slot.querySelector('.egg-hatch-result__name');
        const thumbEl = slot.querySelector('.egg-hatch-result__thumb');

        if (!nameEl || !thumbEl) return;

        if (!entry) {
          nameEl.textContent = 'Hatching...';
          thumbEl.textContent = 'ðŸ¥š';
          return;
        }

        const entryId = typeof entry === 'string' ? entry : (entry.petId || entry.id || entry.name);
        const petName = (typeof entry === 'string' ? entry : (entry.name || entry.petId || entry.id)) || 'Pet';
        const petImageUri =
          (typeof entry === 'object' && entry.imageUri) ||
          (entryId ? `ui/pets/${entryId}.png` : null);

        nameEl.textContent = petName;
        thumbEl.innerHTML = '';

        if (petImageUri) {
          const img = document.createElement('img');
          img.alt = petName;
          img.src = `{{CDN_ASSETS_URL}}/${petImageUri}`;
          img.onerror = () => {
            thumbEl.textContent = 'ðŸ¾';
          };
          thumbEl.appendChild(img);
        } else {
          thumbEl.textContent = 'ðŸ¾';
        }
      });
    };

    const formatEggChance = (value) => {
      const num = Number(value);
      if (!Number.isFinite(num)) return '0%';
      if (num >= 10) return `${Math.round(num)}%`;
      if (num >= 1) return `${num.toFixed(1).replace(/\.0$/, '')}%`;
      if (num >= 0.1) return `${num.toFixed(2).replace(/\.0+$/, '')}%`;
      return `${num.toFixed(3).replace(/\.0+$/, '')}%`;
    };

    const renderEggShopPets = () => {
      if (!eggShopGridEl) return;
      eggShopGridEl.innerHTML = '';
      const list = Array.isArray(state.eggStation.eggPets) ? state.eggStation.eggPets : [];
      const autoDelete = new Set(Array.isArray(state.eggStation.autoDeletePets) ? state.eggStation.autoDeletePets : []);

      if (!list.length) {
        const empty = document.createElement('div');
        empty.className = 'egg-shop-empty';
        empty.textContent = 'No pets available.';
        eggShopGridEl.appendChild(empty);
        return;
      }

      list.forEach((pet) => {
        const petId = pet?.petId || pet?.id;
        if (!petId) return;

        const card = document.createElement('button');
        card.type = 'button';
        card.className = `egg-shop-card egg-shop-card--${pet?.rarity || 'common'}`;
        card.dataset.petId = petId;

        if (autoDelete.has(petId)) {
          card.classList.add('is-auto-delete');
        }

        const chance = document.createElement('div');
        chance.className = 'egg-shop-card__chance';
        chance.textContent = formatEggChance(pet?.chance ?? 0);

        const autoMark = document.createElement('div');
        autoMark.className = 'egg-shop-card__auto';
        autoMark.textContent = 'X';

        const thumb = document.createElement('div');
        thumb.className = 'egg-shop-card__thumb';
        const img = document.createElement('img');
        img.alt = pet?.name || petId;
        img.src = `{{CDN_ASSETS_URL}}/ui/pets/${petId}.png`;
        img.onerror = () => {
          thumb.textContent = 'pet';
        };
        thumb.appendChild(img);

        const name = document.createElement('div');
        name.className = 'egg-shop-card__name';
        name.textContent = pet?.name || petId;

        card.appendChild(chance);
        card.appendChild(autoMark);
        card.appendChild(thumb);
        card.appendChild(name);
        eggShopGridEl.appendChild(card);
      });
    };

    const maybeFinishEggHatch = () => {
      if (!currentEggHatch || !currentEggHatch.revealed || !currentEggHatch.results) return;
      renderEggHatchResults(currentEggHatch.results);
      if (currentEggHatch.cleanupTimer) return;
      currentEggHatch.cleanupTimer = setTimeout(() => {
        resetEggHatchOverlay();
        if (state.eggStation.autoEnabled && state.eggStation.inProximity) {
          startEggHatchSequence(state.eggStation.autoCount);
        }
      }, EGG_HATCH_COOLDOWN_MS);
    };

    const startEggHatchSequence = (count) => {
      if (!eggHatchOverlayEl || !eggHatchSlotsEl) return;
      if (eggHatchInProgress) return;

      eggHatchInProgress = true;
      if (eggModal) {
        eggModal.classList.add('hatch-hidden');
      }
      eggHatchOverlayEl.hidden = false;

      const slots = buildEggHatchSlots(count);
      currentEggHatch = {
        count,
        slots,
        results: null,
        revealed: false,
        cleanupTimer: null,
      };

      setTimeout(() => {
        if (!currentEggHatch) return;
        slots.forEach((slot) => slot.classList.add('is-cracking'));
        hytopia.sendData({ type: 'EGG_HATCH', eggType: state.eggStation.eggType, count });
      }, EGG_HATCH_SHAKE_MS);

      setTimeout(() => {
        if (!currentEggHatch) return;
        slots.forEach((slot) => slot.classList.add('is-revealed'));
        currentEggHatch.revealed = true;
        renderEggHatchResults(currentEggHatch.results);
        maybeFinishEggHatch();
      }, EGG_HATCH_TOTAL_MS);
    };

    // Egg station local auto-open loop (client-side)
    const stopEggAuto = () => {
      state.eggStation.autoEnabled = false;
      state.eggStation.autoArmed = false;
      if (eggAutoBtn) {
        eggAutoBtn.textContent = 'Auto';
      }
    };

    const startEggAuto = (count) => {
      stopEggAuto();
      state.eggStation.autoEnabled = true;
      state.eggStation.autoCount = count;
      if (eggAutoBtn) {
        eggAutoBtn.textContent = `Auto ${count}`;
      }
      if (!state.eggStation.inProximity) {
        stopEggAuto();
        return;
      }
      // Start immediately; next hatch is chained after reveal/cleanup.
      startEggHatchSequence(state.eggStation.autoCount);
    };

    // Get emoji icon for egg type
    const getEggIcon = (eggType) => {
      const icons = {
        stone: 'ðŸª¨',
        gem: 'ðŸ’Ž',
        crystal: 'ðŸ”®',
        abyssal: 'ðŸŒŠ',
        boardwalk: 'ðŸ–ï¸',
        shipwreck: 'ðŸš¢',
        sand: 'ðŸœï¸',
        snow: 'â„ï¸',
        lava: 'ðŸŒ‹',
      };
      return icons[eggType] || 'ðŸ¥š';
    };

    // Switch to a different egg station
    const selectEggStation = (station) => {
      if (!station) return;
      state.eggStation.stationId = station.id;
      state.eggStation.stationName = station.name;
      state.eggStation.eggType = station.eggType;
      state.eggStation.defaultOpenCount = station.defaultOpenCount ?? 1;
      state.eggStation.costGold = station.costGold ?? 0;
      state.eggStation.eggPets = station.eggPets ?? [];
      renderEggStation();
    };

    const renderEggStation = () => {
      if (!eggModal) return;
      if (!state.eggStation.inProximity) return;

      // Render egg tabs (if multiple stations available)
      if (eggTabsEl) {
        const stations = state.eggStation.stations || [];
        if (stations.length > 1) {
          eggTabsEl.innerHTML = '';
          for (const station of stations) {
            const isActive = station.id === state.eggStation.stationId;
            const tab = document.createElement('div');
            tab.className = 'egg-tab' + (isActive ? ' egg-tab--active' : '');
            tab.dataset.id = station.id;
            tab.innerHTML = `
              <div class="egg-tab__icon">${getEggIcon(station.eggType)}</div>
              <div class="egg-tab__name">${station.name}</div>
              <div class="egg-tab__cost">${formatNumber(station.costGold)}g</div>
            `;
            tab.addEventListener('click', () => {
              if (station.id !== state.eggStation.stationId) {
                selectEggStation(station);
              }
            });
            eggTabsEl.appendChild(tab);
          }
        } else {
          eggTabsEl.innerHTML = '';
        }
      }

      if (eggModalTitleEl) eggModalTitleEl.textContent = 'Egg Station';
      if (eggStationNameEl) eggStationNameEl.textContent = state.eggStation.stationName || 'Egg Station';
      if (eggStationIconEl) eggStationIconEl.textContent = getEggIcon(state.eggStation.eggType);
      if (eggStationCostEl) eggStationCostEl.textContent = formatNumber(state.eggStation.costGold || 0);
      if (eggStationGoldEl) eggStationGoldEl.textContent = formatNumber(state.gold || 0);
      if (eggStationInvEl) eggStationInvEl.textContent = `${state.pets.ownedCount}/${state.pets.ownedCap}`;
      if (eggStationStatusEl) {
        if (state.eggStation.autoArmed && !state.eggStation.autoEnabled) {
          eggStationStatusEl.textContent = 'Choose Open 1 or Open 3';
        } else if (state.eggStation.autoEnabled) {
          eggStationStatusEl.textContent = `Auto Opening ${state.eggStation.autoCount}...`;
        } else {
          eggStationStatusEl.textContent = 'Ready';
        }
      }

      if (eggOpen1Btn) {
        const c = state.eggStation.costGold || 0;
        eggOpen1Btn.textContent = `Open 1 (${formatNumber(c)})`;
      }
      if (eggOpen3Btn) {
        const c = (state.eggStation.costGold || 0) * 3;
        eggOpen3Btn.textContent = `Open 3 (${formatNumber(c)})`;
      }

      if (eggResultsListEl) {
        eggResultsListEl.innerHTML = '';
        const last = Array.isArray(state.eggStation.lastHatch) ? state.eggStation.lastHatch : [];
        if (last.length === 0) {
          const empty = document.createElement('div');
          empty.style.opacity = '0.8';
          empty.textContent = 'No hatches yet.';
          eggResultsListEl.appendChild(empty);
        } else {
          for (const pet of last.slice(0, 12)) {
            const row = document.createElement('div');
            row.className = 'egg-result-item';
            const left = document.createElement('div');
            left.className = 'egg-result-item__name';
            left.textContent = pet.name || pet.id || 'Pet';
            const right = document.createElement('div');
            right.className = 'egg-result-item__mult';
            right.textContent = `+${formatMultiplier(pet.multiplier ?? 0)}`;
            row.appendChild(left);
            row.appendChild(right);
            eggResultsListEl.appendChild(row);
          }
        }
      }

      renderEggShopPets();
    };

    // Format multiplier with K, M, B suffixes (max 1 decimal place)
    const formatMultiplier = (value) => {
      if (value < 0) return '-' + formatMultiplier(-value);
      if (value === 0) return '0';
      if (value < 1000) return String(Math.round(value));
      
      if (value >= 1e9) {
        const billions = value / 1e9;
        const formatted = billions % 1 === 0 
          ? billions.toFixed(0)
          : billions.toFixed(1).replace(/\.0+$/, '');
        return formatted + 'B';
      }
      if (value >= 1e6) {
        const millions = value / 1e6;
        const formatted = millions % 1 === 0
          ? millions.toFixed(0)
          : millions.toFixed(1).replace(/\.0+$/, '');
        return formatted + 'M';
      }
      if (value >= 1000) {
        const thousands = value / 1000;
        const formatted = thousands % 1 === 0
          ? thousands.toFixed(0)
          : thousands.toFixed(1).replace(/\.0+$/, '');
        return formatted + 'K';
      }
      return String(Math.round(value));
    };

    const renderPets = () => {
      // Top counters
      if (petsOwnedCountEl) petsOwnedCountEl.textContent = `${state.pets.ownedCount}/${state.pets.ownedCap}`;
      if (petsEquippedCountEl) petsEquippedCountEl.textContent = `${state.pets.equippedCount}/${state.pets.equippedCap}`;
      if (petsMultiplierSumEl) petsMultiplierSumEl.textContent = formatMultiplier(state.pets.multiplierSum ?? 0);

      // Delete bar
      if (petsDeleteBarEl) {
        const selectedCount = state.pets.deleteSelected ? Object.keys(state.pets.deleteSelected).length : 0;
        // Show whenever delete mode is enabled (even at 0 selected), like the reference UX.
        petsDeleteBarEl.hidden = !state.pets.deleteMode;
        if (petsDeleteTextEl) petsDeleteTextEl.textContent = `Delete ${selectedCount} Pets!`;
        if (petsDeleteConfirmBtn) petsDeleteConfirmBtn.disabled = selectedCount === 0;
      }

      // Disable bulk actions during delete mode
      if (petsEquipBestBtn) petsEquipBestBtn.disabled = Boolean(state.pets.deleteMode);
      if (petsUnequipAllBtn) petsUnequipAllBtn.disabled = Boolean(state.pets.deleteMode);

      if (!petsGridEl) return;
      petsGridEl.innerHTML = '';

      const rarityToClass = (rarity) => {
        switch ((rarity || '').toLowerCase()) {
          case 'legendary': return 'pet-tile--legendary';
          case 'epic': return 'pet-tile--epic';
          case 'rare': return 'pet-tile--rare';
          default: return 'pet-tile--common';
        }
      };

      const list = Array.isArray(state.pets.pets) ? state.pets.pets : [];
      // Sort like typical pet inventories: equipped first, then highest multiplier.
      list.sort((a, b) => {
        const ea = Boolean(a.equipped);
        const eb = Boolean(b.equipped);
        if (ea !== eb) return ea ? -1 : 1;
        return (b.multiplier ?? 0) - (a.multiplier ?? 0);
      });

      const getSelectedPet = () => {
        if (!state.pets.selectedPetInstanceId) return null;
        return list.find(p => p.instanceId === state.pets.selectedPetInstanceId) || null;
      };

      const renderPetDetail = (pet) => {
        if (!petDetailPanelEl) return;
        if (!pet) {
          petDetailPanelEl.hidden = true;
          return;
        }
        petDetailPanelEl.hidden = false;

        if (petDetailNameEl) petDetailNameEl.textContent = pet.name || pet.id || 'Pet';
        if (petDetailMultEl) petDetailMultEl.textContent = formatMultiplier(pet.multiplier ?? 0);
        if (petDetailRarityEl) petDetailRarityEl.textContent = (pet.rarity || '').toUpperCase();

        if (petDetailImageEl) {
          petDetailImageEl.innerHTML = '';
          const img = document.createElement('img');
          img.alt = pet.name || pet.petId || 'Pet';
          const petImageUri = pet.imageUri || `ui/pets/${pet.petId}.png`;
          img.src = `{{CDN_ASSETS_URL}}/${petImageUri}`;
          img.className = 'pet-detail__img-el';
          img.onerror = () => {
            petDetailImageEl.textContent = 'ðŸ¾';
          };
          petDetailImageEl.appendChild(img);
        }

        if (petDetailActionEl) {
          const isEquipped = Boolean(pet.equipped);
          petDetailActionEl.textContent = isEquipped ? 'Unequip' : 'Equip';
          petDetailActionEl.classList.toggle('pet-detail__action--equip', !isEquipped);
          petDetailActionEl.classList.toggle('pet-detail__action--unequip', isEquipped);
        }
      };

      // Keep detail panel synced with latest state
      renderPetDetail(getSelectedPet());

      for (const pet of list) {
        const tile = document.createElement('button');
        const isMarkedForDelete = Boolean(state.pets.deleteSelected?.[pet.instanceId]);
        tile.className = `pet-tile ${rarityToClass(pet.rarity)} ${pet.equipped ? 'pet-tile--equipped' : ''} ${state.pets.deleteMode ? 'pet-tile--delete-mode' : ''} ${isMarkedForDelete ? 'pet-tile--delete-selected' : ''}`;
        tile.setAttribute('tabindex', '-1');

        const imgWrap = document.createElement('div');
        imgWrap.className = 'pet-tile__img';

        // If you later add images at assets/ui/pets/<petId>.png this will pick them up automatically.
        const img = document.createElement('img');
        img.className = 'pet-tile__img-el';
        img.alt = pet.name || pet.petId || 'Pet';
        const petImageUri = pet.imageUri || `ui/pets/${pet.petId}.png`;
        img.src = `{{CDN_ASSETS_URL}}/${petImageUri}`;
        img.onerror = () => {
          img.style.display = 'none';
          imgWrap.textContent = 'ðŸ¾';
        };
        imgWrap.appendChild(img);

        const mult = document.createElement('div');
        mult.className = 'pet-tile__mult';
        mult.textContent = formatMultiplier(pet.multiplier ?? 0);

        tile.appendChild(imgWrap);
        tile.appendChild(mult);

        if (state.pets.deleteMode) {
          const overlay = document.createElement('div');
          overlay.className = 'pet-tile__delete-overlay';
          overlay.textContent = 'âœ–';
          overlay.style.display = isMarkedForDelete ? 'flex' : 'none';
          tile.appendChild(overlay);
        }

        tile.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (state.pets.deleteMode) {
            // Only allow marking inventory pets (inv:<idx>) and never equipped
            const isInventory = typeof pet.instanceId === 'string' && pet.instanceId.startsWith('inv:');
            if (!isInventory || pet.equipped) return;

            if (!state.pets.deleteSelected) state.pets.deleteSelected = {};
            if (state.pets.deleteSelected[pet.instanceId]) {
              delete state.pets.deleteSelected[pet.instanceId];
            } else {
              state.pets.deleteSelected[pet.instanceId] = true;
            }
            // Close detail panel while in delete mode
            state.pets.selectedPetInstanceId = null;
            if (petDetailPanelEl) petDetailPanelEl.hidden = true;
            // Re-render to update overlays
            renderPets();
            return;
          }

          state.pets.selectedPetInstanceId = pet.instanceId;
          renderPetDetail(pet);
        });

        petsGridEl.appendChild(tile);
      }
    };

    // Footer buttons
    if (petsEquipBestBtn) {
      petsEquipBestBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        hytopia.sendData({ type: 'PET_EQUIP_BEST' });
      });
    }
    if (petsUnequipAllBtn) {
      petsUnequipAllBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        hytopia.sendData({ type: 'PET_UNEQUIP_ALL' });
      });
    }

    if (petsTrashToggleBtn) {
      petsTrashToggleBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        state.pets.deleteMode = !state.pets.deleteMode;
        // Reset selection when leaving delete mode
        if (!state.pets.deleteMode) {
          state.pets.deleteSelected = {};
        }
        // Hide detail panel while in delete mode
        if (state.pets.deleteMode) {
          state.pets.selectedPetInstanceId = null;
          if (petDetailPanelEl) petDetailPanelEl.hidden = true;
        }
        renderPets();
      });
    }

    if (petsDeleteCancelBtn) {
      petsDeleteCancelBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        state.pets.deleteSelected = {};
        state.pets.deleteMode = false;
        if (petsDeleteBarEl) petsDeleteBarEl.hidden = true;
        renderPets();
      });
    }

    if (petsDeleteConfirmBtn) {
      petsDeleteConfirmBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const selected = state.pets.deleteSelected || {};
        const instanceIds = Object.keys(selected);
        const indices = instanceIds
          .filter((id) => id.startsWith('inv:'))
          .map((id) => Number(id.split(':')[1]))
          .filter((n) => Number.isFinite(n));
        if (indices.length === 0) return;
        hytopia.sendData({ type: 'PET_DELETE_INV', indices });
        // Optimistically exit delete mode; server PET_STATE will refresh the grid
        state.pets.deleteSelected = {};
        state.pets.deleteMode = false;
        if (petsDeleteBarEl) petsDeleteBarEl.hidden = true;
      });
    }

    // Pet detail panel controls
    if (petDetailCloseEl) {
      petDetailCloseEl.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        state.pets.selectedPetInstanceId = null;
        if (petDetailPanelEl) petDetailPanelEl.hidden = true;
      });
    }
    if (petDetailActionEl) {
      petDetailActionEl.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const list = Array.isArray(state.pets.pets) ? state.pets.pets : [];
        const current = state.pets.selectedPetInstanceId ? (list.find(p => p.instanceId === state.pets.selectedPetInstanceId) || null) : null;
        if (!current) return;
        if (current.equipped) {
          hytopia.sendData({ type: 'PET_UNEQUIP_INSTANCE', slotIndex: current.slotIndex });
        } else {
          hytopia.sendData({ type: 'PET_EQUIP_INSTANCE', slotIndex: current.slotIndex });
        }
      });
    }

    // Render maps list
    function renderMapsList(worlds) {
      if (!mapsListEl) return;
      mapsListEl.innerHTML = '';

      worlds.forEach((world) => {
        const worldCard = document.createElement('div');
        worldCard.className = `maps-card ${world.isCurrent ? 'maps-card--current' : ''} ${!world.isUnlocked ? 'maps-card--locked' : ''}`;

        const worldName = document.createElement('div');
        worldName.className = 'maps-card__name';
        worldName.textContent = world.name;
        worldCard.appendChild(worldName);

        const worldInfo = document.createElement('div');
        worldInfo.className = 'maps-card__info';
        
        if (world.trophyMultiplier > 1) {
          const trophyMultiplier = document.createElement('div');
          trophyMultiplier.className = 'maps-card__multiplier';
          trophyMultiplier.innerHTML = `ðŸ† x${world.trophyMultiplier}`;
          worldInfo.appendChild(trophyMultiplier);
        }

        if (world.isCurrent) {
          const currentBadge = document.createElement('div');
          currentBadge.className = 'maps-card__current';
          currentBadge.textContent = 'Current';
          worldInfo.appendChild(currentBadge);
        }

        worldCard.appendChild(worldInfo);

        const worldActions = document.createElement('div');
        worldActions.className = 'maps-card__actions';

        if (!world.isUnlocked) {
          const unlockBtn = document.createElement('button');
          unlockBtn.className = 'maps-card__btn maps-card__btn--unlock';
          if (world.unlockRequirement) {
            unlockBtn.textContent = `Unlock (${world.unlockRequirement.amount} wins)`;
          } else {
            unlockBtn.textContent = 'Unlock';
          }
          unlockBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            hytopia.sendData({ type: 'UNLOCK_WORLD', worldId: world.id });
          });
          worldActions.appendChild(unlockBtn);
        } else {
          const teleportBtn = document.createElement('button');
          teleportBtn.className = 'maps-card__btn maps-card__btn--teleport';
          teleportBtn.textContent = world.isCurrent ? 'Current' : 'Teleport';
          teleportBtn.disabled = world.isCurrent;
          if (!world.isCurrent) {
            teleportBtn.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              setLoadingScreenVisible(true);
              hytopia.sendData({ type: 'TELEPORT_TO_WORLD', worldId: world.id });
            });
          }
          worldActions.appendChild(teleportBtn);
        }

        worldCard.appendChild(worldActions);
        mapsListEl.appendChild(worldCard);
      });
    }

    // Wire egg station buttons once
    if (eggOpen1Btn) {
      eggOpen1Btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (state.eggStation.autoEnabled) return;
        if (state.eggStation.autoArmed) {
          state.eggStation.autoArmed = false;
          startEggAuto(1);
          renderEggStation();
          return;
        }
        startEggHatchSequence(1);
      });
    }
    if (eggOpen3Btn) {
      eggOpen3Btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (state.eggStation.autoEnabled) return;
        if (state.eggStation.autoArmed) {
          state.eggStation.autoArmed = false;
          startEggAuto(3);
          renderEggStation();
          return;
        }
        startEggHatchSequence(3);
      });
    }
    if (eggAutoBtn) {
      eggAutoBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (!state.eggStation.autoEnabled) {
          state.eggStation.autoArmed = true;
        }
        renderEggStation();
      });
    }
    if (eggShopGridEl) {
      eggShopGridEl.addEventListener('click', (e) => {
        const target = e.target?.closest ? e.target.closest('.egg-shop-card') : null;
        if (!target) return;
        const petId = target.dataset.petId;
        if (!petId) return;
        const enabled = !target.classList.contains('is-auto-delete');
        hytopia.sendData({ type: 'EGG_AUTO_DELETE_TOGGLE', petId, enabled });
      });
    }

    // Store background click handlers and container click handlers for cleanup
    const modalBackgroundHandlers = new Map();
    const modalContainerHandlers = new Map();

    const showModal = (el) => {
      if (!el) return;

      // Close all other modals first to ensure only one modal is open at a time
      allModals.forEach(modal => {
        if (modal && modal !== el && modal.classList.contains('visible')) {
          hideModal(modal);
        }
      });

      el.classList.add('visible');

      // Set body.modal-open to hide HUD elements
      if (window.setModalOpen) window.setModalOpen(true);

      // Create and store background click handler
      const handleBackgroundClick = (e) => {
        // Only close if clicking directly on the modal background (not on the container)
        if (e.target === el) {
          hideModal(el);
        }
      };
      
      // Remove any existing listener first
      const existingHandler = modalBackgroundHandlers.get(el);
      if (existingHandler) {
        el.removeEventListener('click', existingHandler);
      }
      
      // Add new handler and store it
      el.addEventListener('click', handleBackgroundClick);
      modalBackgroundHandlers.set(el, handleBackgroundClick);
      
      // Prevent clicks inside the modal container from closing
      // But allow close button clicks to work
      const container = el.querySelector('.pickaxe-modal__container');
      if (container) {
        // Remove existing container handler if any
        const existingContainerHandler = modalContainerHandlers.get(container);
        if (existingContainerHandler) {
          container.removeEventListener('click', existingContainerHandler);
        }
        
        const handleContainerClick = (e) => {
          // Don't stop propagation if clicking the close button
          const closeButton = e.target.closest('.pickaxe-modal__close, .modal__close, .rebirth-modal__close');
          if (!closeButton) {
            e.stopPropagation();
          }
        };
        
        container.addEventListener('click', handleContainerClick);
        modalContainerHandlers.set(container, handleContainerClick);
      }
      
      // Note: MODAL_OPENED is already sent from button click handlers
      // This ensures the modal state is set before any click processing
      // No need to send it again here
    };

    const hideModal = (el) => {
      if (!el) return;
      el.classList.remove('visible');
      
      // Remove background click listener using stored reference
      const backgroundHandler = modalBackgroundHandlers.get(el);
      if (backgroundHandler) {
        el.removeEventListener('click', backgroundHandler);
        modalBackgroundHandlers.delete(el);
      }
      
      // Remove container click listener
      const container = el.querySelector('.pickaxe-modal__container');
      if (container) {
        const containerHandler = modalContainerHandlers.get(container);
        if (containerHandler) {
          container.removeEventListener('click', containerHandler);
          modalContainerHandlers.delete(container);
        }
      }
      
      // Notify server that a modal is closed (allows manual mining again)
      if (el.id === 'miner-modal') {
        hytopia.sendData({ type: 'MODAL_CLOSED', modalType: 'miner' });
      } else if (el.id === 'pickaxe-modal') {
        hytopia.sendData({ type: 'MODAL_CLOSED', modalType: 'pickaxe' });
      } else if (el.id === 'rebirth-modal') {
        hytopia.sendData({ type: 'MODAL_CLOSED', modalType: 'rebirth' });
      } else if (el.id === 'pets-modal') {
        hytopia.sendData({ type: 'MODAL_CLOSED', modalType: 'pets' });
      } else if (el.id === 'egg-modal') {
        hytopia.sendData({ type: 'MODAL_CLOSED', modalType: 'egg' });
      }

      // Check if any modals are still open, if not, remove body.modal-open
      setTimeout(() => {
        if (window.isAnyModalOpen && !window.isAnyModalOpen()) {
          if (window.setModalOpen) window.setModalOpen(false);
        }
      }, 10);
    };

    const renderPickaxeDetails = () => {
      // Show selected pickaxe, or equipped if none selected
      let pickaxeToShow = null;
      
      if (state.pickaxe.selectedTier !== undefined) {
        pickaxeToShow = state.pickaxe.pickaxes.find(p => p.tier === state.pickaxe.selectedTier);
      }
      
      if (!pickaxeToShow) {
        // Fallback to equipped pickaxe
        pickaxeToShow = state.pickaxe.pickaxes.find(p => p.availability === 'equipped');
      }
      
      if (!pickaxeToShow) {
        // Fallback to current tier
        pickaxeToShow = state.pickaxe.pickaxes.find(p => p.tier === state.pickaxe.currentTier);
      }
      
      if (pickaxeToShow) {
        renderEquippedPickaxe(pickaxeToShow);
      }
    };

    const renderEquippedPickaxe = (pickaxe) => {
      if (!pickaxe) return;
      
      // Update name
      if (pickaxeDetailName) {
        pickaxeDetailName.textContent = `${pickaxe.name} Pickaxe`;
      }

      if (pickaxeDetailIcon) {
        pickaxeDetailIcon.innerHTML = '';
        if (pickaxe.imageUri) {
          const img = document.createElement('img');
          img.src = `{{CDN_ASSETS_URL}}/${pickaxe.imageUri}`;
          img.alt = `${pickaxe.name} pickaxe`;
          img.className = 'pickaxe-details__icon-img';
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'contain';
          pickaxeDetailIcon.appendChild(img);
        } else {
          pickaxeDetailIcon.textContent = 'â›ï¸';
        }
      }

      // Update stats display (per planning document format)
      // REBALANCED: Pickaxes now only affect Speed, Luck, and Sell Value Multiplier
      if (pickaxeDetailStats) {
        pickaxeDetailStats.innerHTML = '';
        
        // Speed (display as percentage increase, e.g., "+5 Speed" means +5% speed)
        const speed = pickaxe.miningSpeed ? Math.round(pickaxe.miningSpeed) : 0;
        const speedStat = document.createElement('div');
        speedStat.className = 'pickaxe-stat pickaxe-stat--speed';
        speedStat.textContent = `+${speed} Speed`;
        pickaxeDetailStats.appendChild(speedStat);
        
        // Luck bonus
        const luckBonus = pickaxe.luckBonus ? (pickaxe.luckBonus * 100).toFixed(0) : '0';
        const luckStat = document.createElement('div');
        luckStat.className = 'pickaxe-stat pickaxe-stat--luck';
        luckStat.textContent = `+${luckBonus}% Ore Luck`;
        pickaxeDetailStats.appendChild(luckStat);
        
        // Sell Value Multiplier
        const sellMultiplier = pickaxe.sellValueMultiplier ? pickaxe.sellValueMultiplier.toFixed(2) : '1.00';
        const sellStat = document.createElement('div');
        sellStat.className = 'pickaxe-stat pickaxe-stat--sell';
        sellStat.textContent = `${sellMultiplier}Ã— Sell Value`;
        pickaxeDetailStats.appendChild(sellStat);
      }

      // Action button logic
      // IMPORTANT: Do NOT cache the action button element globally.
      // We replace it when updating listeners (clone/remove), so we must re-query it each render.
      const pickaxeActionButtonEl = document.getElementById('pickaxe-action-button');
      if (pickaxeActionButtonEl) {
        // Remove existing click listeners by cloning
        const newButton = pickaxeActionButtonEl.cloneNode(true);
        pickaxeActionButtonEl.parentNode.replaceChild(newButton, pickaxeActionButtonEl);
        const actionButton = document.getElementById('pickaxe-action-button');
        
        if (pickaxe.availability === 'equipped') {
          // Currently equipped - show "Equipped" text (not a button)
          actionButton.textContent = 'Equipped';
          actionButton.classList.add('disabled');
          actionButton.disabled = true;
        } else if (pickaxe.availability === 'owned') {
          // Player owns this pickaxe but it's not equipped - show green Equip button
          actionButton.textContent = 'Equip';
          actionButton.classList.remove('disabled');
          actionButton.disabled = false;
          actionButton.dataset.tier = String(pickaxe.tier);
          actionButton.addEventListener('click', () => {
            console.log(`[UI] Equip pickaxe tier ${pickaxe.tier} from action button`);
            hytopia.sendData({ type: 'EQUIP_PICKAXE', tier: pickaxe.tier });
          });
        } else if (pickaxe.availability === 'available') {
          // Next tier available - show buy button with cost, grey out if can't afford
          actionButton.textContent = `ðŸª™ ${formatNumber(pickaxe.cost)}`;
          actionButton.disabled = false;
          if (!pickaxe.purchasable) {
            actionButton.classList.add('disabled');
          } else {
            actionButton.classList.remove('disabled');
          }
          actionButton.dataset.tier = String(pickaxe.tier);
          actionButton.addEventListener('click', () => {
            if (pickaxe.purchasable) {
              console.log(`[UI] Buy pickaxe tier ${pickaxe.tier} from action button`);
              hytopia.sendData({ type: 'BUY_PICKAXE', tier: pickaxe.tier });
            }
          });
        } else {
          // Locked - show locked state
          actionButton.textContent = 'Locked';
          actionButton.classList.add('disabled');
          actionButton.disabled = true;
        }
      }
    };

    const renderPickaxeGrid = () => {
      if (!pickaxeGridEl) return;
      pickaxeGridEl.innerHTML = '';
      const currentTier = state.pickaxe.currentTier;
      
      state.pickaxe.pickaxes.forEach(p => {
        const card = document.createElement('div');
        card.className = 'pickaxe-card';
        
        // Determine state based on availability from backend
        const isEquipped = p.availability === 'equipped';
        const isOwned = p.availability === 'owned';
        const isAvailable = p.availability === 'available';
        const isLocked = p.availability === 'locked';
        const isNextTier = p.tier === currentTier + 1;

        // Apply appropriate classes
        if (isEquipped) {
          card.classList.add('equipped');
        } else if (isOwned) {
          card.classList.add('purchased'); // Owned but not equipped - normal appearance
        } else if (isAvailable) {
          card.classList.add('next-tier'); // Available to purchase
        } else if (isLocked) {
          card.classList.add('locked'); // Greyed out with lock
        }

        const iconEl = document.createElement('div');
        iconEl.className = 'pickaxe-card__icon';
        if (p.imageUri) {
          const img = document.createElement('img');
          img.src = `{{CDN_ASSETS_URL}}/${p.imageUri}`;
          img.alt = `${p.name} pickaxe`;
          img.className = 'pickaxe-card__icon-img';
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'contain';
          iconEl.appendChild(img);
        } else {
          iconEl.textContent = 'â›ï¸';
        }
        card.appendChild(iconEl);

        const nameEl = document.createElement('div');
        nameEl.className = 'pickaxe-card__name';
        nameEl.textContent = p.name;
        card.appendChild(nameEl);

        // Cost display (only if not equipped and not owned)
        if (!isEquipped && !isOwned) {
          const costEl = document.createElement('div');
          costEl.className = 'pickaxe-card__cost';
          costEl.innerHTML = `<span>ðŸª™</span> ${formatNumber(p.cost)}`;
          card.appendChild(costEl);
        }

        // No buy/equip buttons on cards - all interactions happen in sidebar

        // Equipped checkmark
        if (isEquipped) {
          const checkmark = document.createElement('div');
          checkmark.className = 'pickaxe-card__checkmark';
          checkmark.textContent = 'âœ“';
          card.appendChild(checkmark);
        }

        // Lock icon (if locked)
        if (isLocked) {
          const lock = document.createElement('div');
          lock.className = 'pickaxe-card__lock';
          lock.textContent = 'ðŸ”’';
          card.appendChild(lock);
        }

        // Highlight selected card
        if (state.pickaxe.selectedTier === p.tier) {
          card.classList.add('selected');
        }

        // Click to select (for details view) - for all pickaxes
        card.addEventListener('click', () => {
          state.pickaxe.selectedTier = p.tier;
          renderPickaxeGrid();
          renderPickaxeDetails();
        });

        pickaxeGridEl.appendChild(card);
      });
    };

    const updatePickaxeModal = (data) => {
      state.pickaxe.pickaxes = data.pickaxes || [];
      state.pickaxe.currentTier = data.currentTier ?? 0;
      state.gold = data.gold ?? state.gold;

      // If no selection, select the equipped pickaxe
      if (state.pickaxe.selectedTier === undefined || state.pickaxe.selectedTier === -1) {
        const equipped = state.pickaxe.pickaxes.find(p => p.availability === 'equipped');
        state.pickaxe.selectedTier = equipped ? equipped.tier : (state.pickaxe.currentTier >= 0 ? state.pickaxe.currentTier : (data.pickaxes && data.pickaxes.length > 0 ? data.pickaxes[0].tier : 0));
      }

      renderPickaxeGrid();
      renderPickaxeDetails();
      showModal(pickaxeModal);
    };

    const renderMinerDetails = () => {
      // Show selected miner, or equipped if none selected
      let minerToShow = null;
      
      if (state.miner.selectedTier !== undefined && state.miner.selectedTier !== -1) {
        minerToShow = state.miner.miners.find(m => m.tier === state.miner.selectedTier);
      }
      
      if (!minerToShow) {
        // Fallback to equipped miner
        minerToShow = state.miner.miners.find(m => m.availability === 'equipped');
      }
      
      if (minerToShow) {
        renderEquippedMiner(minerToShow);
      } else {
        renderEquippedMiner(null);
      }
    };

    const renderEquippedMiner = (miner) => {
      const minerActionButton = document.getElementById('miner-action-button');
      if (!minerDetailName || !minerDetailStats || !minerActionButton || !minerDetailIcon) return;

        if (!miner) {
          // No miner equipped
          minerDetailIcon.textContent = 'â›‘ï¸';
          minerDetailName.textContent = 'No Miner';
          minerDetailStats.innerHTML = '';
          if (minerActionButton) {
            minerActionButton.textContent = 'No Miner';
            minerActionButton.classList.add('disabled');
            minerActionButton.disabled = true;
          }
          return;
        }

        minerDetailIcon.innerHTML = '';
        if (miner.imageUri) {
          const img = document.createElement('img');
          img.src = `{{CDN_ASSETS_URL}}/${miner.imageUri}`;
          img.alt = `${miner.name} miner`;
          img.className = 'pickaxe-details__icon-img';
          minerDetailIcon.appendChild(img);
        } else {
          minerDetailIcon.textContent = 'â›‘ï¸';
        }
        minerDetailName.textContent = miner.name;
      
      // Clear and rebuild stats with proper styling classes
      minerDetailStats.innerHTML = '';
      
      // Coin Bonus
      const coinStat = document.createElement('div');
      coinStat.className = 'pickaxe-stat pickaxe-stat--sell';
      coinStat.textContent = `+${miner.coinBonus}% Coins`;
      minerDetailStats.appendChild(coinStat);
      
      // Ore Luck Bonus
      const luckStat = document.createElement('div');
      luckStat.className = 'pickaxe-stat pickaxe-stat--luck';
      luckStat.textContent = `+${miner.oreLuckBonus}% Ore Luck`;
      minerDetailStats.appendChild(luckStat);
      
      // Damage Bonus
      const damageStat = document.createElement('div');
      damageStat.className = 'pickaxe-stat pickaxe-stat--damage';
      damageStat.textContent = `+${miner.damageBonus}% Damage`;
      minerDetailStats.appendChild(damageStat);
      
      // Action button logic
      if (minerActionButton) {
        // Remove existing click listeners by cloning
        const newButton = minerActionButton.cloneNode(true);
        minerActionButton.parentNode.replaceChild(newButton, minerActionButton);
        const actionButton = document.getElementById('miner-action-button');
        
        if (miner.availability === 'equipped') {
          // Currently equipped - show "Equipped" text (not a button)
          actionButton.textContent = 'Equipped';
          actionButton.classList.add('disabled');
          actionButton.disabled = true;
        } else if (miner.availability === 'owned') {
          // Player owns this miner but it's not equipped - show green Equip button
          actionButton.textContent = 'Equip';
          actionButton.classList.remove('disabled');
          actionButton.disabled = false;
          actionButton.dataset.tier = String(miner.tier);
          actionButton.addEventListener('click', () => {
            console.log(`[UI] Equip miner tier ${miner.tier} from action button`);
            hytopia.sendData({ type: 'EQUIP_MINER', tier: miner.tier });
          });
        } else if (miner.availability === 'available') {
          // Next tier available - show buy button with cost, grey out if can't afford
          actionButton.textContent = `ðŸª™ ${formatNumber(miner.cost)}`;
          actionButton.disabled = false;
          if (!miner.purchasable) {
            actionButton.classList.add('disabled');
          } else {
            actionButton.classList.remove('disabled');
          }
          actionButton.dataset.tier = String(miner.tier);
          actionButton.addEventListener('click', () => {
            if (miner.purchasable) {
              console.log(`[UI] Buy miner tier ${miner.tier} from action button`);
              hytopia.sendData({ type: 'BUY_MINER', tier: miner.tier });
            }
          });
        } else {
          // Locked - show locked state
          actionButton.textContent = 'Locked';
          actionButton.classList.add('disabled');
          actionButton.disabled = true;
        }
      }
    };

    const renderMinerGrid = () => {
      if (!minerGridEl) return;
      minerGridEl.innerHTML = '';

      const currentTier = state.miner.currentTier;
      const gold = state.gold;

      state.miner.miners.forEach(m => {
        const card = document.createElement('div');
        card.className = 'pickaxe-card';
        
        // Determine state based on availability from backend
        const isEquipped = m.availability === 'equipped';
        const isOwned = m.availability === 'owned';
        const isAvailable = m.availability === 'available';
        const isLocked = m.availability === 'locked';

        // Apply appropriate classes (similar to pickaxe grid)
        if (isEquipped) {
          card.classList.add('equipped');
        } else if (isOwned) {
          card.classList.add('purchased'); // Owned but not equipped - normal appearance
        } else if (isAvailable) {
          card.classList.add('next-tier'); // Available to purchase
        } else if (isLocked) {
          card.classList.add('locked'); // Greyed out with lock
        }

          const iconEl = document.createElement('div');
          iconEl.className = 'pickaxe-card__icon';
          if (m.imageUri) {
            const img = document.createElement('img');
            img.src = `{{CDN_ASSETS_URL}}/${m.imageUri}`;
            img.alt = `${m.name} miner`;
            img.className = 'pickaxe-card__icon-img';
            iconEl.appendChild(img);
          } else {
            iconEl.textContent = 'â›‘ï¸';
          }
          card.appendChild(iconEl);

        const nameEl = document.createElement('div');
        nameEl.className = 'pickaxe-card__name';
        nameEl.textContent = m.name;
        card.appendChild(nameEl);

        // Cost display (only if not equipped and not owned)
        if (!isEquipped && !isOwned) {
          const costEl = document.createElement('div');
          costEl.className = 'pickaxe-card__cost';
          costEl.innerHTML = `<span>ðŸª™</span> ${formatNumber(m.cost)}`;
          card.appendChild(costEl);
        }

        // No buy/equip buttons on cards - all interactions happen in sidebar

        // Equipped checkmark
        if (isEquipped) {
          const checkmark = document.createElement('div');
          checkmark.className = 'pickaxe-card__checkmark';
          checkmark.textContent = 'âœ“';
          card.appendChild(checkmark);
        }

        // Lock icon (if locked)
        if (isLocked) {
          const lock = document.createElement('div');
          lock.className = 'pickaxe-card__lock';
          lock.textContent = 'ðŸ”’';
          card.appendChild(lock);
        }

        // Highlight selected card
        if (state.miner.selectedTier === m.tier) {
          card.classList.add('selected');
        }

        card.addEventListener('click', () => {
          state.miner.selectedTier = m.tier;
          renderMinerGrid();
          renderMinerDetails();
        });

        minerGridEl.appendChild(card);
      });
    };

    const updateMinerModal = (data) => {
      state.miner.miners = data.miners || [];
      state.miner.currentTier = data.currentTier ?? -1;
      state.gold = data.gold ?? state.gold;
      
      // If no selection, select the equipped miner
      if (state.miner.selectedTier === undefined || state.miner.selectedTier === -1) {
        const equipped = state.miner.miners.find(m => m.availability === 'equipped');
        state.miner.selectedTier = equipped ? equipped.tier : (state.miner.currentTier >= 0 ? state.miner.currentTier : (data.miners && data.miners.length > 0 ? data.miners[0].tier : -1));
      }
      
      renderMinerGrid();
      renderMinerDetails();
      showModal(minerModal);
    };

    const renderRebirthOptions = () => {
      if (!rebirthOptionsEl) return;
      rebirthOptionsEl.innerHTML = '';
      
      // Sort options by count (1, 5, 20)
      const sortedOptions = [...state.rebirth.options].sort((a, b) => a.count - b.count);

      sortedOptions.forEach(opt => {
        const card = document.createElement('div');
        card.className = 'rebirth-option';

        // Left side: Rebirth count and cost
        const info = document.createElement('div');
        info.className = 'rebirth-option__info';
        
        const title = document.createElement('div');
        title.className = 'rebirth-option__title';
        // Format the count using formatNumber for readability (e.g., "1K Rebirths" instead of "1000 Rebirths")
        const formattedCount = formatNumber(opt.count);
        title.textContent = `${formattedCount} Rebirth${opt.count > 1 ? 's' : ''}`;
        info.appendChild(title);
        
        const cost = document.createElement('div');
        cost.className = 'rebirth-option__cost';
        cost.textContent = `${formatNumber(opt.cost)} Power`;
        info.appendChild(cost);
        
        card.appendChild(info);

        // Right side: Button
        const actionWrapper = document.createElement('div');
        actionWrapper.className = 'rebirth-option__action';
        const btn = document.createElement('button');
        btn.className = 'rebirth-button';
        btn.textContent = 'Rebirth';
        const affordable = state.power >= opt.cost;
        if (!affordable) {
          btn.classList.add('disabled');
          card.classList.add('unavailable');
        }
        btn.addEventListener('click', () => {
          if (!affordable) return;
          console.log(`[UI] Performing rebirth: ${opt.count}`);
          hytopia.sendData({ type: 'PERFORM_REBIRTH', rebirthCount: opt.count });
        });
        actionWrapper.appendChild(btn);
        card.appendChild(actionWrapper);

        rebirthOptionsEl.appendChild(card);
      });
    };

    const updateRebirthModal = (data) => {
      state.power = data.currentPower ?? state.power;
      state.rebirths = data.currentRebirths ?? state.rebirths;
      state.rebirth.options = data.options || [];
      state.rebirth.maxRebirths = data.maxRebirths ?? 0;
      renderRebirthOptions();
      showModal(rebirthModal);
      if (rebirthBadge) rebirthBadge.hidden = !(data.canRebirth);
    };

    const spawnMinedOrePopup = (oreName, oreColor) => {
      // Skip mined ore popup on mobile - too cluttered
      if (document.body.classList.contains('mobile')) {
        return;
      }

      const timestamp = Date.now();
      console.log(`[UI] spawnMinedOrePopup called with oreName: ${oreName}, oreColor: ${oreColor}, timestamp: ${timestamp}`);

      // Check for existing popups to see if they're being reused
      const existingPopups = minedOreLayerEl.querySelectorAll('.mined-ore-popup');
      if (existingPopups.length > 0) {
        console.log(`[UI] WARNING: ${existingPopups.length} existing ore popups found when spawning new one!`);
        existingPopups.forEach((popup, index) => {
          console.log(`[UI] Existing popup ${index}: classes: ${popup.className}, text: ${popup.textContent}`);
        });
      }
      if (!minedOreLayerEl) {
        console.error('[UI] minedOreLayerEl not found! Cannot spawn popup.');
        return;
      }
      
      const popup = document.createElement('div');
      popup.className = 'mined-ore-popup';
      
      // Create text with + prefix
      const oreText = document.createElement('span');
      oreText.className = 'mined-ore-popup__text';
      oreText.textContent = `+${oreName}`;
      // Apply ore color if provided, otherwise use default white
      oreText.style.color = oreColor || '#ffffff';
      popup.appendChild(oreText);
      
      // Position above the block health bar name (centered, above the ore name)
      // Block health bar is at bottom: 120px, name is at the top of it
      // Position popup above the name text
      popup.style.left = '50%';
      popup.style.bottom = '220px'; // Above the ore name
      popup.style.transform = 'translateX(-50%)';
      
      minedOreLayerEl.appendChild(popup);
      
      // Force a reflow before adding active class
      popup.offsetHeight;
      
      // Add active class to trigger float up animation
      requestAnimationFrame(() => {
        popup.classList.add('active');
      });

      // Fade out and remove
      setTimeout(() => {
        popup.classList.add('fade-out');
        setTimeout(() => popup.remove(), 300); // Wait for fade out animation
      }, 900); // Total visible time ~1 second
    };

    const spawnPowerGain = (amount, rockPosition) => {
      console.log('[UI] spawnPowerGain called with amount:', amount, 'rockPosition:', rockPosition);
      if (!powerGainLayer) {
        console.error('[UI] powerGainLayer not found! Cannot spawn popup.');
        return;
      }
      console.log('[UI] powerGainLayer found, creating popup');
      
      const popup = document.createElement('div');
      popup.className = 'power-gain';
      
      // Add explosion icon and power amount
      const icon = document.createElement('span');
      icon.className = 'power-gain__icon';
      icon.textContent = 'ðŸ’¥';
      popup.appendChild(icon);
      
      const text = document.createElement('span');
      text.className = 'power-gain__text';
      text.textContent = `+${formatPopupNumber(amount)}`;
      popup.appendChild(text);
      
      // Position popup near the rock if position is provided
      if (rockPosition && typeof hytopia !== 'undefined' && hytopia.worldToScreen) {
        try {
          // Convert world position to screen coordinates
          const screenPos = hytopia.worldToScreen(rockPosition.x, rockPosition.y + 2, rockPosition.z);
          if (screenPos && screenPos.x !== undefined && screenPos.y !== undefined) {
            // Position near the rock with slight random offset
            const offsetX = (Math.random() - 0.5) * 60; // -30 to +30 pixels
            const offsetY = (Math.random() - 0.5) * 60; // -30 to +30 pixels
            popup.style.left = `${screenPos.x + offsetX}px`;
            popup.style.top = `${screenPos.y + offsetY}px`;
            popup.style.transform = 'translate(-50%, -50%) scale(0.8)';
          } else {
            // Fallback to center screen with random offset
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            const offsetX = (Math.random() - 0.5) * 200;
            const offsetY = (Math.random() - 0.5) * 200;
            popup.style.left = `${centerX + offsetX}px`;
            popup.style.top = `${centerY + offsetY}px`;
            popup.style.transform = 'translate(-50%, -50%) scale(0.8)';
          }
        } catch (e) {
          console.warn('[UI] Failed to convert world to screen position:', e);
          // Fallback to center screen
          popup.style.left = '50%';
          popup.style.top = '50%';
          popup.style.transform = 'translate(-50%, -50%) scale(0.8)';
        }
      } else {
        // Fallback: center of screen with random offset
        const centerX = window.innerWidth / 2;
        const centerY = window.innerHeight / 2;
        const offsetX = (Math.random() - 0.5) * 200;
        const offsetY = (Math.random() - 0.5) * 200;
        popup.style.left = `${centerX + offsetX}px`;
        popup.style.top = `${centerY + offsetY}px`;
        popup.style.transform = 'translate(-50%, -50%) scale(0.8)';
      }
      
      powerGainLayer.appendChild(popup);
      
      // Force a reflow before adding active class
      popup.offsetHeight;
      
      // Add active class to trigger animation
      requestAnimationFrame(() => {
        popup.classList.add('active');
      });
      
      setTimeout(() => {
        popup.classList.remove('active');
        setTimeout(() => popup.remove(), 600); // Wait for fade out animation
      }, 1000); // Disappear after 1 second
    };

    const spawnDamagePopup = (damage) => {
      if (!damagePopupLayerEl) {
        console.error('[UI] damagePopupLayerEl not found! Cannot spawn damage popup.');
        return;
      }

      if (damage <= 0) {
        return; // Don't show popup for 0 damage
      }

      const popup = document.createElement('div');
      popup.className = 'damage-popup';

      const isMobile = document.body.classList.contains('mobile');

      if (isMobile) {
        // On mobile: position centered like power gain popups
        const icon = document.createElement('span');
        icon.className = 'damage-popup__icon';
        icon.textContent = 'âš”ï¸';
        popup.appendChild(icon);

        const damageText = document.createElement('span');
        damageText.className = 'damage-popup__text';
        damageText.textContent = `-${formatNumber(damage)}`;
        popup.appendChild(damageText);

        // Position near center with random offset (like power gain)
        const offsetX = (Math.random() - 0.5) * 60;
        const offsetY = (Math.random() - 0.5) * 40;
        popup.style.left = `${(window.innerWidth / 2) + offsetX}px`;
        popup.style.top = `${(window.innerHeight / 2) + offsetY}px`;
        popup.style.transform = 'translate(-50%, -50%) scale(0.8)';
        popup.classList.add('mobile');
      } else {
        // On desktop: position to the right of the HP bar
        const damageText = document.createElement('span');
        damageText.className = 'damage-popup__text';
        damageText.textContent = `${formatNumber(damage)} Dmg`;
        popup.appendChild(damageText);

        const hpBarCenter = window.innerWidth / 2;
        const hpBarRightEdge = hpBarCenter + 150;
        const gap = 240;
        const leftPosition = hpBarRightEdge + gap + (Math.random() * 20 - 10);
        const bottomOffset = 180 + (Math.random() * 10 - 5);
        popup.style.left = `${leftPosition}px`;
        popup.style.bottom = `${bottomOffset}px`;
      }

      damagePopupLayerEl.appendChild(popup);

      // Force a reflow before adding active class
      popup.offsetHeight;

      // Add active class to trigger animation
      requestAnimationFrame(() => {
        popup.classList.add('active');
      });

      setTimeout(() => {
        popup.classList.remove('active');
        setTimeout(() => popup.remove(), 400); // Wait for fade out animation after removing active class
      }, isMobile ? 1000 : 1500); // Shorter duration on mobile like power gain
    };

    const renderTrainingPrompt = () => {
      if (!trainingPromptEl || !trainingPromptTitleEl || !trainingPromptSubtitleEl || !trainingPromptKeyEl) return;
      if (!state.prompt.visible) {
        trainingPromptEl.classList.remove('visible');
        return;
      }

      // Show "Hold E to interact" message
      trainingPromptTitleEl.textContent = state.prompt.rockName;
      trainingPromptSubtitleEl.textContent = `Hold ${state.prompt.actionKey || 'E'} to interact`;
      trainingPromptKeyEl.textContent = (state.prompt.actionKey || 'E').toUpperCase();
      trainingPromptEl.classList.toggle('locked', state.prompt.canTrain === false);
      trainingPromptEl.classList.add('visible');
    };

    // Setup button handlers
    const autoMineButton = document.getElementById('auto-mine-button');
    const autoTrainButton = document.getElementById('auto-train-button');
    const toSurfaceButton = document.getElementById('to-surface-button');

    // Ensure buttons don't have focus on load - blur them immediately
    if (autoMineButton) autoMineButton.blur();
    if (autoTrainButton) autoTrainButton.blur();
    if (toSurfaceButton) toSurfaceButton.blur();
    
    // Ensure body has focus for keyboard input
    if (document.body) {
      document.body.focus();
    }

  // Default auto-mine state to inactive (green) until server sends state
  if (autoMineButton) {
    // Prevent focus so space/enter (jump) don't trigger the button
    autoMineButton.setAttribute('tabindex', '-1');
    autoMineButton.setAttribute('role', 'button');
    
    // Prevent keyboard events from triggering the button
    autoMineButton.addEventListener('keydown', e => {
      // Only prevent Space and Enter from triggering the button
      // Let all other keys (WASD, etc.) pass through to the game
      if (e.code === 'Space' || e.code === 'Enter') {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    });
    
    // Prevent mousedown from focusing the button
    autoMineButton.addEventListener('mousedown', e => {
      e.preventDefault();
      // Don't let mousedown focus the button
      autoMineButton.blur();
    });
    
    autoMineButton.classList.add('inactive');
    
    // Set up click handler
    autoMineButton.addEventListener('click', (e) => {
      console.log('[UI] AUTO MINE button clicked');
      // Optimistically toggle UI state for instant feedback
      const nextEnabled = !autoMineButton.classList.contains('active');
      updateAutoMineButton(nextEnabled);

      // Send data to server using correct Hytopia SDK method
      console.log('[UI] Sending TOGGLE_AUTO_MINE to server');
      hytopia.sendData({ type: 'TOGGLE_AUTO_MINE' });

      // Return focus to game so movement keys keep working
      autoMineButton.blur();
      window.focus();
    });
  }

    // Default auto-train state to inactive (green) until server sends state
    if (autoTrainButton) {
      // Prevent focus so space/enter (jump) don't trigger the button
      autoTrainButton.setAttribute('tabindex', '-1');
      autoTrainButton.setAttribute('role', 'button');
      
      // Prevent keyboard events from triggering the button
      autoTrainButton.addEventListener('keydown', e => {
        // Only prevent Space and Enter from triggering the button
        // Let all other keys (WASD, etc.) pass through to the game
        if (e.code === 'Space' || e.code === 'Enter') {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
      });
      
      // Prevent mousedown from focusing the button
      autoTrainButton.addEventListener('mousedown', e => {
        e.preventDefault();
        // Don't let mousedown focus the button
        autoTrainButton.blur();
      });
      
      autoTrainButton.classList.add('inactive');
      
      // Set up click handler
      autoTrainButton.addEventListener('click', (e) => {
        console.log('[UI] AUTO TRAIN button clicked');
        // Optimistically toggle UI state for instant feedback
        const nextEnabled = !autoTrainButton.classList.contains('active');
        updateAutoTrainButton(nextEnabled);

        // Send data to server using correct Hytopia SDK method
        console.log('[UI] Sending TOGGLE_AUTO_TRAIN to server');
        hytopia.sendData({ type: 'TOGGLE_AUTO_TRAIN' });

        // Return focus to game so movement keys keep working
        autoTrainButton.blur();
        window.focus();
      });
    }

    if (toSurfaceButton) {
      // Prevent focus so space/enter (jump) don't trigger the button
      toSurfaceButton.setAttribute('tabindex', '-1');
      toSurfaceButton.setAttribute('role', 'button');
      
      // Prevent keyboard events from triggering the button
      toSurfaceButton.addEventListener('keydown', e => {
        // Only prevent Space and Enter from triggering the button
        // Let all other keys (WASD, etc.) pass through to the game
        if (e.code === 'Space' || e.code === 'Enter') {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
      });
      
      // Prevent mousedown from focusing the button
      toSurfaceButton.addEventListener('mousedown', e => {
        e.preventDefault();
        // Don't let mousedown focus the button
        toSurfaceButton.blur();
      });
      
      // Set up click handler
      toSurfaceButton.addEventListener('click', (e) => {
        console.log('[UI] TELEPORT TO SURFACE button clicked');
        hytopia.sendData({ type: 'TELEPORT_TO_SURFACE' });

        // Return focus to game so movement keys keep working
        toSurfaceButton.blur();
        window.focus();
      });
    }

    function updateProgressBar(currentDepth, goalDepth) {
      const progressBarFillEl = document.getElementById('progress-bar-fill');
      const progressBarMarkerEl = document.getElementById('progress-bar-marker');
      const progressBarEl = document.getElementById('progress-bar');

      if (!progressBarFillEl || !progressBarMarkerEl || !progressBarEl) return;

      const progress = Math.min(100, (currentDepth / goalDepth) * 100);

      // Check if we're in mobile mode (vertical progress bar)
      const isMobile = document.body.classList.contains('mobile');

      if (isMobile) {
        // Vertical mode: use height and bottom
        progressBarFillEl.style.height = `${progress}%`;
        progressBarFillEl.style.width = '100%';
        progressBarMarkerEl.style.bottom = `${progress}%`;
        progressBarMarkerEl.style.left = '-6px';
      } else {
        // Horizontal mode: use width and left
        progressBarFillEl.style.width = `${progress}%`;
        progressBarFillEl.style.height = '100%';
        progressBarMarkerEl.style.left = `${progress}%`;
        progressBarMarkerEl.style.bottom = 'auto';
      }
    }

    function updateAutoMineButton(enabled) {
      if (!autoMineButton) return;
      if (enabled) {
        autoMineButton.classList.add('active');
        autoMineButton.classList.remove('inactive');
      } else {
        autoMineButton.classList.remove('active');
        autoMineButton.classList.add('inactive');
      }
    }

    function updateAutoTrainButton(enabled) {
      if (!autoTrainButton) return;
      if (enabled) {
        autoTrainButton.classList.add('active');
        autoTrainButton.classList.remove('inactive');
      } else {
        autoTrainButton.classList.remove('active');
        autoTrainButton.classList.add('inactive');
      }
    }

    function setLoadingScreenVisible(visible) {
      const loadingScreen = document.getElementById('loading-screen');
      if (loadingScreen) {
        loadingScreen.classList.toggle('visible', Boolean(visible));
      }
      if (document.body) {
        document.body.classList.toggle('loading', Boolean(visible));
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Default to visible until the server tells us to hide it.
      setLoadingScreenVisible(true);
    });

    hytopia.onData(data => {
      console.log('[UI] Received data:', data.type, data);
      switch (data.type) {
        case 'LOADING_SCREEN':
          setLoadingScreenVisible(Boolean(data.visible));
          break;
        case 'POWER_STATS':
          state.power = data.power ?? 0;
          state.gold = data.gold ?? state.gold;
          state.gems = data.gems ?? state.gems;
          state.wins = data.wins ?? state.wins;
          state.rebirths = data.rebirths ?? state.rebirths;
          if (powerValueEl) powerValueEl.textContent = formatNumber(state.power);
          if (moneyValueEl) moneyValueEl.textContent = formatNumber(state.gold);
          if (gemsValueEl) gemsValueEl.textContent = formatNumber(state.gems);
          if (winsValueEl) winsValueEl.textContent = formatNumber(state.wins);
          if (rebirthsValueEl) rebirthsValueEl.textContent = formatNumber(state.rebirths);
          console.log('[UI] Updated stats - power:', state.power, 'gold:', state.gold, 'gems:', state.gems, 'wins:', state.wins, 'rebirths:', state.rebirths);
          break;
        case 'GOLD_STATS':
          state.gold = data.gold ?? 0;
          if (moneyValueEl) moneyValueEl.textContent = formatNumber(state.gold);
          console.log('[UI] Updated gold stats:', state.gold);
          break;
        case 'GEMS_STATS':
          state.gems = data.gems ?? 0;
          if (gemsValueEl) gemsValueEl.textContent = formatNumber(state.gems);
          console.log('[UI] Updated gems stats:', state.gems);
          break;
        case 'WINS_STATS':
          state.wins = data.wins ?? 0;
          if (winsValueEl) winsValueEl.textContent = formatNumber(state.wins);
          console.log('[UI] Updated wins stats:', state.wins);
          break;
        case 'REBIRTHS_STATS':
          state.rebirths = data.rebirths ?? 0;
          if (rebirthsValueEl) rebirthsValueEl.textContent = formatNumber(state.rebirths);
          console.log('[UI] Updated rebirths stats:', state.rebirths);
          break;
        case 'POWER_GAIN':
          console.log('[UI] Processing POWER_GAIN:', data);
          state.power = data.totalPower ?? state.power + (data.amount ?? 0);
          console.log('[UI] New power total:', state.power);
          if (powerValueEl) {
            powerValueEl.textContent = formatNumber(state.power);
            console.log('[UI] Updated power value element');
          } else {
            console.warn('[UI] powerValueEl is null!');
          }
          if (typeof data.amount === 'number' && data.amount > 0) {
            console.log('[UI] Spawning power gain popup:', data.amount, 'at rock position:', data.rockPosition);
            spawnPowerGain(data.amount, data.rockPosition);
          } else {
            console.warn('[UI] Invalid amount for popup:', data.amount);
          }
          break;
        case 'TRAINING_PROMPT':
          // Show or hide the training prompt based on visibility
          state.prompt.visible = data.visible ?? false;
          if (data.visible) {
            // Update prompt data when showing
            state.prompt.rockName = data.rockName || 'Training Rock';
            state.prompt.requirements = data.requirements || { power: 0, rebirths: 0 };
            state.prompt.canTrain = data.canTrain ?? false;
            state.prompt.actionKey = data.actionKey || 'E';
          }
          renderTrainingPrompt();
          break;
        case 'MINING_STATE':
          state.mining.isMining = data.isMining ?? false;
          if (miningHudEl) {
            if (state.mining.isMining) {
              miningHudEl.classList.add('visible');
            } else {
              miningHudEl.classList.remove('visible');
            }
          }
          break;
        case 'MERCHANT_PROXIMITY':
          console.log('[UI] Merchant proximity:', data.inProximity);
          state.gold = data.gold ?? state.gold;
          if (moneyValueEl) moneyValueEl.textContent = formatNumber(state.gold);
          const merchantUI = document.getElementById('merchant-ui');
          if (merchantUI) {
            if (data.inProximity) {
              merchantUI.classList.add('visible');
              if (window.setModalOpen) window.setModalOpen(true);
              updateMerchantUI(data.inventory || {}, data.totalValue || 0, data.gold || 0, data.oreSellValues || {});
            } else {
              merchantUI.classList.remove('visible');
              setTimeout(() => {
                if (window.isAnyModalOpen && !window.isAnyModalOpen()) {
                  if (window.setModalOpen) window.setModalOpen(false);
                }
              }, 10);
            }
          }
          break;
        case 'MINE_RESET_UPGRADE_PROXIMITY':
          console.log('[UI] Mine Reset Upgrade proximity:', data.inProximity);
          state.gold = data.gold ?? state.gold;
          if (moneyValueEl) moneyValueEl.textContent = formatNumber(state.gold);
          const upgradeUI = document.getElementById('mine-reset-upgrade-ui');
          if (upgradeUI) {
            if (data.inProximity) {
              upgradeUI.classList.add('visible');
              if (window.setModalOpen) window.setModalOpen(true);
              updateMineResetUpgradeUI(
                data.hasUpgrade ?? false,
                data.cost ?? 2_000_000,
                data.gold ?? 0
              );
            } else {
              upgradeUI.classList.remove('visible');
              setTimeout(() => {
                if (window.isAnyModalOpen && !window.isAnyModalOpen()) {
                  if (window.setModalOpen) window.setModalOpen(false);
                }
              }, 10);
            }
          }
          break;
        case 'GEM_TRADER_PROXIMITY':
          console.log('[UI] Gem Trader proximity:', data.inProximity);
          state.gems = data.gems ?? state.gems;
          if (gemsValueEl) gemsValueEl.textContent = formatNumber(state.gems);
          const gemTraderUI = document.getElementById('gem-trader-ui');
          if (gemTraderUI) {
            if (data.inProximity) {
              gemTraderUI.classList.add('visible');
              if (window.setModalOpen) window.setModalOpen(true);
              updateGemTraderUI(data.upgrades || {}, data.gems || 0);
            } else {
              gemTraderUI.classList.remove('visible');
              setTimeout(() => {
                if (window.isAnyModalOpen && !window.isAnyModalOpen()) {
                  if (window.setModalOpen) window.setModalOpen(false);
                }
              }, 10);
            }
          }
          break;
        case 'EGG_STATION_PROXIMITY': {
          // Server-driven proximity: show/hide egg modal
          if (!data.inProximity) {
            state.eggStation.inProximity = false;
            state.eggStation.stationId = null;
            state.eggStation.stations = [];
            state.eggStation.eggPets = [];
            state.eggStation.autoDeletePets = [];
            stopEggAuto();
            if (eggModal) hideModal(eggModal);
            break;
          }

          state.eggStation.inProximity = true;
          state.eggStation.stations = Array.isArray(data.stations) ? data.stations : [];
          state.eggStation.stationId = data.station?.id ?? null;
          state.eggStation.stationName = data.station?.name ?? 'Egg Station';
          state.eggStation.eggType = data.station?.eggType ?? 'stone';
          state.eggStation.defaultOpenCount = data.station?.defaultOpenCount ?? 1;
          state.eggStation.costGold = data.station?.costGold ?? 0;
          state.eggStation.eggPets = data.station?.eggPets ?? [];
          state.eggStation.autoDeletePets = data.player?.autoDeletePets ?? [];

          // Update gold + pet counts snapshot (for display)
          if (typeof data.player?.gold === 'number') {
            state.gold = data.player.gold;
            if (moneyValueEl) moneyValueEl.textContent = formatNumber(state.gold);
          }
          if (typeof data.player?.petInventoryCount === 'number') {
            state.pets.ownedCount = data.player.petInventoryCount;
          }
          if (typeof data.player?.petInventoryCap === 'number') {
            state.pets.ownedCap = data.player.petInventoryCap;
          }
          if (typeof data.player?.petEquippedCount === 'number') {
            state.pets.equippedCount = data.player.petEquippedCount;
          }
          if (typeof data.player?.petEquippedCap === 'number') {
            state.pets.equippedCap = data.player.petEquippedCap;
          }

          // Open modal and block manual mining clicks
          if (eggModal && !eggModal.classList.contains('visible')) {
            hytopia.sendData({ type: 'MODAL_OPENED', modalType: 'egg' });
            showModal(eggModal);
            // Refresh pets immediately so inventory/equipped counts are accurate
            hytopia.sendData({ type: 'REQUEST_PET_STATE' });
          }
          renderEggStation();
          break;
        }
        case 'EGG_AUTO_DELETE_LIST':
          state.eggStation.autoDeletePets = Array.isArray(data.autoDeletePets) ? data.autoDeletePets : [];
          renderEggStation();
          break;
        case 'EGG_HATCH_RESULT': {
          if (!data.success) {
            console.log('[UI] Egg hatch failed:', data.message);
            // Stop auto if we can't hatch (insufficient gold, inventory full, etc.)
            stopEggAuto();
            if (eggStationStatusEl) {
              eggStationStatusEl.textContent = data.message || 'Failed';
            }
            resetEggHatchOverlay();
            break;
          }

          state.eggStation.lastHatch = data.results || [];
          if (currentEggHatch) {
            currentEggHatch.results = data.results || [];
            maybeFinishEggHatch();
          }
          if (typeof data.goldSpent === 'number') {
            // GOLD_STATS will also come from server, this just keeps UI snappy if it arrives late
            state.gold = Math.max(0, state.gold - data.goldSpent);
            if (moneyValueEl) moneyValueEl.textContent = formatNumber(state.gold);
          }
          renderEggStation();
          break;
        }
        case 'PET_STATE':
          state.pets.pets = data.pets || [];
          state.pets.ownedCount = data.ownedCount ?? state.pets.ownedCount;
          state.pets.ownedCap = data.ownedCap ?? state.pets.ownedCap;
          state.pets.equippedCount = data.equippedCount ?? state.pets.equippedCount;
          state.pets.equippedCap = data.equippedCap ?? state.pets.equippedCap;
          state.pets.multiplierSum = data.multiplierSum ?? 0;
          state.pets.trainingMultiplier = data.trainingMultiplier ?? 1;
          renderPets();
          // Egg modal also displays pet inventory count, so refresh it too
          renderEggStation();
          break;
        case 'PET_ACTION_RESULT':
          if (!data.success) {
            console.log('[UI] Pet action failed:', data.message);
          }
          break;
        case 'UPGRADE_PURCHASED':
          console.log('[UI] Upgrade purchased:', data);
          state.gems = data.remainingGems ?? state.gems;
          if (gemsValueEl) gemsValueEl.textContent = formatNumber(state.gems);
          // Refresh the UI by requesting updated data (if UI is visible)
          const gemTraderUIVisible = document.getElementById('gem-trader-ui')?.classList.contains('visible');
          if (gemTraderUIVisible && data.success) {
            // Request refresh - in a real implementation, we'd re-request the data
            // For now, the server will send GEM_TRADER_PROXIMITY again to refresh
            console.log('[UI] Upgrade purchased successfully, UI should refresh');
          }
          break;
        case 'MINE_RESET_UPGRADE_PURCHASED':
          console.log('[UI] Mine Reset Upgrade purchase result:', data);
          state.gold = data.remainingGold ?? state.gold;
          if (moneyValueEl) moneyValueEl.textContent = formatNumber(state.gold);
          const upgradeUIVisible = document.getElementById('mine-reset-upgrade-ui')?.classList.contains('visible');
          if (upgradeUIVisible) {
            // Always update with the hasUpgrade flag from server
            updateMineResetUpgradeUI(
              data.hasUpgrade ?? true, // Default to true if purchase was successful
              data.cost ?? 2_000_000,
              data.remainingGold ?? 0
            );
          }
          break;
        case 'INVENTORY_UPDATE':
          console.log('[UI] Inventory update received');
          state.gold = data.gold ?? state.gold;
          if (moneyValueEl) moneyValueEl.textContent = formatNumber(state.gold);
          const merchantUIVisible = document.getElementById('merchant-ui')?.classList.contains('visible');
          if (merchantUIVisible) {
            updateMerchantUI(data.inventory || {}, data.totalValue || 0, data.gold || 0, data.oreSellValues || {});
            if (data.goldEarned && data.goldEarned > 0) {
              // Show gold earned notification
              console.log(`[UI] Gold earned: ${data.goldEarned}`);
            }
          }
          break;
        case 'MINING_UPDATE':
          if (!state.mining.isInMine) {
            break;
          }
          state.mining.damage = data.damage ?? 0;
          state.mining.currentOre = data.currentOreName ?? null;
          const blockHP = data.blockHP ?? 0;
          const maxHP = data.maxHP ?? 100;
          const isChest = data.isChest ?? false;
          const sellValue = data.sellValue ?? null;
          const gemReward = data.gemReward ?? null;
          
          // Spawn damage popup for each mining swing
          if (state.mining.damage > 0) {
            spawnDamagePopup(state.mining.damage);
          }

          // Spawn ore mined popup when block is destroyed (like damage popups)
          if (data.oreMined && data.oreMinedColor) {
            console.log(`[UI] MINING_UPDATE received ore mined: ${data.oreMined}, spawning popup (damage: ${data.damage}, blockHP: ${data.blockHP})`);
            spawnMinedOrePopup(data.oreMined, data.oreMinedColor);
          }

          // Update block health bar (bottom center, above progress bar)
          if (blockHealthBarEl && blockHealthBarNameEl && blockHealthBarFillEl && blockHealthBarTextEl && blockRewardDisplayEl) {
            // Store current block info if valid
            const oreColor = data.oreColor ?? null;
            let currentBlockInfo = null;
            if (state.mining.currentOre && blockHP > 0 && maxHP > 0) {
              currentBlockInfo = {
                name: state.mining.currentOre,
                blockHP: blockHP,
                maxHP: maxHP,
                isChest: isChest,
                sellValue: sellValue,
                gemReward: gemReward,
                color: oreColor // Store color for display
              };
              state.mining.lastBlockInfo = currentBlockInfo; // Update last known block
            }
            
            // Use current block info if available, otherwise use last known block info
            // This prevents UI from disappearing during fast mining transitions
            const displayInfo = currentBlockInfo || state.mining.lastBlockInfo;
            
            if (displayInfo) {
              // Update ALL content FIRST before showing (prevents flicker when switching ores quickly)
              // This ensures the UI never disappears - it just updates content instantly
              blockHealthBarNameEl.textContent = displayInfo.name;
              // Apply ore color if available (for ores, not chests)
              if (!displayInfo.isChest && displayInfo.color) {
                blockHealthBarNameEl.style.color = displayInfo.color;
              } else {
                // Use white for chests or if no color available
                blockHealthBarNameEl.style.color = '#fff';
              }
              blockHealthBarTextEl.textContent = `${formatNumber(Math.floor(displayInfo.blockHP))}/${formatNumber(Math.floor(displayInfo.maxHP))} HP`;
              
              // Calculate fill percentage
              const fillPercent = Math.max(0, Math.min(100, (displayInfo.blockHP / displayInfo.maxHP) * 100));
              blockHealthBarFillEl.style.width = `${fillPercent}%`;
              
              // Update reward display (sell value for ores, gem reward for chests)
              // On mobile, show compact format (icon + number only)
              const isMobile = document.body.classList.contains('mobile');
              if (displayInfo.isChest && displayInfo.gemReward !== null && displayInfo.gemReward > 0) {
                // Display gem reward for chests
                const gemLabel = isMobile ? '' : ' Gems';
                blockRewardDisplayEl.innerHTML = `<span style="color: #4caf50;">ðŸ’Ž</span> <span style="color: #4caf50; font-weight: 700;">${formatNumber(displayInfo.gemReward)}${gemLabel}</span>`;
                blockRewardDisplayEl.style.display = 'flex';
              } else if (!displayInfo.isChest && displayInfo.sellValue !== null && displayInfo.sellValue > 0) {
                // Display sell value for ores
                const goldLabel = isMobile ? '' : ' Gold';
                blockRewardDisplayEl.innerHTML = `<span style="color: #ffd700;">ðŸª™</span> <span style="color: #ffd700; font-weight: 700;">${formatNumber(displayInfo.sellValue)}${goldLabel}</span>`;
                blockRewardDisplayEl.style.display = 'flex';
              } else {
                blockRewardDisplayEl.style.display = 'none';
              }
              
              // Show UI instantly with no transition - ensures UI is always visible
              // Use both class and inline style to override any transitions
              blockHealthBarEl.style.opacity = '1';
              blockHealthBarEl.style.transition = 'none';
              blockHealthBarEl.classList.add('visible');
            } else {
              // Only hide if we truly have no block info at all
              // Clear last known block when leaving mine
              state.mining.lastBlockInfo = null;
              blockHealthBarEl.style.opacity = '0';
              blockHealthBarEl.style.transition = 'none';
              blockHealthBarEl.classList.remove('visible');
              blockRewardDisplayEl.style.display = 'none';
            }
          }
          
          // Old current ore display removed - now using mining target display
          
          // Update damage display (bottom middle right)
          if (damageDisplayEl) {
            if (state.mining.damage > 0) {
              damageDisplayEl.textContent = `${Math.round(state.mining.damage)} Dmg`;
              damageDisplayEl.classList.add('visible');
            } else {
              damageDisplayEl.classList.remove('visible');
            }
          }
          break;
        case 'PROGRESS_UPDATE':
          updateProgressBar(data.currentDepth ?? 0, data.goalDepth ?? 1000);
          break;
        case 'MINING_STATE_UPDATE':
          state.mining.isInMine = data.isInMine ?? false;
          // Show/hide mining controls
          const miningControlsEl = document.getElementById('mining-controls');
          if (miningControlsEl) {
            if (data.isInMine) {
              miningControlsEl.classList.add('visible');
            } else {
              miningControlsEl.classList.remove('visible');
            }
          }
          
          // Clear block health bar when leaving mine
          if (!data.isInMine) {
            // Clear last known block info when leaving mine
            state.mining.lastBlockInfo = null;
            if (blockHealthBarEl) {
              blockHealthBarEl.style.opacity = '0';
              blockHealthBarEl.style.transition = 'none';
              blockHealthBarEl.classList.remove('visible');
            }
            if (blockRewardDisplayEl) {
              blockRewardDisplayEl.style.display = 'none';
            }
            if (damageDisplayEl) {
              damageDisplayEl.classList.remove('visible');
            }
          }
          break;
        case 'MINE_RESET_TIMER':
          // Update mine reset timer display (compact format, icon added via CSS)
          if (mineResetTimerEl && mineResetTimerTextEl) {
            if (data.timeRemaining !== null && data.timeRemaining !== undefined) {
              mineResetTimerTextEl.textContent = data.timeRemaining;
              mineResetTimerEl.classList.add('visible');
            } else {
              mineResetTimerEl.classList.remove('visible');
            }
          }
          break;
        case 'MINING_DEPTH_COUNTER':
          // Update mining depth counter display (shows depth / maxDepth)
          if (miningDepthCounterEl && miningDepthCounterTextEl) {
            const depth = data.depth ?? 0;
            const maxDepth = data.maxDepth ?? 1000;
            if (data.visible !== false) {
              miningDepthCounterTextEl.textContent = `${depth} / ${maxDepth}`;
              miningDepthCounterEl.classList.add('visible');
            } else {
              miningDepthCounterEl.classList.remove('visible');
            }
          }
          break;
        case 'AUTO_MINE_STATE':
          updateAutoMineButton(data.enabled ?? false);
          break;
        case 'AUTO_TRAIN_STATE':
          updateAutoTrainButton(data.enabled ?? false);
          break;
        case 'MINER_SHOP_DATA':
          updateMinerModal(data);
          break;
        case 'MINER_PURCHASED':
          if (data.success) {
            state.gold = data.remainingGold ?? state.gold;
            if (moneyValueEl) moneyValueEl.textContent = formatNumber(state.gold);
            // Refresh miner shop data
            hytopia.sendData({ type: 'OPEN_MINER_SHOP' });
          }
          break;
        case 'MINER_EQUIPPED':
          if (data.success) {
            // Refresh miner shop data and update the detail panel
            hytopia.sendData({ type: 'OPEN_MINER_SHOP' });
            // Also re-render details to update button state
            renderMinerDetails();
          }
          break;
        case 'PICKAXE_SHOP_DATA':
          console.log('[UI] Pickaxe shop data received');
          updatePickaxeModal(data);
          break;
        case 'PICKAXE_PURCHASED':
          console.log('[UI] Pickaxe purchase result:', data);
          if (data.success) {
            state.gold = data.remainingGold ?? state.gold;
            if (moneyValueEl) moneyValueEl.textContent = formatNumber(state.gold);
            // Update pickaxe state
            state.pickaxe.currentTier = data.newTier ?? state.pickaxe.currentTier;
            // Refresh shop data
            hytopia.sendData({ type: 'OPEN_PICKAXE_SHOP' });
          } else {
            console.warn('[UI] Pickaxe purchase failed:', data.message);
            // Could show error message to user here
          }
          break;
        case 'PICKAXE_EQUIPPED':
          console.log('[UI] Pickaxe equip result:', data);
          if (data.success) {
            // Update pickaxe state
            state.pickaxe.currentTier = data.newTier ?? state.pickaxe.currentTier;
            // Refresh shop data to update availability status
            hytopia.sendData({ type: 'OPEN_PICKAXE_SHOP' });
            // Also re-render details to update button state
            renderPickaxeDetails();
          } else {
            console.warn('[UI] Pickaxe equip failed:', data.message);
            // Could show error message to user here
          }
          break;
        case 'REBIRTH_UI_DATA':
          console.log('[UI] Rebirth UI data received');
          updateRebirthModal(data);
          break;
        case 'REBIRTH_COMPLETE':
          console.log('[UI] Rebirth complete:', data);
          if (data.success) {
            state.power = data.newPower ?? state.power;
            state.rebirths = data.newRebirths ?? state.rebirths;
            if (powerValueEl) powerValueEl.textContent = formatNumber(state.power);
            if (rebirthsValueEl) rebirthsValueEl.textContent = formatNumber(state.rebirths);
            // Refresh rebirth UI data
            hytopia.sendData({ type: 'OPEN_REBIRTH_UI' });
          } else {
            console.warn('[UI] Rebirth failed:', data.message);
          }
          break;
        case 'WORLDS_PANEL_DATA':
          console.log('[UI] Worlds panel data received:', data);
          renderMapsList(data.worlds || []);
          break;
        case 'WORLD_UNLOCKED':
          console.log('[UI] World unlocked:', data);
          if (data.success) {
            // Refresh worlds panel data
            hytopia.sendData({ type: 'OPEN_WORLDS_PANEL' });
            if (data.message) {
              // Could show success message here
            }
          } else {
            console.warn('[UI] World unlock failed:', data.message);
            // Could show error message to user here
          }
          break;
        case 'WORLD_TELEPORTED':
          console.log('[UI] World teleported:', data);
          if (data.success) {
            // Close modal on successful teleport
            if (mapsModal) hideModal(mapsModal);
            // Refresh worlds panel data
            hytopia.sendData({ type: 'OPEN_WORLDS_PANEL' });
          } else {
            console.warn('[UI] World teleport failed:', data.message);
            setLoadingScreenVisible(false);
            // Could show error message to user here
          }
          break;
        default:
          console.log('[UI] Unknown event type:', data.type);
        break;
      }
    });
  }
</script>


<!-- Included from: ./components/LoadingScreen.html -->
<!-- Loading Screen -->
<div id="loading-screen" class="loading-screen visible" aria-hidden="true"></div>


<!-- Included from: ./components/MobileControls.html -->
<!-- UI Root Container -->
<div class="ui-root">

<!-- Mobile Controls (hidden) -->
<div class="mobile-controls" style="display: none;">
  <a id="mobile-interact-button" class="mobile-button">
    <img src="{{CDN_ASSETS_URL}}/icons/target.png" />
  </a>

  <a id="mobile-jump-button" class="mobile-button">
    <img src="{{CDN_ASSETS_URL}}/icons/jump.png" />
  </a>
</div>


<!-- Included from: ./components/StatsHUD.html -->
<!-- Stats HUD Container (Middle Right) -->
<div class="stats-hud-container">
  <!-- Trophy (Wins) -->
  <div class="stat-hud stat-hud--wins">
    <div class="stat-hud__value" id="wins-value">0</div>
    <div class="stat-hud__icon">ðŸ†</div>
  </div>

  <!-- Money -->
  <div class="stat-hud stat-hud--money">
    <div class="stat-hud__value" id="money-value">0</div>
    <div class="stat-hud__icon">ðŸ’°</div>
  </div>

  <!-- Gems -->
  <div class="stat-hud stat-hud--gems">
    <div class="stat-hud__value" id="gems-value">0</div>
    <div class="stat-hud__icon">ðŸ’Ž</div>
  </div>

  <!-- Power -->
  <div class="stat-hud stat-hud--power">
    <div class="stat-hud__value" id="power-value">0</div>
    <div class="stat-hud__icon">ðŸ’¥</div>
  </div>

  <!-- Rebirths -->
  <div class="stat-hud stat-hud--rebirths">
    <div class="stat-hud__value" id="rebirths-value">0</div>
    <div class="stat-hud__icon">ðŸ”„</div>
  </div>
</div>


<!-- Included from: ./components/LeftActions.html -->
<!-- Left-side action buttons -->
<div class="left-actions">
  <button id="miner-button" class="action-card action-card--miner">
    <span class="action-card__icon">â›‘ï¸</span>
  </button>
  <button id="pickaxe-button" class="action-card action-card--pickaxe">
    <span class="action-card__icon">â›ï¸</span>
  </button>
  <button id="rebirth-button" class="action-card action-card--rebirth">
    <span class="action-card__icon">ðŸ”</span>
    <span class="action-card__badge" id="rebirth-badge" hidden>!</span>
  </button>
  <button id="pets-button" class="action-card action-card--pets">
    <span class="action-card__icon">ðŸ¾</span>
  </button>
  <button id="maps-button" class="action-card action-card--maps">
    <span class="action-card__icon">ðŸ—ºï¸</span>
  </button>
</div>


<!-- Included from: ./components/MinerModal.html -->
<!-- Miner Shop Modal -->
<div
  id="miner-modal"
  class="hud"
  style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.6);
    z-index: 11000;
  "
>
  <div class="miner-wrapper">
    <!-- Title container -->
    <div class="miner-title-container">
      <h2 class="miner-title">MINERS</h2>
    </div>
    <!-- Close button -->
    <button id="miner-close-btn" class="miner-close-btn">X</button>

    <div class="miner-container">
      <div class="miner-content-wrapper">
        <!-- Left Side: Equipped Miner Details -->
        <div class="miner-left-panel">
          <div class="miner-details">
            <div class="miner-details__preview">
              <div id="miner-detail-icon" class="miner-details__icon-wrapper">
                <img id="miner-detail-icon-img" class="miner-details__icon-img" src="" alt="" style="display: none;" />
                <span id="miner-detail-icon-emoji" class="miner-details__icon-emoji"></span>
              </div>
            </div>
            <div id="miner-detail-name" class="miner-details__name">Select a Miner</div>
            <div id="miner-detail-stats" class="miner-details__stats"></div>
            <button id="miner-action-button" class="miner-details__action-btn">Select</button>
          </div>
        </div>

        <!-- Right Side: Miner Grid -->
        <div class="miner-right-panel">
          <div class="miner-grid-container">
            <div id="miner-grid" class="miner-grid">
              <!-- Miner cards populated dynamically -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Support for .visible class from legacy code */
  #miner-modal.visible {
    display: flex !important;
  }

  .miner-wrapper {
    position: relative;
    width: 900px;
    max-width: 95vw;
    font-family: "Fredoka", sans-serif;
    margin-top: 40px;
  }

  .miner-container {
    background: linear-gradient(
      180deg,
      rgba(30, 30, 40, 0.95),
      rgba(20, 20, 30, 0.95)
    );
    border: 3px solid rgba(139, 69, 19, 0.9);
    border-radius: 16px;
    padding: 0;
    width: 100%;
    min-height: 70vh;
    max-height: 75vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.65);
    overflow: hidden;
    animation: minerSlideInUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .miner-wrapper.closing .miner-container {
    animation: minerSlideOutDown 0.4s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards;
  }

  @keyframes minerSlideInUp {
    from {
      opacity: 0;
      transform: translateY(60px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  @keyframes minerSlideOutDown {
    from {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
    to {
      opacity: 0;
      transform: translateY(60px) scale(0.95);
    }
  }

  .miner-title-container {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 100;
    background: linear-gradient(
      135deg,
      rgba(180, 120, 60, 0.95),
      rgba(140, 90, 45, 0.95)
    );
    border: 3px solid rgba(255, 215, 0, 0.8);
    border-radius: 12px;
    padding: 8px 24px;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.7);
  }

  .miner-title {
    font-size: 24px;
    font-weight: 900;
    color: #fff;
    margin: 0;
    -webkit-text-stroke: 2px #000;
    paint-order: stroke fill;
  }

  .miner-close-btn {
    position: absolute;
    top: 0;
    right: 0;
    transform: translate(50%, -50%);
    background: linear-gradient(
      135deg,
      rgba(255, 71, 87, 0.95),
      rgba(220, 50, 65, 0.95)
    );
    border: 3px solid rgba(255, 71, 87, 1);
    color: #fff;
    font-size: 18px;
    font-weight: 700;
    width: 40px;
    height: 40px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    z-index: 100;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.7);
  }

  .miner-close-btn:hover {
    background: linear-gradient(
      135deg,
      rgba(255, 91, 107, 1),
      rgba(240, 60, 75, 1)
    );
    border-color: #ff4757;
    transform: translate(50%, -50%) scale(1.1);
  }

  .miner-content-wrapper {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* Left Panel - Details */
  .miner-left-panel {
    width: 220px;
    min-width: 220px;
    display: flex;
    flex-direction: column;
    padding: 12px;
    background: linear-gradient(
      180deg,
      rgba(40, 35, 30, 0.9),
      rgba(30, 25, 20, 0.9)
    );
    border-right: 2px solid rgba(139, 69, 19, 0.5);
  }

  .miner-details {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    height: 100%;
  }

  .miner-details__preview {
    background: rgba(0, 0, 0, 0.4);
    border: 2px solid rgba(139, 69, 19, 0.5);
    border-radius: 12px;
    width: 140px;
    height: 140px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .miner-details__preview:hover {
    border-color: rgba(255, 215, 0, 0.6);
    box-shadow: 0 0 12px rgba(255, 215, 0, 0.3);
  }

  .miner-details__icon-wrapper {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .miner-details__icon-img {
    max-width: 120px;
    max-height: 120px;
    object-fit: contain;
    image-rendering: pixelated;
  }

  .miner-details__icon-emoji {
    font-size: 80px;
  }

  .miner-details__name {
    font-size: 18px;
    font-weight: 700;
    color: #fff;
    text-align: center;
    -webkit-text-stroke: 1px #000;
    paint-order: stroke fill;
  }

  .miner-details__stats {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
    padding: 12px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    border: 1px solid rgba(139, 69, 19, 0.3);
  }

  .miner-stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    color: #fff;
  }

  .miner-stat-row__label {
    color: #a6b7d3;
    font-weight: 600;
  }

  .miner-stat-row__value {
    font-weight: 700;
  }

  .miner-stat-row__value--power { color: #ff5252; }
  .miner-stat-row__value--speed { color: #87ceeb; }
  .miner-stat-row__value--sell { color: #ffd700; }
  .miner-stat-row__value--cost { color: #ffd700; }

  .miner-details__action-btn {
    width: 100%;
    padding: 12px 16px;
    margin-top: auto;
    border-radius: 8px;
    border: 2px solid rgba(139, 69, 19, 0.6);
    font-size: 14px;
    font-weight: 700;
    font-family: "Fredoka", sans-serif;
    cursor: pointer;
    transition: all 0.2s ease;
    background: linear-gradient(180deg, #ffd700, #ffb700);
    color: #000;
    border-color: rgba(255, 215, 0, 0.9);
  }

  .miner-details__action-btn:hover:not(:disabled) {
    background: linear-gradient(180deg, #ffed4e, #ffd700);
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
    transform: translateY(-2px);
  }

  .miner-details__action-btn:disabled {
    background: linear-gradient(
      180deg,
      rgba(100, 100, 100, 0.5),
      rgba(80, 80, 80, 0.5)
    );
    border-color: rgba(100, 100, 100, 0.5);
    color: #666;
    cursor: not-allowed;
  }

  .miner-details__action-btn--equipped {
    background: linear-gradient(180deg, #00d26a, #00a854);
    border-color: rgba(0, 210, 106, 0.9);
    color: #fff;
  }

  .miner-details__action-btn--equipped:hover {
    background: linear-gradient(180deg, #00e673, #00b35c);
    box-shadow: 0 4px 12px rgba(0, 210, 106, 0.4);
  }

  /* Right Panel - Grid */
  .miner-right-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 16px;
    background: rgba(0, 0, 0, 0.3);
    overflow: hidden;
  }

  .miner-grid-container {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding-right: 4px;
    min-height: 0;
  }

  .miner-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 12px;
    padding: 4px;
  }

  .miner-card {
    background: linear-gradient(
      180deg,
      rgba(60, 50, 40, 0.7),
      rgba(40, 35, 30, 0.7)
    );
    border: 2px solid rgba(139, 69, 19, 0.5);
    border-radius: 10px;
    padding: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 120px;
  }

  .miner-card:hover {
    background: linear-gradient(
      180deg,
      rgba(80, 65, 50, 0.8),
      rgba(50, 40, 30, 0.8)
    );
    border-color: rgba(255, 215, 0, 0.6);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  }

  .miner-card.selected {
    background: linear-gradient(
      180deg,
      rgba(255, 215, 0, 0.3),
      rgba(255, 165, 0, 0.3)
    );
    border-color: #ffd700;
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
  }

  .miner-card.equipped {
    border-color: #00d26a;
  }

  .miner-card.locked {
    opacity: 0.5;
    filter: grayscale(0.5);
  }

  .miner-card__equipped-badge {
    position: absolute;
    top: 4px;
    left: 4px;
    background: #00d26a;
    color: #fff;
    font-size: 12px;
    font-weight: 700;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
  }

  .miner-card__lock-badge {
    position: absolute;
    top: 4px;
    right: 4px;
    font-size: 16px;
  }

  .miner-card__icon {
    width: 56px;
    height: 56px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .miner-card__icon-img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    image-rendering: pixelated;
  }

  .miner-card__icon-emoji {
    font-size: 40px;
  }

  .miner-card__name {
    font-size: 12px;
    font-weight: 600;
    color: #fff;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
  }

  .miner-card__cost {
    font-size: 11px;
    color: #ffd700;
    font-weight: 700;
  }

  .miner-empty {
    grid-column: 1 / -1;
    text-align: center;
    color: #cdd8f3;
    padding: 60px 0;
    font-weight: 700;
  }

  /* Scrollbar styling */
  .miner-grid-container::-webkit-scrollbar {
    width: 8px;
  }

  .miner-grid-container::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 4px;
  }

  .miner-grid-container::-webkit-scrollbar-thumb {
    background: rgba(139, 69, 19, 0.6);
    border-radius: 4px;
  }

  .miner-grid-container::-webkit-scrollbar-thumb:hover {
    background: rgba(139, 69, 19, 0.8);
  }

  /* Mobile scrolling support */
  body.mobile .miner-right-panel,
  body.mobile .miner-right-panel *,
  body.mobile .miner-grid-container,
  body.mobile .miner-grid {
    touch-action: pan-y !important;
    -webkit-overflow-scrolling: touch !important;
  }

  /* Mobile-specific responsive styles */
  body.mobile .miner-wrapper {
    margin-top: 20px;
  }

  body.mobile .miner-container {
    min-height: 70vh;
    max-height: 75vh;
  }

  body.mobile .miner-title-container {
    padding: 6px 16px;
  }

  body.mobile .miner-title {
    font-size: 18px;
    -webkit-text-stroke: 1.5px #000;
  }

  body.mobile .miner-close-btn {
    width: 36px;
    height: 36px;
    font-size: 16px;
  }

  /* Mobile: Keep vertical layout (left/right) with adjusted sizes */
  body.mobile .miner-left-panel {
    width: 180px;
    min-width: 180px;
    padding: 10px;
  }

  body.mobile .miner-details {
    gap: 8px;
  }

  body.mobile .miner-details__preview {
    width: 100px;
    height: 100px;
  }

  body.mobile .miner-details__icon-img {
    max-width: 80px;
    max-height: 80px;
  }

  body.mobile .miner-details__icon-emoji {
    font-size: 48px;
  }

  body.mobile .miner-details__name {
    font-size: 13px;
  }

  body.mobile .miner-details__stats {
    padding: 6px;
    gap: 3px;
  }

  body.mobile .miner-stat-row {
    font-size: 10px;
  }

  body.mobile .miner-details__action-btn {
    padding: 8px 10px;
    font-size: 11px;
  }

  body.mobile .miner-right-panel {
    padding: 10px;
  }

  body.mobile .miner-grid {
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    gap: 6px;
  }

  body.mobile .miner-card {
    min-height: 90px;
    padding: 6px;
  }

  body.mobile .miner-card__icon {
    width: 40px;
    height: 40px;
    margin-bottom: 4px;
  }

  body.mobile .miner-card__icon-emoji {
    font-size: 28px;
  }

  body.mobile .miner-card__name {
    font-size: 9px;
  }

  body.mobile .miner-card__cost {
    font-size: 8px;
  }
</style>

<script>
  (function() {
    const minerOverlay = document.getElementById("miner-modal");
    const minerGrid = document.getElementById("miner-grid");
    const minerCloseBtn = document.getElementById("miner-close-btn");
    const minerActionBtn = document.getElementById("miner-action-button");
    const minerDetailIconImg = document.getElementById("miner-detail-icon-img");
    const minerDetailIconEmoji = document.getElementById("miner-detail-icon-emoji");
    const minerDetailName = document.getElementById("miner-detail-name");
    const minerDetailStats = document.getElementById("miner-detail-stats");

    let minerData = null;
    let miners = [];
    let selectedMinerId = null;
    let equippedMinerId = null;
    let playerGold = 0;

    function openMinerModal() {
      minerOverlay.style.display = "flex";
      selectedMinerId = null;

      const wrapper = document.querySelector(".miner-wrapper");
      wrapper.classList.remove("closing");
      void wrapper.offsetWidth;

      hytopia.lockPointer(false, true);
      hytopia.sendData({ type: "GET_MINER_SHOP_DATA" });
      if (window.setModalOpen) window.setModalOpen(true);
    }

    function closeMinerModal() {
      const wrapper = document.querySelector(".miner-wrapper");
      wrapper.classList.add("closing");

      setTimeout(() => {
        minerOverlay.style.display = "none";
        minerOverlay.classList.remove("visible");
        wrapper.classList.remove("closing");
      }, 400);

      hytopia.lockPointer(true);
      if (window.setModalOpen) window.setModalOpen(false);
    }

    function renderMinerGrid(data) {
      minerData = data;
      miners = data.miners || [];
      equippedMinerId = data.equippedMinerId;
      playerGold = data.gold || 0;

      if (miners.length === 0) {
        minerGrid.innerHTML = '<div class="miner-empty">No miners available.</div>';
        renderMinerDetails(null);
        return;
      }

      // Auto-select equipped miner or first one
      if (!selectedMinerId) {
        selectedMinerId = equippedMinerId || miners[0].id;
      }

      minerGrid.innerHTML = miners.map(miner => {
        const isSelected = miner.id === selectedMinerId;
        const isEquipped = miner.id === equippedMinerId;
        const isOwned = miner.owned;
        const isLocked = !isOwned && miner.cost > playerGold;

        const cdn = (window.CDN_ASSETS_URL || "").replace(/\/$/, "");
        const iconPath = miner.icon ? (cdn ? `${cdn}/${miner.icon}` : `../${miner.icon}`) : null;

        return `
          <div class="miner-card ${isSelected ? 'selected' : ''} ${isEquipped ? 'equipped' : ''} ${isLocked && !isOwned ? 'locked' : ''}"
               data-id="${miner.id}">
            ${isEquipped ? '<div class="miner-card__equipped-badge">+</div>' : ''}
            ${!isOwned && isLocked ? '<div class="miner-card__lock-badge">*</div>' : ''}
            <div class="miner-card__icon">
              ${iconPath
                ? `<img src="${iconPath}" alt="${miner.name}" class="miner-card__icon-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" /><span class="miner-card__icon-emoji" style="display:none;">&#x26d1;&#xfe0f;</span>`
                : `<span class="miner-card__icon-emoji">&#x26d1;&#xfe0f;</span>`
              }
            </div>
            <div class="miner-card__name">${miner.name}</div>
            <div class="miner-card__cost">${isOwned ? 'Owned' : `${formatNumber(miner.cost)} Gold`}</div>
          </div>
        `;
      }).join('');

      // Add click handlers
      minerGrid.querySelectorAll('.miner-card').forEach(card => {
        if (typeof window.attachClickSounds === "function") {
          window.attachClickSounds(card);
        }

        card.addEventListener('click', () => {
          const id = card.dataset.id;
          selectedMinerId = id;

          minerGrid.querySelectorAll('.miner-card').forEach(c => {
            c.classList.toggle('selected', c.dataset.id === id);
          });

          const miner = miners.find(m => m.id === id);
          renderMinerDetails(miner);
        });
      });

      // Render selected miner details
      const selectedMiner = miners.find(m => m.id === selectedMinerId);
      renderMinerDetails(selectedMiner);
    }

    function renderMinerDetails(miner) {
      if (!miner) {
        minerDetailIconImg.style.display = "none";
        minerDetailIconEmoji.style.display = "block";
        minerDetailIconEmoji.textContent = "?";
        minerDetailName.textContent = "Select a Miner";
        minerDetailStats.innerHTML = "";
        minerActionBtn.textContent = "Select";
        minerActionBtn.disabled = true;
        return;
      }

      const cdn = (window.CDN_ASSETS_URL || "").replace(/\/$/, "");
      const iconPath = miner.icon ? (cdn ? `${cdn}/${miner.icon}` : `../${miner.icon}`) : null;

      if (iconPath) {
        minerDetailIconImg.src = iconPath;
        minerDetailIconImg.style.display = "block";
        minerDetailIconEmoji.style.display = "none";
      } else {
        minerDetailIconImg.style.display = "none";
        minerDetailIconEmoji.style.display = "block";
        minerDetailIconEmoji.innerHTML = "&#x26d1;&#xfe0f;";
      }

      minerDetailName.textContent = miner.name;

      // Build stats HTML
      let statsHtml = '';
      if (miner.sellMultiplier) {
        statsHtml += `<div class="miner-stat-row"><span class="miner-stat-row__label">Sell Bonus</span><span class="miner-stat-row__value miner-stat-row__value--sell">x${miner.sellMultiplier}</span></div>`;
      }
      if (miner.speedBonus) {
        statsHtml += `<div class="miner-stat-row"><span class="miner-stat-row__label">Speed Bonus</span><span class="miner-stat-row__value miner-stat-row__value--speed">+${miner.speedBonus}%</span></div>`;
      }
      if (miner.powerBonus) {
        statsHtml += `<div class="miner-stat-row"><span class="miner-stat-row__label">Power Bonus</span><span class="miner-stat-row__value miner-stat-row__value--power">+${formatNumber(miner.powerBonus)}</span></div>`;
      }
      if (!miner.owned) {
        statsHtml += `<div class="miner-stat-row"><span class="miner-stat-row__label">Cost</span><span class="miner-stat-row__value miner-stat-row__value--cost">${formatNumber(miner.cost)} Gold</span></div>`;
      }

      minerDetailStats.innerHTML = statsHtml;

      // Update action button
      const isEquipped = miner.id === equippedMinerId;
      const isOwned = miner.owned;
      const canAfford = playerGold >= miner.cost;

      if (isEquipped) {
        minerActionBtn.textContent = "Equipped";
        minerActionBtn.disabled = true;
        minerActionBtn.className = "miner-details__action-btn miner-details__action-btn--equipped";
      } else if (isOwned) {
        minerActionBtn.textContent = "Equip";
        minerActionBtn.disabled = false;
        minerActionBtn.className = "miner-details__action-btn";
      } else if (canAfford) {
        minerActionBtn.textContent = `Buy for ${formatNumber(miner.cost)} Gold`;
        minerActionBtn.disabled = false;
        minerActionBtn.className = "miner-details__action-btn";
      } else {
        minerActionBtn.textContent = `Need ${formatNumber(miner.cost - playerGold)} more Gold`;
        minerActionBtn.disabled = true;
        minerActionBtn.className = "miner-details__action-btn";
      }
    }

    function formatNumber(num) {
      if (num >= 1e12) return (num / 1e12).toFixed(1) + "T";
      if (num >= 1e9) return (num / 1e9).toFixed(1) + "B";
      if (num >= 1e6) return (num / 1e6).toFixed(1) + "M";
      if (num >= 1e3) return (num / 1e3).toFixed(1) + "K";
      return num.toString();
    }

    // Event listeners
    minerCloseBtn?.addEventListener("click", closeMinerModal);

    minerActionBtn?.addEventListener("click", () => {
      if (!selectedMinerId || minerActionBtn.disabled) return;

      const miner = miners.find(m => m.id === selectedMinerId);
      if (!miner) return;

      if (miner.owned) {
        hytopia.sendData({
          type: "EQUIP_MINER",
          payload: { minerId: selectedMinerId }
        });
      } else {
        hytopia.sendData({
          type: "BUY_MINER",
          payload: { minerId: selectedMinerId }
        });
      }
    });

    // Close when clicking outside
    minerOverlay?.addEventListener("click", (e) => {
      if (e.target === minerOverlay) {
        closeMinerModal();
      }
    });

    // Keyboard shortcuts
    document.addEventListener("keydown", (e) => {
      if (minerOverlay.style.display !== "flex") return;
      if (e.key === "Escape") {
        closeMinerModal();
        e.preventDefault();
        e.stopPropagation();
      }
    });

    // Attach click sounds
    if (typeof window.attachClickSounds === "function") {
      window.attachClickSounds(minerCloseBtn);
      window.attachClickSounds(minerActionBtn);
    }

    // Listen for data events
    hytopia.onData((data) => {
      if (data?.type === "MINER_SHOP_DATA") {
        renderMinerGrid(data.payload);
      }

      if (data?.type === "OPEN_MINER_MODAL") {
        openMinerModal();
      }

      if (data?.type === "MINER_PURCHASE_SUCCESS" || data?.type === "MINER_EQUIP_SUCCESS") {
        hytopia.sendData({ type: "GET_MINER_SHOP_DATA" });
      }
    });

    // Expose globally
    window.openMinerModal = openMinerModal;
    window.closeMinerModal = closeMinerModal;
  })();
</script>


<!-- Included from: ./components/PickaxeModal.html -->
<!-- Pickaxe Shop Modal -->
<div
  id="pickaxe-modal"
  class="hud"
  style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.6);
    z-index: 11000;
  "
>
  <div class="pickaxe-wrapper">
    <!-- Title container -->
    <div class="pickaxe-title-container">
      <h2 class="pickaxe-title">PICKAXES</h2>
    </div>
    <!-- Close button -->
    <button id="pickaxe-close-btn" class="pickaxe-close-btn">X</button>

    <div class="pickaxe-container">
      <div class="pickaxe-content-wrapper">
        <!-- Left Side: Equipped Pickaxe Details -->
        <div class="pickaxe-left-panel">
          <div class="pickaxe-details">
            <div class="pickaxe-details__preview">
              <div id="pickaxe-detail-icon" class="pickaxe-details__icon-wrapper">
                <img id="pickaxe-detail-icon-img" class="pickaxe-details__icon-img" src="" alt="" style="display: none;" />
                <span id="pickaxe-detail-icon-emoji" class="pickaxe-details__icon-emoji"></span>
              </div>
            </div>
            <div id="pickaxe-detail-name" class="pickaxe-details__name">Select a Pickaxe</div>
            <div id="pickaxe-detail-stats" class="pickaxe-details__stats"></div>
            <button id="pickaxe-action-button" class="pickaxe-details__action-btn">Select</button>
          </div>
        </div>

        <!-- Right Side: Pickaxe Grid -->
        <div class="pickaxe-right-panel">
          <div class="pickaxe-grid-container">
            <div id="pickaxe-grid" class="pickaxe-grid">
              <!-- Pickaxe cards populated dynamically -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Support for .visible class from legacy code */
  #pickaxe-modal.visible {
    display: flex !important;
  }

  .pickaxe-wrapper {
    position: relative;
    width: 900px;
    max-width: 95vw;
    font-family: "Fredoka", sans-serif;
    margin-top: 40px;
  }

  .pickaxe-container {
    background: linear-gradient(
      180deg,
      rgba(30, 30, 40, 0.95),
      rgba(20, 20, 30, 0.95)
    );
    border: 3px solid rgba(139, 69, 19, 0.9);
    border-radius: 16px;
    padding: 0;
    width: 100%;
    min-height: 70vh;
    max-height: 75vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.65);
    overflow: hidden;
    animation: pickaxeSlideInUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .pickaxe-wrapper.closing .pickaxe-container {
    animation: pickaxeSlideOutDown 0.4s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards;
  }

  @keyframes pickaxeSlideInUp {
    from {
      opacity: 0;
      transform: translateY(60px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  @keyframes pickaxeSlideOutDown {
    from {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
    to {
      opacity: 0;
      transform: translateY(60px) scale(0.95);
    }
  }

  .pickaxe-title-container {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 100;
    background: linear-gradient(
      135deg,
      rgba(180, 120, 60, 0.95),
      rgba(140, 90, 45, 0.95)
    );
    border: 3px solid rgba(255, 215, 0, 0.8);
    border-radius: 12px;
    padding: 8px 24px;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.7);
  }

  .pickaxe-title {
    font-size: 24px;
    font-weight: 900;
    color: #fff;
    margin: 0;
    -webkit-text-stroke: 2px #000;
    paint-order: stroke fill;
  }

  .pickaxe-close-btn {
    position: absolute;
    top: 0;
    right: 0;
    transform: translate(50%, -50%);
    background: linear-gradient(
      135deg,
      rgba(255, 71, 87, 0.95),
      rgba(220, 50, 65, 0.95)
    );
    border: 3px solid rgba(255, 71, 87, 1);
    color: #fff;
    font-size: 18px;
    font-weight: 700;
    width: 40px;
    height: 40px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    z-index: 100;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.7);
  }

  .pickaxe-close-btn:hover {
    background: linear-gradient(
      135deg,
      rgba(255, 91, 107, 1),
      rgba(240, 60, 75, 1)
    );
    border-color: #ff4757;
    transform: translate(50%, -50%) scale(1.1);
  }

  .pickaxe-content-wrapper {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* Left Panel - Details */
  .pickaxe-left-panel {
    width: 220px;
    min-width: 220px;
    display: flex;
    flex-direction: column;
    padding: 12px;
    background: linear-gradient(
      180deg,
      rgba(40, 35, 30, 0.9),
      rgba(30, 25, 20, 0.9)
    );
    border-right: 2px solid rgba(139, 69, 19, 0.5);
  }

  .pickaxe-details {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    height: 100%;
  }

  .pickaxe-details__preview {
    background: rgba(0, 0, 0, 0.4);
    border: 2px solid rgba(139, 69, 19, 0.5);
    border-radius: 12px;
    width: 140px;
    height: 140px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .pickaxe-details__preview:hover {
    border-color: rgba(255, 215, 0, 0.6);
    box-shadow: 0 0 12px rgba(255, 215, 0, 0.3);
  }

  .pickaxe-details__icon-wrapper {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .pickaxe-details__icon-img {
    max-width: 120px;
    max-height: 120px;
    object-fit: contain;
    image-rendering: pixelated;
  }

  .pickaxe-details__icon-emoji {
    font-size: 80px;
  }

  .pickaxe-details__name {
    font-size: 18px;
    font-weight: 700;
    color: #fff;
    text-align: center;
    -webkit-text-stroke: 1px #000;
    paint-order: stroke fill;
  }

  .pickaxe-details__stats {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
    padding: 12px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    border: 1px solid rgba(139, 69, 19, 0.3);
  }

  .pickaxe-stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: #fff;
  }

  .pickaxe-stat-row__label {
    color: #a6b7d3;
    font-weight: 600;
  }

  .pickaxe-stat-row__value {
    font-weight: 700;
  }

  .pickaxe-stat-row__value--power { color: #ff5252; }
  .pickaxe-stat-row__value--luck { color: #4caf50; }
  .pickaxe-stat-row__value--speed { color: #87ceeb; }
  .pickaxe-stat-row__value--damage { color: #ffd700; }
  .pickaxe-stat-row__value--sell { color: #ffd700; }
  .pickaxe-stat-row__value--cost { color: #ffd700; }

  .pickaxe-details__action-btn {
    width: 100%;
    padding: 12px 16px;
    margin-top: auto;
    border-radius: 8px;
    border: 2px solid rgba(139, 69, 19, 0.6);
    font-size: 14px;
    font-weight: 700;
    font-family: "Fredoka", sans-serif;
    cursor: pointer;
    transition: all 0.2s ease;
    background: linear-gradient(180deg, #ffd700, #ffb700);
    color: #000;
    border-color: rgba(255, 215, 0, 0.9);
  }

  .pickaxe-details__action-btn:hover:not(:disabled) {
    background: linear-gradient(180deg, #ffed4e, #ffd700);
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
    transform: translateY(-2px);
  }

  .pickaxe-details__action-btn:disabled {
    background: linear-gradient(
      180deg,
      rgba(100, 100, 100, 0.5),
      rgba(80, 80, 80, 0.5)
    );
    border-color: rgba(100, 100, 100, 0.5);
    color: #666;
    cursor: not-allowed;
  }

  .pickaxe-details__action-btn--equipped {
    background: linear-gradient(180deg, #00d26a, #00a854);
    border-color: rgba(0, 210, 106, 0.9);
    color: #fff;
  }

  .pickaxe-details__action-btn--equipped:hover {
    background: linear-gradient(180deg, #00e673, #00b35c);
    box-shadow: 0 4px 12px rgba(0, 210, 106, 0.4);
  }

  /* Right Panel - Grid */
  .pickaxe-right-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 16px;
    background: rgba(0, 0, 0, 0.3);
    overflow: hidden;
  }

  .pickaxe-grid-container {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding-right: 4px;
    min-height: 0;
  }

  .pickaxe-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 12px;
    padding: 4px;
  }

  .pickaxe-card {
    background: linear-gradient(
      180deg,
      rgba(60, 50, 40, 0.7),
      rgba(40, 35, 30, 0.7)
    );
    border: 2px solid rgba(139, 69, 19, 0.5);
    border-radius: 10px;
    padding: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 120px;
  }

  .pickaxe-card:hover {
    background: linear-gradient(
      180deg,
      rgba(80, 65, 50, 0.8),
      rgba(50, 40, 30, 0.8)
    );
    border-color: rgba(255, 215, 0, 0.6);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  }

  .pickaxe-card.selected {
    background: linear-gradient(
      180deg,
      rgba(255, 215, 0, 0.3),
      rgba(255, 165, 0, 0.3)
    );
    border-color: #ffd700;
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
  }

  .pickaxe-card.equipped {
    border-color: #00d26a;
  }

  .pickaxe-card.locked {
    opacity: 0.5;
    filter: grayscale(0.5);
  }

  .pickaxe-card__equipped-badge {
    position: absolute;
    top: 4px;
    left: 4px;
    background: #00d26a;
    color: #fff;
    font-size: 12px;
    font-weight: 700;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
  }

  .pickaxe-card__lock-badge {
    position: absolute;
    top: 4px;
    right: 4px;
    font-size: 16px;
  }

  .pickaxe-card__icon {
    width: 56px;
    height: 56px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .pickaxe-card__icon-img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    image-rendering: pixelated;
  }

  .pickaxe-card__icon-emoji {
    font-size: 40px;
  }

  .pickaxe-card__name {
    font-size: 12px;
    font-weight: 600;
    color: #fff;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
  }

  .pickaxe-card__cost {
    font-size: 11px;
    color: #ffd700;
    font-weight: 700;
  }

  .pickaxe-empty {
    grid-column: 1 / -1;
    text-align: center;
    color: #cdd8f3;
    padding: 60px 0;
    font-weight: 700;
  }

  /* Scrollbar styling */
  .pickaxe-grid-container::-webkit-scrollbar {
    width: 8px;
  }

  .pickaxe-grid-container::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 4px;
  }

  .pickaxe-grid-container::-webkit-scrollbar-thumb {
    background: rgba(139, 69, 19, 0.6);
    border-radius: 4px;
  }

  .pickaxe-grid-container::-webkit-scrollbar-thumb:hover {
    background: rgba(139, 69, 19, 0.8);
  }

  /* Mobile scrolling support */
  body.mobile .pickaxe-right-panel,
  body.mobile .pickaxe-right-panel *,
  body.mobile .pickaxe-grid-container,
  body.mobile .pickaxe-grid {
    touch-action: pan-y !important;
    -webkit-overflow-scrolling: touch !important;
  }

  /* Mobile-specific responsive styles */
  body.mobile .pickaxe-wrapper {
    margin-top: 20px;
  }

  body.mobile .pickaxe-container {
    min-height: 70vh;
    max-height: 75vh;
  }

  body.mobile .pickaxe-title-container {
    padding: 6px 16px;
  }

  body.mobile .pickaxe-title {
    font-size: 18px;
    -webkit-text-stroke: 1.5px #000;
  }

  body.mobile .pickaxe-close-btn {
    width: 36px;
    height: 36px;
    font-size: 16px;
  }

  /* Mobile: Keep vertical layout (left/right) with adjusted sizes */
  body.mobile .pickaxe-left-panel {
    width: 180px;
    min-width: 180px;
    padding: 10px;
  }

  body.mobile .pickaxe-details {
    gap: 8px;
  }

  body.mobile .pickaxe-details__preview {
    width: 100px;
    height: 100px;
  }

  body.mobile .pickaxe-details__icon-img {
    max-width: 80px;
    max-height: 80px;
  }

  body.mobile .pickaxe-details__icon-emoji {
    font-size: 48px;
  }

  body.mobile .pickaxe-details__name {
    font-size: 13px;
  }

  body.mobile .pickaxe-details__stats {
    padding: 6px;
    gap: 3px;
  }

  body.mobile .pickaxe-stat-row {
    font-size: 10px;
  }

  body.mobile .pickaxe-details__action-btn {
    padding: 8px 10px;
    font-size: 11px;
  }

  body.mobile .pickaxe-right-panel {
    padding: 10px;
  }

  body.mobile .pickaxe-grid {
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    gap: 6px;
  }

  body.mobile .pickaxe-card {
    min-height: 85px;
    padding: 6px;
  }

  body.mobile .pickaxe-card__icon {
    width: 36px;
    height: 36px;
    margin-bottom: 4px;
  }

  body.mobile .pickaxe-card__icon-emoji {
    font-size: 26px;
  }

  body.mobile .pickaxe-card__name {
    font-size: 9px;
  }

  body.mobile .pickaxe-card__cost {
    font-size: 8px;
  }
</style>

<script>
  (function() {
    const pickaxeOverlay = document.getElementById("pickaxe-modal");
    const pickaxeGrid = document.getElementById("pickaxe-grid");
    const pickaxeCloseBtn = document.getElementById("pickaxe-close-btn");
    const pickaxeActionBtn = document.getElementById("pickaxe-action-button");
    const pickaxeDetailIcon = document.getElementById("pickaxe-detail-icon");
    const pickaxeDetailIconImg = document.getElementById("pickaxe-detail-icon-img");
    const pickaxeDetailIconEmoji = document.getElementById("pickaxe-detail-icon-emoji");
    const pickaxeDetailName = document.getElementById("pickaxe-detail-name");
    const pickaxeDetailStats = document.getElementById("pickaxe-detail-stats");

    let pickaxeData = null;
    let pickaxes = [];
    let selectedPickaxeId = null;
    let equippedPickaxeId = null;
    let playerGold = 0;

    function openPickaxeModal() {
      pickaxeOverlay.style.display = "flex";
      selectedPickaxeId = null;

      const wrapper = document.querySelector(".pickaxe-wrapper");
      wrapper.classList.remove("closing");
      void wrapper.offsetWidth;

      hytopia.lockPointer(false, true);
      hytopia.sendData({ type: "GET_PICKAXE_SHOP_DATA" });
      if (window.setModalOpen) window.setModalOpen(true);
    }

    function closePickaxeModal() {
      const wrapper = document.querySelector(".pickaxe-wrapper");
      wrapper.classList.add("closing");

      setTimeout(() => {
        pickaxeOverlay.style.display = "none";
        pickaxeOverlay.classList.remove("visible");
        wrapper.classList.remove("closing");
      }, 400);

      hytopia.lockPointer(true);
      if (window.setModalOpen) window.setModalOpen(false);
    }

    function renderPickaxeGrid(data) {
      pickaxeData = data;
      pickaxes = data.pickaxes || [];
      equippedPickaxeId = data.equippedPickaxeId;
      playerGold = data.gold || 0;

      if (pickaxes.length === 0) {
        pickaxeGrid.innerHTML = '<div class="pickaxe-empty">No pickaxes available.</div>';
        renderPickaxeDetails(null);
        return;
      }

      // Auto-select equipped pickaxe or first one
      if (!selectedPickaxeId) {
        selectedPickaxeId = equippedPickaxeId || pickaxes[0].id;
      }

      pickaxeGrid.innerHTML = pickaxes.map(pickaxe => {
        const isSelected = pickaxe.id === selectedPickaxeId;
        const isEquipped = pickaxe.id === equippedPickaxeId;
        const isOwned = pickaxe.owned;
        const isLocked = !isOwned && pickaxe.cost > playerGold;

        const cdn = (window.CDN_ASSETS_URL || "").replace(/\/$/, "");
        const iconPath = pickaxe.icon ? (cdn ? `${cdn}/${pickaxe.icon}` : `../${pickaxe.icon}`) : null;

        return `
          <div class="pickaxe-card ${isSelected ? 'selected' : ''} ${isEquipped ? 'equipped' : ''} ${isLocked && !isOwned ? 'locked' : ''}"
               data-id="${pickaxe.id}">
            ${isEquipped ? '<div class="pickaxe-card__equipped-badge">+</div>' : ''}
            ${!isOwned && isLocked ? '<div class="pickaxe-card__lock-badge">*</div>' : ''}
            <div class="pickaxe-card__icon">
              ${iconPath
                ? `<img src="${iconPath}" alt="${pickaxe.name}" class="pickaxe-card__icon-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" /><span class="pickaxe-card__icon-emoji" style="display:none;">&#x26cf;&#xfe0f;</span>`
                : `<span class="pickaxe-card__icon-emoji">&#x26cf;&#xfe0f;</span>`
              }
            </div>
            <div class="pickaxe-card__name">${pickaxe.name}</div>
            <div class="pickaxe-card__cost">${isOwned ? 'Owned' : `${formatNumber(pickaxe.cost)} Gold`}</div>
          </div>
        `;
      }).join('');

      // Add click handlers
      pickaxeGrid.querySelectorAll('.pickaxe-card').forEach(card => {
        if (typeof window.attachClickSounds === "function") {
          window.attachClickSounds(card);
        }

        card.addEventListener('click', () => {
          const id = card.dataset.id;
          selectedPickaxeId = id;

          pickaxeGrid.querySelectorAll('.pickaxe-card').forEach(c => {
            c.classList.toggle('selected', c.dataset.id === id);
          });

          const pickaxe = pickaxes.find(p => p.id === id);
          renderPickaxeDetails(pickaxe);
        });
      });

      // Render selected pickaxe details
      const selectedPickaxe = pickaxes.find(p => p.id === selectedPickaxeId);
      renderPickaxeDetails(selectedPickaxe);
    }

    function renderPickaxeDetails(pickaxe) {
      if (!pickaxe) {
        pickaxeDetailIconImg.style.display = "none";
        pickaxeDetailIconEmoji.style.display = "block";
        pickaxeDetailIconEmoji.textContent = "?";
        pickaxeDetailName.textContent = "Select a Pickaxe";
        pickaxeDetailStats.innerHTML = "";
        pickaxeActionBtn.textContent = "Select";
        pickaxeActionBtn.disabled = true;
        return;
      }

      const cdn = (window.CDN_ASSETS_URL || "").replace(/\/$/, "");
      const iconPath = pickaxe.icon ? (cdn ? `${cdn}/${pickaxe.icon}` : `../${pickaxe.icon}`) : null;

      if (iconPath) {
        pickaxeDetailIconImg.src = iconPath;
        pickaxeDetailIconImg.style.display = "block";
        pickaxeDetailIconEmoji.style.display = "none";
      } else {
        pickaxeDetailIconImg.style.display = "none";
        pickaxeDetailIconEmoji.style.display = "block";
        pickaxeDetailIconEmoji.innerHTML = "&#x26cf;&#xfe0f;";
      }

      pickaxeDetailName.textContent = pickaxe.name;

      // Build stats HTML
      let statsHtml = '';
      if (pickaxe.power) {
        statsHtml += `<div class="pickaxe-stat-row"><span class="pickaxe-stat-row__label">Power</span><span class="pickaxe-stat-row__value pickaxe-stat-row__value--power">+${formatNumber(pickaxe.power)}</span></div>`;
      }
      if (pickaxe.damage) {
        statsHtml += `<div class="pickaxe-stat-row"><span class="pickaxe-stat-row__label">Damage</span><span class="pickaxe-stat-row__value pickaxe-stat-row__value--damage">+${formatNumber(pickaxe.damage)}</span></div>`;
      }
      if (pickaxe.luck) {
        statsHtml += `<div class="pickaxe-stat-row"><span class="pickaxe-stat-row__label">Luck</span><span class="pickaxe-stat-row__value pickaxe-stat-row__value--luck">+${pickaxe.luck}%</span></div>`;
      }
      if (pickaxe.speed) {
        statsHtml += `<div class="pickaxe-stat-row"><span class="pickaxe-stat-row__label">Speed</span><span class="pickaxe-stat-row__value pickaxe-stat-row__value--speed">+${pickaxe.speed}%</span></div>`;
      }
      if (pickaxe.sellMultiplier) {
        statsHtml += `<div class="pickaxe-stat-row"><span class="pickaxe-stat-row__label">Sell Bonus</span><span class="pickaxe-stat-row__value pickaxe-stat-row__value--sell">x${pickaxe.sellMultiplier}</span></div>`;
      }
      if (!pickaxe.owned) {
        statsHtml += `<div class="pickaxe-stat-row"><span class="pickaxe-stat-row__label">Cost</span><span class="pickaxe-stat-row__value pickaxe-stat-row__value--cost">${formatNumber(pickaxe.cost)} Gold</span></div>`;
      }

      pickaxeDetailStats.innerHTML = statsHtml;

      // Update action button
      const isEquipped = pickaxe.id === equippedPickaxeId;
      const isOwned = pickaxe.owned;
      const canAfford = playerGold >= pickaxe.cost;

      if (isEquipped) {
        pickaxeActionBtn.textContent = "Equipped";
        pickaxeActionBtn.disabled = true;
        pickaxeActionBtn.className = "pickaxe-details__action-btn pickaxe-details__action-btn--equipped";
      } else if (isOwned) {
        pickaxeActionBtn.textContent = "Equip";
        pickaxeActionBtn.disabled = false;
        pickaxeActionBtn.className = "pickaxe-details__action-btn";
      } else if (canAfford) {
        pickaxeActionBtn.textContent = `Buy for ${formatNumber(pickaxe.cost)} Gold`;
        pickaxeActionBtn.disabled = false;
        pickaxeActionBtn.className = "pickaxe-details__action-btn";
      } else {
        pickaxeActionBtn.textContent = `Need ${formatNumber(pickaxe.cost - playerGold)} more Gold`;
        pickaxeActionBtn.disabled = true;
        pickaxeActionBtn.className = "pickaxe-details__action-btn";
      }
    }

    function formatNumber(num) {
      if (num >= 1e12) return (num / 1e12).toFixed(1) + "T";
      if (num >= 1e9) return (num / 1e9).toFixed(1) + "B";
      if (num >= 1e6) return (num / 1e6).toFixed(1) + "M";
      if (num >= 1e3) return (num / 1e3).toFixed(1) + "K";
      return num.toString();
    }

    // Event listeners
    pickaxeCloseBtn?.addEventListener("click", closePickaxeModal);

    pickaxeActionBtn?.addEventListener("click", () => {
      if (!selectedPickaxeId || pickaxeActionBtn.disabled) return;

      const pickaxe = pickaxes.find(p => p.id === selectedPickaxeId);
      if (!pickaxe) return;

      if (pickaxe.owned) {
        hytopia.sendData({
          type: "EQUIP_PICKAXE",
          payload: { pickaxeId: selectedPickaxeId }
        });
      } else {
        hytopia.sendData({
          type: "BUY_PICKAXE",
          payload: { pickaxeId: selectedPickaxeId }
        });
      }
    });

    // Close when clicking outside
    pickaxeOverlay?.addEventListener("click", (e) => {
      if (e.target === pickaxeOverlay) {
        closePickaxeModal();
      }
    });

    // Keyboard shortcuts
    document.addEventListener("keydown", (e) => {
      if (pickaxeOverlay.style.display !== "flex") return;
      if (e.key === "Escape") {
        closePickaxeModal();
        e.preventDefault();
        e.stopPropagation();
      }
    });

    // Attach click sounds
    if (typeof window.attachClickSounds === "function") {
      window.attachClickSounds(pickaxeCloseBtn);
      window.attachClickSounds(pickaxeActionBtn);
    }

    // Listen for data events
    hytopia.onData((data) => {
      if (data?.type === "PICKAXE_SHOP_DATA") {
        renderPickaxeGrid(data.payload);
      }

      if (data?.type === "OPEN_PICKAXE_MODAL") {
        openPickaxeModal();
      }

      if (data?.type === "PICKAXE_PURCHASE_SUCCESS" || data?.type === "PICKAXE_EQUIP_SUCCESS") {
        hytopia.sendData({ type: "GET_PICKAXE_SHOP_DATA" });
      }
    });

    // Expose globally
    window.openPickaxeModal = openPickaxeModal;
    window.closePickaxeModal = closePickaxeModal;
  })();
</script>


<!-- Included from: ./components/RebirthModal.html -->
<!-- Rebirth Modal -->
<div
  id="rebirth-modal"
  class="hud"
  style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.6);
    z-index: 11000;
  "
>
  <div class="rebirth-wrapper">
    <!-- Title container -->
    <div class="rebirth-title-container">
      <h2 class="rebirth-title">REBIRTH</h2>
    </div>
    <!-- Close button -->
    <button id="rebirth-close-btn" class="rebirth-close-btn">X</button>

    <div class="rebirth-container">
      <div class="rebirth-content">
        <!-- Explanation -->
        <div class="rebirth-explanation">
          <span class="rebirth-explanation__icon">&#x1f504;</span>
          <span class="rebirth-explanation__text">1 Rebirth = +10% Power</span>
        </div>

        <!-- Current stats -->
        <div class="rebirth-stats">
          <div class="rebirth-stat">
            <span class="rebirth-stat__label">Current Rebirths</span>
            <span id="rebirth-current-count" class="rebirth-stat__value rebirth-stat__value--green">0</span>
          </div>
          <div class="rebirth-stat">
            <span class="rebirth-stat__label">Power Bonus</span>
            <span id="rebirth-power-bonus" class="rebirth-stat__value rebirth-stat__value--red">+0%</span>
          </div>
        </div>

        <!-- Rebirth options -->
        <div id="rebirth-options" class="rebirth-options-grid"></div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Support for .visible class from legacy code */
  #rebirth-modal.visible {
    display: flex !important;
  }

  .rebirth-wrapper {
    position: relative;
    width: 600px;
    max-width: 95vw;
    font-family: "Fredoka", sans-serif;
    margin-top: 40px;
  }

  .rebirth-container {
    background: linear-gradient(
      180deg,
      rgba(30, 30, 40, 0.95),
      rgba(20, 20, 30, 0.95)
    );
    border: 3px solid rgba(139, 69, 19, 0.9);
    border-radius: 16px;
    padding: 0;
    width: 100%;
    display: flex;
    flex-direction: column;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.65);
    overflow: hidden;
    animation: rebirthSlideInUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .rebirth-wrapper.closing .rebirth-container {
    animation: rebirthSlideOutDown 0.4s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards;
  }

  @keyframes rebirthSlideInUp {
    from {
      opacity: 0;
      transform: translateY(60px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  @keyframes rebirthSlideOutDown {
    from {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
    to {
      opacity: 0;
      transform: translateY(60px) scale(0.95);
    }
  }

  .rebirth-title-container {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 100;
    background: linear-gradient(
      135deg,
      rgba(76, 175, 80, 0.95),
      rgba(56, 142, 60, 0.95)
    );
    border: 3px solid rgba(76, 175, 80, 0.8);
    border-radius: 12px;
    padding: 8px 24px;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.7);
  }

  .rebirth-title {
    font-size: 24px;
    font-weight: 900;
    color: #fff;
    margin: 0;
    -webkit-text-stroke: 2px #000;
    paint-order: stroke fill;
  }

  .rebirth-close-btn {
    position: absolute;
    top: 0;
    right: 0;
    transform: translate(50%, -50%);
    background: linear-gradient(
      135deg,
      rgba(255, 71, 87, 0.95),
      rgba(220, 50, 65, 0.95)
    );
    border: 3px solid rgba(255, 71, 87, 1);
    color: #fff;
    font-size: 18px;
    font-weight: 700;
    width: 40px;
    height: 40px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    z-index: 100;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.7);
  }

  .rebirth-close-btn:hover {
    background: linear-gradient(
      135deg,
      rgba(255, 91, 107, 1),
      rgba(240, 60, 75, 1)
    );
    border-color: #ff4757;
    transform: translate(50%, -50%) scale(1.1);
  }

  .rebirth-content {
    padding: 24px 20px 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .rebirth-explanation {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 12px 16px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    border: 2px solid rgba(76, 175, 80, 0.4);
  }

  .rebirth-explanation__icon {
    font-size: 24px;
  }

  .rebirth-explanation__text {
    font-size: 16px;
    font-weight: 700;
    color: #fff;
  }

  .rebirth-stats {
    display: flex;
    gap: 12px;
  }

  .rebirth-stat {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 12px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    border: 2px solid rgba(139, 69, 19, 0.4);
  }

  .rebirth-stat__label {
    font-size: 12px;
    font-weight: 600;
    color: #a6b7d3;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .rebirth-stat__value {
    font-size: 22px;
    font-weight: 900;
    -webkit-text-stroke: 1px #000;
    paint-order: stroke fill;
  }

  .rebirth-stat__value--green {
    color: #4caf50;
  }

  .rebirth-stat__value--red {
    color: #ff5252;
  }

  .rebirth-options-grid {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .rebirth-option {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 16px;
    background: linear-gradient(
      180deg,
      rgba(60, 50, 40, 0.7),
      rgba(40, 35, 30, 0.7)
    );
    border: 2px solid rgba(139, 69, 19, 0.5);
    border-radius: 10px;
    transition: all 0.2s ease;
  }

  .rebirth-option:hover:not(.rebirth-option--unavailable) {
    background: linear-gradient(
      180deg,
      rgba(80, 65, 50, 0.8),
      rgba(50, 40, 30, 0.8)
    );
    border-color: rgba(76, 175, 80, 0.6);
    transform: translateY(-2px);
  }

  .rebirth-option--max {
    border-color: rgba(255, 215, 0, 0.6);
    background: linear-gradient(
      180deg,
      rgba(80, 65, 40, 0.8),
      rgba(50, 40, 25, 0.8)
    );
  }

  .rebirth-option--max:hover:not(.rebirth-option--unavailable) {
    border-color: rgba(255, 215, 0, 0.9);
  }

  .rebirth-option--unavailable {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .rebirth-option__info {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .rebirth-option__title {
    font-size: 16px;
    font-weight: 700;
    color: #4caf50;
  }

  .rebirth-option--max .rebirth-option__title {
    color: #ffd700;
  }

  .rebirth-option__cost {
    font-size: 13px;
    font-weight: 600;
    color: #ff5252;
  }

  .rebirth-option__btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: 2px solid;
    font-size: 14px;
    font-weight: 700;
    font-family: "Fredoka", sans-serif;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .rebirth-option__btn--rebirth {
    background: linear-gradient(180deg, #66bb6a, #2e7d32);
    border-color: rgba(76, 175, 80, 0.9);
    color: #fff;
  }

  .rebirth-option__btn--rebirth:hover:not(:disabled) {
    background: linear-gradient(180deg, #81c784, #43a047);
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
  }

  .rebirth-option__btn--max {
    background: linear-gradient(180deg, #ffd700, #ffb700);
    border-color: rgba(255, 215, 0, 0.9);
    color: #000;
  }

  .rebirth-option__btn--max:hover:not(:disabled) {
    background: linear-gradient(180deg, #ffed4e, #ffd700);
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
  }

  .rebirth-option__btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    filter: grayscale(0.5);
    transform: none !important;
  }

  /* Mobile scrolling support */
  body.mobile .rebirth-content {
    touch-action: pan-y !important;
    -webkit-overflow-scrolling: touch !important;
  }

  /* Mobile-specific responsive styles */
  body.mobile .rebirth-wrapper {
    width: 420px;
    max-width: 85vw;
    margin-top: 15px;
  }

  body.mobile .rebirth-container {
    border-width: 2px;
    border-radius: 12px;
  }

  body.mobile .rebirth-title-container {
    padding: 5px 14px;
    border-radius: 8px;
    border-width: 2px;
  }

  body.mobile .rebirth-title {
    font-size: 14px;
    -webkit-text-stroke: 1px #000;
  }

  body.mobile .rebirth-close-btn {
    width: 30px;
    height: 30px;
    font-size: 14px;
    border-width: 2px;
    border-radius: 6px;
  }

  body.mobile .rebirth-content {
    padding: 16px 12px 12px;
    gap: 8px;
  }

  body.mobile .rebirth-explanation {
    padding: 8px 10px;
    gap: 6px;
    border-radius: 8px;
  }

  body.mobile .rebirth-explanation__icon {
    font-size: 16px;
  }

  body.mobile .rebirth-explanation__text {
    font-size: 12px;
  }

  body.mobile .rebirth-stats {
    gap: 6px;
  }

  body.mobile .rebirth-stat {
    padding: 8px;
    border-radius: 8px;
  }

  body.mobile .rebirth-stat__label {
    font-size: 9px;
  }

  body.mobile .rebirth-stat__value {
    font-size: 16px;
  }

  body.mobile .rebirth-options-grid {
    gap: 6px;
    max-height: 140px;
    overflow-y: auto;
  }

  body.mobile .rebirth-option {
    padding: 10px;
    border-radius: 8px;
  }

  body.mobile .rebirth-option__title {
    font-size: 12px;
  }

  body.mobile .rebirth-option__cost {
    font-size: 10px;
  }

  body.mobile .rebirth-option__btn {
    padding: 6px 12px;
    font-size: 11px;
    border-radius: 6px;
  }
</style>

<script>
  (function() {
    const rebirthOverlay = document.getElementById("rebirth-modal");
    const rebirthCloseBtn = document.getElementById("rebirth-close-btn");
    const rebirthOptionsGrid = document.getElementById("rebirth-options");
    const rebirthCurrentCount = document.getElementById("rebirth-current-count");
    const rebirthPowerBonus = document.getElementById("rebirth-power-bonus");

    let rebirthData = null;

    function openRebirthModal() {
      rebirthOverlay.style.display = "flex";

      const wrapper = document.querySelector(".rebirth-wrapper");
      wrapper.classList.remove("closing");
      void wrapper.offsetWidth;

      hytopia.lockPointer(false, true);
      hytopia.sendData({ type: "GET_REBIRTH_DATA" });
      if (window.setModalOpen) window.setModalOpen(true);
    }

    function closeRebirthModal() {
      const wrapper = document.querySelector(".rebirth-wrapper");
      wrapper.classList.add("closing");

      setTimeout(() => {
        rebirthOverlay.style.display = "none";
        rebirthOverlay.classList.remove("visible");
        wrapper.classList.remove("closing");
      }, 400);

      hytopia.lockPointer(true);
      if (window.setModalOpen) window.setModalOpen(false);
    }

    function renderRebirthOptions(data) {
      rebirthData = data;
      const { currentRebirths, power, options } = data;

      // Update stats display
      rebirthCurrentCount.textContent = formatNumber(currentRebirths || 0);
      const powerBonus = (currentRebirths || 0) * 10;
      rebirthPowerBonus.textContent = `+${powerBonus}%`;

      if (!options || options.length === 0) {
        rebirthOptionsGrid.innerHTML = '<div class="rebirth-empty">No rebirth options available.</div>';
        return;
      }

      rebirthOptionsGrid.innerHTML = options.map((option, index) => {
        const canAfford = BigInt(power || "0") >= BigInt(option.cost || "0");
        const isMax = option.isMax;

        return `
          <div class="rebirth-option ${isMax ? 'rebirth-option--max' : ''} ${!canAfford ? 'rebirth-option--unavailable' : ''}"
               data-index="${index}">
            <div class="rebirth-option__info">
              <div class="rebirth-option__title">${isMax ? 'MAX REBIRTH' : `+${formatNumber(option.rebirths)} Rebirth${option.rebirths > 1 ? 's' : ''}`}</div>
              <div class="rebirth-option__cost">Requires: ${formatBigNumber(option.cost)} Power</div>
            </div>
            <button class="rebirth-option__btn ${isMax ? 'rebirth-option__btn--max' : 'rebirth-option__btn--rebirth'}"
                    ${!canAfford ? 'disabled' : ''}
                    data-index="${index}">
              ${isMax ? 'Rebirth All' : 'Rebirth'}
            </button>
          </div>
        `;
      }).join('');

      // Add click handlers
      rebirthOptionsGrid.querySelectorAll('.rebirth-option__btn').forEach(btn => {
        if (typeof window.attachClickSounds === "function") {
          window.attachClickSounds(btn);
        }

        btn.addEventListener('click', () => {
          if (btn.disabled) return;
          const index = parseInt(btn.dataset.index);
          const option = options[index];

          hytopia.sendData({
            type: "DO_REBIRTH",
            payload: { rebirths: option.rebirths, isMax: option.isMax }
          });
        });
      });
    }

    function formatNumber(num) {
      if (num >= 1e12) return (num / 1e12).toFixed(1) + "T";
      if (num >= 1e9) return (num / 1e9).toFixed(1) + "B";
      if (num >= 1e6) return (num / 1e6).toFixed(1) + "M";
      if (num >= 1e3) return (num / 1e3).toFixed(1) + "K";
      return num.toString();
    }

    function formatBigNumber(numStr) {
      try {
        const num = BigInt(numStr || "0");
        const trillion = BigInt("1000000000000");
        const billion = BigInt("1000000000");
        const million = BigInt("1000000");
        const thousand = BigInt("1000");

        if (num >= trillion) {
          return (Number(num / (trillion / BigInt(10))) / 10).toFixed(1) + "T";
        }
        if (num >= billion) {
          return (Number(num / (billion / BigInt(10))) / 10).toFixed(1) + "B";
        }
        if (num >= million) {
          return (Number(num / (million / BigInt(10))) / 10).toFixed(1) + "M";
        }
        if (num >= thousand) {
          return (Number(num / (thousand / BigInt(10))) / 10).toFixed(1) + "K";
        }
        return num.toString();
      } catch (e) {
        return numStr || "0";
      }
    }

    // Event listeners
    rebirthCloseBtn?.addEventListener("click", closeRebirthModal);

    // Close when clicking outside
    rebirthOverlay?.addEventListener("click", (e) => {
      if (e.target === rebirthOverlay) {
        closeRebirthModal();
      }
    });

    // Keyboard shortcuts
    document.addEventListener("keydown", (e) => {
      if (rebirthOverlay.style.display !== "flex") return;
      if (e.key === "Escape") {
        closeRebirthModal();
        e.preventDefault();
        e.stopPropagation();
      }
    });

    // Attach click sounds
    if (typeof window.attachClickSounds === "function") {
      window.attachClickSounds(rebirthCloseBtn);
    }

    // Listen for data events
    hytopia.onData((data) => {
      if (data?.type === "REBIRTH_DATA") {
        renderRebirthOptions(data.payload);
      }

      if (data?.type === "OPEN_REBIRTH_MODAL") {
        openRebirthModal();
      }

      if (data?.type === "REBIRTH_SUCCESS") {
        hytopia.sendData({ type: "GET_REBIRTH_DATA" });
      }
    });

    // Expose globally
    window.openRebirthModal = openRebirthModal;
    window.closeRebirthModal = closeRebirthModal;
  })();
</script>


<!-- Included from: ./components/EggModal.html -->
<!-- Egg Station Modal -->
<div
  id="egg-modal"
  class="hud"
  style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.6);
    z-index: 11000;
  "
>
  <div class="egg-wrapper">
    <div class="egg-container">
      <!-- Header with tabs and close button -->
      <div class="egg-header">
        <div class="egg-tabs-container" id="egg-tabs-container">
          <!-- Tabs will be populated dynamically -->
        </div>
        <button id="egg-close-btn" class="egg-close-btn">X</button>
      </div>

      <!-- Main content area -->
      <div class="egg-content-wrapper">
        <!-- Left Side: Selected egg + actions -->
        <div class="egg-left-panel">
          <!-- Stats bar -->
          <div class="egg-stats-bar">
            <div class="egg-stat-pill">
              <span class="egg-stat-icon">&#x1F4B0;</span>
              <span id="egg-header-gold">0</span>
            </div>
            <div class="egg-stat-pill">
              <span class="egg-stat-icon">&#x1F43E;</span>
              <span id="egg-header-pets">0/50</span>
            </div>
          </div>

          <!-- Selected egg display -->
          <div class="egg-selected-area">
            <div id="egg-station-icon" class="egg-selected-icon">&#x1F95A;</div>
            <div class="egg-selected-info">
              <div id="egg-station-name" class="egg-selected-name">Stone Egg</div>
              <div class="egg-selected-cost">
                <span id="egg-station-cost">10</span> gold
              </div>
            </div>
          </div>

          <!-- Action buttons -->
          <div class="egg-actions">
            <button id="egg-open-1" class="egg-btn egg-btn-primary">Open 1</button>
            <button id="egg-open-3" class="egg-btn egg-btn-primary">Open 3</button>
            <button id="egg-auto" class="egg-btn egg-btn-auto">Auto</button>
          </div>

          <!-- Status message -->
          <div id="egg-station-status" class="egg-status">Ready</div>
        </div>

        <!-- Right Side: Possible pets -->
        <div class="egg-right-panel">
          <div class="egg-pets-header">
            <span class="egg-section-title">POSSIBLE PETS</span>
            <span class="egg-pets-hint">Tap = auto-delete</span>
          </div>
          <div class="egg-pets-grid-container">
            <div id="egg-shop-grid" class="egg-pets-grid">
              <!-- Pet cards populated dynamically -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Egg Hatch Overlay -->
<div id="egg-hatch-overlay" class="egg-hatch-overlay" hidden>
  <div id="egg-hatch-slots" class="egg-hatch-slots"></div>
</div>

<style>
  #egg-modal.visible {
    display: flex !important;
  }

  .egg-wrapper {
    position: relative;
    width: 900px;
    max-width: 95vw;
    max-height: 90vh;
    font-family: "Fredoka", sans-serif;
  }

  .egg-container {
    background: linear-gradient(
      180deg,
      rgba(30, 30, 40, 0.98),
      rgba(20, 20, 30, 0.98)
    );
    border: 3px solid rgba(168, 85, 247, 0.8);
    border-radius: 16px;
    padding: 0;
    width: 100%;
    display: flex;
    flex-direction: column;
    box-shadow: 0 0 30px rgba(168, 85, 247, 0.3), 0 0 60px rgba(0, 0, 0, 0.65);
    overflow: hidden;
    animation: eggSlideInUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .egg-wrapper.closing .egg-container {
    animation: eggSlideOutDown 0.4s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards;
  }

  @keyframes eggSlideInUp {
    from {
      opacity: 0;
      transform: translateY(60px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  @keyframes eggSlideOutDown {
    from {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
    to {
      opacity: 0;
      transform: translateY(60px) scale(0.95);
    }
  }

  /* Header row with tabs and close button */
  .egg-header {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 12px 16px;
    background: rgba(0, 0, 0, 0.4);
    border-bottom: 2px solid rgba(168, 85, 247, 0.4);
    position: relative;
  }

  /* Tabs container - now inline in header */
  .egg-tabs-container {
    display: flex;
    gap: 4px;
    background: rgba(0, 0, 0, 0.5);
    border: 2px solid rgba(168, 85, 247, 0.5);
    border-radius: 10px;
    padding: 4px;
  }

  .egg-tab {
    padding: 8px 16px;
    font-size: 14px;
    font-weight: 700;
    font-family: "Fredoka", sans-serif;
    color: #aaa;
    background: transparent;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    min-width: 80px;
  }

  .egg-tab:hover:not(.egg-tab--active) {
    color: #fff;
    background: rgba(168, 85, 247, 0.2);
  }

  .egg-tab--active {
    color: #fff;
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.9), rgba(109, 40, 217, 0.9));
    box-shadow: 0 2px 8px rgba(168, 85, 247, 0.4);
  }

  .egg-tab__icon {
    font-size: 22px;
  }

  .egg-tab__name {
    font-size: 11px;
    white-space: nowrap;
    font-weight: 800;
  }

  .egg-tab__cost {
    font-size: 10px;
    color: #ffd700;
    font-weight: 700;
  }

  .egg-tab--active .egg-tab__cost {
    color: #ffd700;
  }

  .egg-close-btn {
    position: absolute;
    top: 50%;
    right: 12px;
    transform: translateY(-50%);
    background: linear-gradient(135deg, rgba(255, 71, 87, 0.95), rgba(220, 50, 65, 0.95));
    border: 2px solid rgba(255, 71, 87, 1);
    color: #fff;
    font-size: 16px;
    font-weight: 700;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
  }

  .egg-close-btn:hover {
    background: linear-gradient(135deg, rgba(255, 91, 107, 1), rgba(240, 60, 75, 1));
    transform: translateY(-50%) scale(1.1);
  }

  /* Content wrapper */
  .egg-content-wrapper {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* Left panel */
  .egg-left-panel {
    flex: 0 0 auto;
    display: flex;
    flex-direction: column;
    padding: 12px;
    gap: 8px;
    min-width: 200px;
    max-width: 280px;
    overflow-y: auto;
  }

  .egg-stats-bar {
    display: flex;
    justify-content: center;
    gap: 10px;
  }

  .egg-stat-pill {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    border: 2px solid rgba(168, 85, 247, 0.4);
    background: rgba(0, 0, 0, 0.4);
    color: #fff;
    font-weight: 700;
    font-size: 13px;
  }

  .egg-stat-icon {
    font-size: 14px;
  }

  .egg-selected-area {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 8px;
  }

  .egg-selected-icon {
    font-size: 60px;
    animation: eggBounce 2s ease-in-out infinite;
  }

  @keyframes eggBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
  }

  .egg-selected-info {
    text-align: center;
  }

  .egg-selected-name {
    font-size: 16px;
    font-weight: 900;
    color: #fff;
    -webkit-text-stroke: 1px #000;
    paint-order: stroke fill;
    margin-bottom: 2px;
  }

  .egg-selected-cost {
    font-size: 14px;
    color: #ffd700;
    font-weight: 700;
  }

  .egg-actions {
    display: flex;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .egg-btn {
    padding: 10px 20px;
    border-radius: 10px;
    border: 2px solid;
    font-size: 14px;
    font-weight: 700;
    font-family: "Fredoka", sans-serif;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 80px;
  }

  .egg-btn-primary {
    background: linear-gradient(180deg, #a855f7, #6d28d9);
    border-color: rgba(168, 85, 247, 0.9);
    color: #fff;
  }

  .egg-btn-primary:hover:not(:disabled) {
    background: linear-gradient(180deg, #c084fc, #a855f7);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(168, 85, 247, 0.4);
  }

  .egg-btn-auto {
    background: linear-gradient(180deg, #ffd700, #ffb700);
    border-color: rgba(255, 215, 0, 0.9);
    color: #000;
  }

  .egg-btn-auto:hover:not(:disabled) {
    background: linear-gradient(180deg, #ffed4e, #ffd700);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
  }

  .egg-btn-auto.active {
    background: linear-gradient(180deg, #22c55e, #15803d);
    border-color: rgba(34, 197, 94, 0.9);
    color: #fff;
  }

  .egg-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    filter: grayscale(0.3);
  }

  .egg-status {
    text-align: center;
    font-size: 13px;
    color: #a6b7d3;
    min-height: 18px;
  }

  .egg-results-section {
    margin-top: auto;
    border-top: 2px solid rgba(168, 85, 247, 0.3);
    padding-top: 12px;
  }

  .egg-section-title {
    font-size: 12px;
    font-weight: 800;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
  }

  .egg-results-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
    max-height: 100px;
    overflow-y: auto;
  }

  .egg-result-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 10px;
    background: rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(168, 85, 247, 0.3);
    border-radius: 6px;
  }

  .egg-result-item__name {
    font-size: 12px;
    font-weight: 700;
    color: #fff;
  }

  .egg-result-item__mult {
    font-size: 12px;
    font-weight: 800;
    color: #ffd700;
  }

  .egg-empty {
    text-align: center;
    color: #a6b7d3;
    padding: 12px 0;
    font-weight: 600;
    font-size: 12px;
  }

  /* Right panel */
  .egg-right-panel {
    flex: 1.2;
    display: flex;
    flex-direction: column;
    padding: 16px;
    background: rgba(0, 0, 0, 0.3);
    border-left: 2px solid rgba(168, 85, 247, 0.3);
    min-width: 300px;
  }

  .egg-pets-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    margin-top: 20px;
  }

  .egg-pets-hint {
    font-size: 10px;
    color: #a6b7d3;
    font-weight: 600;
  }

  .egg-pets-grid-container {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    min-height: 0;
  }

  .egg-pets-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 8px;
  }

  .egg-pet-card {
    position: relative;
    border: 2px solid rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    background: rgba(0, 0, 0, 0.25);
    padding: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
  }

  .egg-pet-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .egg-pet-card--common { border-color: rgba(148, 163, 184, 0.5); }
  .egg-pet-card--rare { border-color: rgba(59, 130, 246, 0.6); }
  .egg-pet-card--epic { border-color: rgba(168, 85, 247, 0.7); }
  .egg-pet-card--legendary { border-color: rgba(245, 158, 11, 0.8); }

  .egg-pet-card.is-auto-delete {
    border-color: rgba(239, 68, 68, 0.7);
    box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
  }

  .egg-pet-card__chance {
    position: absolute;
    top: 4px;
    left: 4px;
    padding: 2px 6px;
    border-radius: 999px;
    background: rgba(0, 0, 0, 0.6);
    font-size: 9px;
    font-weight: 800;
    color: #fff;
  }

  .egg-pet-card__auto {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 16px;
    height: 16px;
    border-radius: 4px;
    background: rgba(239, 68, 68, 0.9);
    color: #fff;
    font-weight: 900;
    font-size: 10px;
    display: none;
    align-items: center;
    justify-content: center;
  }

  .egg-pet-card.is-auto-delete .egg-pet-card__auto {
    display: flex;
  }

  .egg-pet-card__thumb {
    width: 44px;
    height: 44px;
    margin: 12px auto 4px;
    border-radius: 8px;
    background: rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    overflow: hidden;
  }

  .egg-pet-card__thumb img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .egg-pet-card__name {
    font-size: 10px;
    font-weight: 700;
    color: #fff;
    line-height: 1.2;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Scrollbar styling */
  .egg-results-list::-webkit-scrollbar,
  .egg-pets-grid-container::-webkit-scrollbar {
    width: 6px;
  }

  .egg-results-list::-webkit-scrollbar-track,
  .egg-pets-grid-container::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 3px;
  }

  .egg-results-list::-webkit-scrollbar-thumb,
  .egg-pets-grid-container::-webkit-scrollbar-thumb {
    background: rgba(168, 85, 247, 0.5);
    border-radius: 3px;
  }

  /* Hatch overlay */
  .egg-hatch-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 12000;
  }

  .egg-hatch-overlay[hidden] {
    display: none;
  }

  .egg-hatch-slots {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .egg-hatch-slot {
    width: 120px;
    height: 150px;
    border-radius: 14px;
    border: 3px solid rgba(168, 85, 247, 0.8);
    background: rgba(30, 30, 40, 0.95);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    animation: eggHatchPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes eggHatchPop {
    0% { transform: scale(0); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
  }

  .egg-hatch-slot__icon {
    font-size: 48px;
  }

  .egg-hatch-slot__name {
    font-size: 14px;
    font-weight: 700;
    color: #fff;
    text-align: center;
  }

  .egg-hatch-slot__mult {
    font-size: 16px;
    font-weight: 900;
    color: #ffd700;
  }

  /* Mobile scrolling support */
  body.mobile .egg-pets-grid-container,
  body.mobile .egg-pets-grid {
    touch-action: pan-y !important;
    -webkit-overflow-scrolling: touch !important;
  }

  /* Mobile responsive */
  body.mobile .egg-wrapper {
    max-width: 98vw;
    max-height: 85vh;
  }

  body.mobile .egg-header {
    padding: 6px 10px;
  }

  body.mobile .egg-tabs-container {
    padding: 2px;
    gap: 2px;
  }

  body.mobile .egg-tab {
    padding: 4px 10px;
    min-width: 55px;
  }

  body.mobile .egg-tab__icon {
    font-size: 16px;
  }

  body.mobile .egg-tab__name {
    font-size: 8px;
  }

  body.mobile .egg-tab__cost {
    font-size: 7px;
  }

  body.mobile .egg-close-btn {
    width: 28px;
    height: 28px;
    font-size: 12px;
    right: 6px;
  }

  body.mobile .egg-content-wrapper {
    flex-direction: row;
    max-height: calc(85vh - 50px);
    overflow: hidden;
  }

  body.mobile .egg-left-panel {
    padding: 8px;
    gap: 6px;
    min-width: 160px;
    max-width: 200px;
    flex: 0 0 auto;
    overflow-y: auto;
  }

  body.mobile .egg-stats-bar {
    gap: 4px;
    margin-top: 0;
  }

  body.mobile .egg-stat-pill {
    padding: 3px 6px;
    font-size: 9px;
  }

  body.mobile .egg-selected-area {
    padding: 4px;
    gap: 2px;
  }

  body.mobile .egg-selected-icon {
    font-size: 40px;
  }

  body.mobile .egg-selected-name {
    font-size: 12px;
  }

  body.mobile .egg-selected-cost {
    font-size: 11px;
  }

  body.mobile .egg-actions {
    gap: 4px;
  }

  body.mobile .egg-btn {
    padding: 6px 10px;
    font-size: 10px;
    min-width: 55px;
  }

  body.mobile .egg-status {
    font-size: 9px;
    min-height: 14px;
  }

  body.mobile .egg-right-panel {
    padding: 8px;
    border-left: 2px solid rgba(168, 85, 247, 0.3);
    border-top: none;
    min-width: 0;
    flex: 1;
    overflow-y: auto;
  }

  body.mobile .egg-pets-header {
    margin-top: 0;
    margin-bottom: 6px;
  }

  body.mobile .egg-section-title {
    font-size: 9px;
  }

  body.mobile .egg-pets-hint {
    font-size: 7px;
  }

  body.mobile .egg-pets-grid {
    grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
    gap: 4px;
  }

  body.mobile .egg-pet-card {
    padding: 3px;
  }

  body.mobile .egg-pet-card__thumb {
    width: 26px;
    height: 26px;
    margin: 6px auto 2px;
    font-size: 14px;
  }

  body.mobile .egg-pet-card__name {
    font-size: 7px;
  }

  body.mobile .egg-pet-card__chance {
    font-size: 6px;
    padding: 1px 3px;
  }
</style>

<script>
  (function() {
    const eggOverlay = document.getElementById("egg-modal");
    const eggCloseBtn = document.getElementById("egg-close-btn");
    const eggTabsContainer = document.getElementById("egg-tabs-container");
    const eggStationIcon = document.getElementById("egg-station-icon");
    const eggStationName = document.getElementById("egg-station-name");
    const eggStationCost = document.getElementById("egg-station-cost");
    const eggStationStatus = document.getElementById("egg-station-status");
    const eggHeaderGold = document.getElementById("egg-header-gold");
    const eggHeaderPets = document.getElementById("egg-header-pets");
    const eggShopGrid = document.getElementById("egg-shop-grid");
    const eggOpen1 = document.getElementById("egg-open-1");
    const eggOpen3 = document.getElementById("egg-open-3");
    const eggAuto = document.getElementById("egg-auto");

    const eggHatchOverlay = document.getElementById("egg-hatch-overlay");
    const eggHatchSlots = document.getElementById("egg-hatch-slots");

    let eggData = null;
    let selectedEggId = null;
    let autoDeletePets = new Set();
    let isAutoMode = false;
    let autoInterval = null;
    let cachedStations = []; // Cache raw station data for tab switching
    let cachedPlayerData = {};

    function openEggModal(eggId) {
      eggOverlay.style.display = "flex";
      selectedEggId = eggId || null;
      isAutoMode = false;
      stopAutoMode();

      const wrapper = document.querySelector(".egg-wrapper");
      wrapper.classList.remove("closing");
      void wrapper.offsetWidth;

      hytopia.lockPointer(false, true);
      hytopia.sendData({ type: "GET_EGG_SHOP_DATA", payload: { eggId: selectedEggId } });
      if (window.setModalOpen) window.setModalOpen(true);
    }

    function closeEggModal() {
      stopAutoMode();
      const wrapper = document.querySelector(".egg-wrapper");
      wrapper.classList.add("closing");

      setTimeout(() => {
        eggOverlay.style.display = "none";
        eggOverlay.classList.remove("visible");
        wrapper.classList.remove("closing");
      }, 400);

      hytopia.lockPointer(true);
      if (window.setModalOpen) window.setModalOpen(false);
    }

    function renderEggShop(data) {
      eggData = data;
      const { eggs, currentEgg, gold, pets, maxPets, lastHatch } = data;

      // Update header stats
      eggHeaderGold.textContent = formatNumber(gold || 0);
      eggHeaderPets.textContent = `${pets || 0}/${maxPets || 50}`;

      // Render egg tabs
      if (eggs && eggs.length > 0) {
        // Auto-select first egg if none selected
        if (!selectedEggId) {
          selectedEggId = eggs[0].id;
        }

        eggTabsContainer.innerHTML = eggs.map(egg => {
          const isActive = egg.id === selectedEggId;
          return `
            <button class="egg-tab ${isActive ? 'egg-tab--active' : ''}" data-id="${egg.id}">
              <span class="egg-tab__icon">${egg.icon || '&#x1F95A;'}</span>
              <span class="egg-tab__name">${egg.name}</span>
              <span class="egg-tab__cost">${formatNumber(egg.cost)}g</span>
            </button>
          `;
        }).join('');

        // Add tab click handlers
        eggTabsContainer.querySelectorAll('.egg-tab').forEach(tab => {
          if (typeof window.attachClickSounds === "function") {
            window.attachClickSounds(tab);
          }

          tab.addEventListener('click', () => {
            stopAutoMode();
            selectedEggId = tab.dataset.id;
            // Use cached data for instant tab switching
            if (cachedStations.length > 0) {
              renderFromStations(selectedEggId);
            } else {
              hytopia.sendData({ type: "GET_EGG_SHOP_DATA", payload: { eggId: selectedEggId } });
            }
          });
        });
      }

      // Render selected egg
      if (currentEgg) {
        eggStationIcon.innerHTML = currentEgg.icon || '&#x1F95A;';
        eggStationName.textContent = currentEgg.name;
        eggStationCost.textContent = formatNumber(currentEgg.cost);

        // Update button states
        const canAfford1 = gold >= currentEgg.cost;
        const canAfford3 = gold >= currentEgg.cost * 3;
        const petsFull = (pets || 0) >= (maxPets || 50);

        eggOpen1.disabled = !canAfford1 || petsFull;
        eggOpen3.disabled = !canAfford3 || petsFull;
        eggAuto.disabled = petsFull;

        // Update button text with cost
        eggOpen1.textContent = `Open 1 (${formatNumber(currentEgg.cost)})`;
        eggOpen3.textContent = `Open 3 (${formatNumber(currentEgg.cost * 3)})`;

        if (petsFull) {
          eggStationStatus.textContent = "Pet storage is full!";
          eggStationStatus.style.color = "#ff6b6b";
        } else if (!canAfford1) {
          eggStationStatus.textContent = `Need ${formatNumber(currentEgg.cost - gold)} more gold`;
          eggStationStatus.style.color = "#ffd700";
        } else {
          eggStationStatus.textContent = "Ready to hatch!";
          eggStationStatus.style.color = "#00d26a";
        }

        // Render possible pets
        if (currentEgg.possiblePets && currentEgg.possiblePets.length > 0) {
          eggShopGrid.innerHTML = currentEgg.possiblePets.map(pet => {
            const rarity = (pet.rarity || "common").toLowerCase();
            const isAutoDelete = autoDeletePets.has(pet.id);

            const cdn = (window.CDN_ASSETS_URL || "").replace(/\/$/, "");
            const iconPath = pet.icon ? (cdn ? `${cdn}/${pet.icon}` : `../${pet.icon}`) : null;

            return `
              <div class="egg-pet-card egg-pet-card--${rarity} ${isAutoDelete ? 'is-auto-delete' : ''}" data-id="${pet.id}">
                <div class="egg-pet-card__chance">${pet.chance || '?'}%</div>
                <div class="egg-pet-card__auto">X</div>
                <div class="egg-pet-card__thumb">
                  ${iconPath
                    ? `<img src="${iconPath}" alt="${pet.name}" onerror="this.style.display='none'; this.parentElement.innerHTML='&#x1F43E;';" />`
                    : '&#x1F43E;'
                  }
                </div>
                <div class="egg-pet-card__name">${pet.name}</div>
              </div>
            `;
          }).join('');

          // Add click handlers for auto-delete toggle
          eggShopGrid.querySelectorAll('.egg-pet-card').forEach(card => {
            if (typeof window.attachClickSounds === "function") {
              window.attachClickSounds(card);
            }

            card.addEventListener('click', () => {
              const id = card.dataset.id;
              if (autoDeletePets.has(id)) {
                autoDeletePets.delete(id);
              } else {
                autoDeletePets.add(id);
              }
              renderEggShop(eggData);
            });
          });
        } else {
          eggShopGrid.innerHTML = '<div class="egg-empty">No pet data available</div>';
        }
      }

      // Update auto button state
      eggAuto.classList.toggle('active', isAutoMode);
      eggAuto.textContent = isAutoMode ? 'Stop' : 'Auto';
    }

    function showHatchResults(results) {
      if (!results || results.length === 0) return;

      eggHatchSlots.innerHTML = results.map((pet, i) => {
        return `
          <div class="egg-hatch-slot" style="animation-delay: ${i * 0.1}s">
            <div class="egg-hatch-slot__icon">&#x1F43E;</div>
            <div class="egg-hatch-slot__name">${pet.name}</div>
            <div class="egg-hatch-slot__mult">x${pet.multiplier || 1}</div>
          </div>
        `;
      }).join('');

      eggHatchOverlay.hidden = false;

      setTimeout(() => {
        eggHatchOverlay.hidden = true;
        hytopia.sendData({ type: "GET_EGG_SHOP_DATA", payload: { eggId: selectedEggId } });
      }, 2000);
    }

    function startAutoMode() {
      isAutoMode = true;
      eggAuto.classList.add('active');
      eggAuto.textContent = 'Stop';

      autoInterval = setInterval(() => {
        if (!eggData || !eggData.currentEgg) return;

        const canAfford = (eggData.gold || 0) >= eggData.currentEgg.cost;
        const petsFull = (eggData.pets || 0) >= (eggData.maxPets || 50);

        if (!canAfford || petsFull) {
          stopAutoMode();
          return;
        }

        hytopia.sendData({
          type: "OPEN_EGG",
          payload: {
            eggId: selectedEggId,
            count: 1,
            autoDelete: Array.from(autoDeletePets)
          }
        });
      }, 1000);
    }

    function stopAutoMode() {
      isAutoMode = false;
      if (autoInterval) {
        clearInterval(autoInterval);
        autoInterval = null;
      }
      eggAuto.classList.remove('active');
      eggAuto.textContent = 'Auto';
    }

    function formatNumber(num) {
      if (num >= 1e12) return (num / 1e12).toFixed(1) + "T";
      if (num >= 1e9) return (num / 1e9).toFixed(1) + "B";
      if (num >= 1e6) return (num / 1e6).toFixed(1) + "M";
      if (num >= 1e3) return (num / 1e3).toFixed(1) + "K";
      return num.toString();
    }

    // Event listeners
    eggCloseBtn?.addEventListener("click", closeEggModal);

    eggOpen1?.addEventListener("click", () => {
      if (!selectedEggId) return;
      hytopia.sendData({
        type: "OPEN_EGG",
        payload: { eggId: selectedEggId, count: 1, autoDelete: Array.from(autoDeletePets) }
      });
    });

    eggOpen3?.addEventListener("click", () => {
      if (!selectedEggId) return;
      hytopia.sendData({
        type: "OPEN_EGG",
        payload: { eggId: selectedEggId, count: 3, autoDelete: Array.from(autoDeletePets) }
      });
    });

    eggAuto?.addEventListener("click", () => {
      if (isAutoMode) {
        stopAutoMode();
      } else {
        startAutoMode();
      }
    });

    eggOverlay?.addEventListener("click", (e) => {
      if (e.target === eggOverlay) {
        closeEggModal();
      }
    });

    eggHatchOverlay?.addEventListener("click", () => {
      eggHatchOverlay.hidden = true;
    });

    document.addEventListener("keydown", (e) => {
      if (eggOverlay.style.display !== "flex") return;
      if (e.key === "Escape") {
        closeEggModal();
        e.preventDefault();
        e.stopPropagation();
      }
    });

    if (typeof window.attachClickSounds === "function") {
      window.attachClickSounds(eggCloseBtn);
      window.attachClickSounds(eggOpen1);
      window.attachClickSounds(eggOpen3);
      window.attachClickSounds(eggAuto);
    }

    hytopia.onData((data) => {
      if (data?.type === "EGG_SHOP_DATA") {
        renderEggShop(data.payload);
      }

      // Handle proximity-based egg station data from server
      if (data?.type === "EGG_STATION_PROXIMITY") {
        if (data.inProximity) {
          // Cache the raw data for tab switching
          cachedStations = data.stations || [];
          cachedPlayerData = data.player || {};
          const currentStation = data.station || cachedStations[0];

          // Auto-select first egg if none selected
          if (!selectedEggId && cachedStations.length > 0) {
            selectedEggId = cachedStations[0].id;
          }

          // Open modal and render
          eggOverlay.style.display = "flex";
          const wrapper = document.querySelector(".egg-wrapper");
          wrapper.classList.remove("closing");
          hytopia.lockPointer(false, true);
          if (window.setModalOpen) window.setModalOpen(true);

          renderFromStations(selectedEggId);
        } else {
          // Close modal when leaving proximity
          closeEggModal();
        }
      }

      if (data?.type === "OPEN_EGG_MODAL") {
        openEggModal(data.payload?.eggId);
      }

      if (data?.type === "EGG_HATCH_SUCCESS") {
        showHatchResults(data.payload?.results);
      }
    });

    // Helper to get egg icon based on type
    function getEggIcon(eggType) {
      const icons = {
        stone: 'ðŸª¨',
        gem: 'ðŸ’Ž',
        crystal: 'ðŸ”®',
        abyssal: 'ðŸŒŠ',
        boardwalk: 'ðŸ–ï¸',
        shipwreck: 'ðŸš¢',
        sand: 'ðŸœï¸',
        snow: 'â„ï¸',
        lava: 'ðŸŒ‹'
      };
      return icons[eggType] || 'ðŸ¥š';
    }

    // Render from cached stations data
    function renderFromStations(selectedId) {
      if (!cachedStations.length) return;

      // Find selected station
      const currentStation = cachedStations.find(s => s.id === selectedId) || cachedStations[0];

      // Convert stations to eggs format for tabs
      const eggs = cachedStations.map(s => ({
        id: s.id,
        name: s.name,
        icon: getEggIcon(s.eggType),
        cost: s.costGold || 0
      }));

      // Convert current station to currentEgg format
      const currentEgg = currentStation ? {
        id: currentStation.id,
        name: currentStation.name,
        icon: getEggIcon(currentStation.eggType),
        cost: currentStation.costGold || 0,
        possiblePets: (currentStation.eggPets || []).map(p => ({
          id: p.petId,
          name: p.name,
          rarity: p.rarity,
          chance: Math.round(p.chance * 10) / 10,
          icon: `ui/icons/pets/${p.petId}.png`
        }))
      } : null;

      renderEggShop({
        eggs,
        currentEgg,
        gold: cachedPlayerData.gold || 0,
        pets: cachedPlayerData.petInventoryCount || 0,
        maxPets: cachedPlayerData.petInventoryCap || 50
      });
    }

    window.openEggModal = openEggModal;
    window.closeEggModal = closeEggModal;
    window.renderEggShop = renderEggShop;
    window.showEggHatchResults = showHatchResults;

    window.openEggModalDirect = function() {
      eggOverlay.style.display = "flex";
      isAutoMode = false;
      stopAutoMode();
      const wrapper = document.querySelector(".egg-wrapper");
      wrapper.classList.remove("closing");
      void wrapper.offsetWidth;
      hytopia.lockPointer(false, true);
    };
  })();
</script>


<!-- Included from: ./components/PetsModal.html -->
<!-- Pets Modal -->
<div
  id="pets-modal"
  class="hud"
  style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.6);
    z-index: 11000;
  "
>
  <div class="pets-wrapper">
    <!-- Title container -->
    <div class="pets-title-container">
      <h2 class="pets-title">PETS</h2>
    </div>
    <!-- Close button -->
    <button id="pets-close-btn" class="pets-close-btn">X</button>

    <div class="pets-container">
      <!-- Main Content: Left Details + Right Grid -->
      <div class="pets-content-wrapper">
        <!-- Left Side: Pet Details -->
        <div class="pets-left-panel">
          <div class="pets-details">
            <div class="pets-details__preview">
              <div id="pet-detail-image" class="pets-details__icon-wrapper">
                <img id="pet-detail-img-el" class="pets-details__icon-img" src="" alt="" style="display: none;" />
                <span id="pet-detail-emoji" class="pets-details__icon-emoji">&#x1F43E;</span>
              </div>
              <div id="pet-detail-mult" class="pets-details__mult-badge"></div>
            </div>
            <div id="pet-detail-name" class="pets-details__name">No Pet Selected</div>
            <div id="pet-detail-stats" class="pets-details__stats">
              <div class="pets-stat-row" style="justify-content: center; color: #7a8ba3;">Select a pet</div>
            </div>
            <button id="pet-detail-action" class="pets-details__action-btn" disabled>â€”</button>
          </div>
        </div>

        <!-- Right Side: Pet Grid -->
        <div class="pets-right-panel">
          <div class="pets-grid-container">
            <div id="pets-grid" class="pets-grid">
              <!-- Pet tiles populated dynamically -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Floating bottom badges -->
    <div class="pets-bottom-badges">
      <button id="pets-equip-best" class="pets-badge pets-badge--green">Equip Best</button>
      <button id="pets-unequip-all" class="pets-badge pets-badge--red">Unequip All</button>
      <button id="pets-trash-toggle" class="pets-badge pets-badge--icon" title="Delete pets">&#x1F5D1;&#xFE0F;</button>
    </div>

    <!-- Pet count badge at bottom center -->
    <div class="pets-count">
      <span id="pets-owned-count">0</span>/<span id="pets-max-count">50</span>
      <span class="pets-count__mult">x<span id="pets-multiplier-sum">1</span></span>
    </div>

    <!-- Delete confirmation bar -->
    <div id="pets-delete-bar" class="pets-delete-bar" hidden>
      <div id="pets-delete-text" class="pets-delete-bar__text">Delete 0 Pets!</div>
      <div class="pets-delete-bar__actions">
        <button id="pets-delete-confirm" class="pets-delete-bar__btn pets-delete-bar__btn--green" disabled>Confirm</button>
        <button id="pets-delete-cancel" class="pets-delete-bar__btn pets-delete-bar__btn--red">Cancel</button>
      </div>
    </div>
  </div>
</div>

<style>
  #pets-modal.visible {
    display: flex !important;
  }

  .pets-wrapper {
    position: relative;
    width: 800px;
    max-width: 95vw;
    font-family: "Fredoka", sans-serif;
    margin-top: 30px;
  }

  .pets-container {
    background: linear-gradient(180deg, rgba(30, 30, 40, 0.95), rgba(20, 20, 30, 0.95));
    border: 3px solid rgba(139, 69, 19, 0.9);
    border-radius: 16px;
    padding: 0;
    width: 100%;
    min-height: 70vh;
    max-height: 75vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.65);
    overflow: hidden;
    animation: petsSlideInUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .pets-wrapper.closing .pets-container {
    animation: petsSlideOutDown 0.4s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards;
  }

  @keyframes petsSlideInUp {
    from { opacity: 0; transform: translateY(60px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  @keyframes petsSlideOutDown {
    from { opacity: 1; transform: translateY(0) scale(1); }
    to { opacity: 0; transform: translateY(60px) scale(0.95); }
  }

  /* Title */
  .pets-title-container {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 100;
    background: linear-gradient(135deg, rgba(45, 106, 79, 0.95), rgba(34, 85, 65, 0.95));
    border: 3px solid rgba(100, 200, 150, 0.8);
    border-radius: 12px;
    padding: 6px 20px;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.7);
  }

  .pets-title {
    font-size: 20px;
    font-weight: 900;
    color: #fff;
    margin: 0;
    -webkit-text-stroke: 2px #000;
    paint-order: stroke fill;
  }

  /* Close button */
  .pets-close-btn {
    position: absolute;
    top: 0;
    right: 0;
    transform: translate(50%, -50%);
    background: linear-gradient(135deg, rgba(255, 71, 87, 0.95), rgba(220, 50, 65, 0.95));
    border: 3px solid rgba(255, 71, 87, 1);
    color: #fff;
    font-size: 16px;
    font-weight: 700;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    z-index: 100;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.7);
  }

  .pets-close-btn:hover {
    background: linear-gradient(135deg, rgba(255, 91, 107, 1), rgba(240, 60, 75, 1));
    transform: translate(50%, -50%) scale(1.1);
  }

  /* Content wrapper */
  .pets-content-wrapper {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* Left Panel - Compact Details */
  .pets-left-panel {
    width: 160px;
    min-width: 160px;
    display: flex;
    flex-direction: column;
    padding: 12px;
    background: linear-gradient(180deg, rgba(40, 35, 30, 0.9), rgba(30, 25, 20, 0.9));
    border-right: 2px solid rgba(139, 69, 19, 0.5);
  }

  .pets-details {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    height: 100%;
  }

  .pets-details__preview {
    background: rgba(0, 0, 0, 0.4);
    border: 2px solid rgba(139, 69, 19, 0.5);
    border-radius: 10px;
    width: 100px;
    height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }

  .pets-details__preview:hover {
    border-color: rgba(255, 215, 0, 0.6);
    box-shadow: 0 0 12px rgba(255, 215, 0, 0.3);
  }

  .pets-details__icon-wrapper {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .pets-details__icon-img {
    max-width: 80px;
    max-height: 80px;
    object-fit: contain;
  }

  .pets-details__icon-emoji {
    font-size: 50px;
  }

  .pets-details__mult-badge {
    position: absolute;
    bottom: 4px;
    right: 4px;
    padding: 2px 6px;
    border-radius: 6px;
    background: rgba(0, 0, 0, 0.7);
    color: #ffd700;
    font-weight: 900;
    font-size: 11px;
    border: 2px solid rgba(255, 215, 0, 0.5);
  }

  .pets-details__mult-badge:empty {
    display: none;
  }

  .pets-details__name {
    font-size: 14px;
    font-weight: 700;
    color: #fff;
    text-align: center;
    -webkit-text-stroke: 1px #000;
    paint-order: stroke fill;
  }

  .pets-details__stats {
    display: flex;
    flex-direction: column;
    gap: 4px;
    width: 100%;
    padding: 8px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 6px;
    border: 1px solid rgba(139, 69, 19, 0.3);
  }

  .pets-stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 11px;
    color: #fff;
  }

  .pets-stat-row__label {
    color: #a6b7d3;
    font-weight: 600;
  }

  .pets-stat-row__value {
    font-weight: 700;
  }

  .pets-stat-row__value--mult { color: #ffd700; }
  .pets-stat-row__value--rarity { color: #a855f7; }

  .pets-details__action-btn {
    width: 100%;
    padding: 8px 12px;
    margin-top: auto;
    border-radius: 6px;
    border: 2px solid rgba(34, 197, 94, 0.9);
    font-size: 12px;
    font-weight: 700;
    font-family: "Fredoka", sans-serif;
    cursor: pointer;
    transition: all 0.2s ease;
    background: linear-gradient(180deg, #22c55e, #15803d);
    color: #fff;
  }

  .pets-details__action-btn:hover:not(:disabled) {
    background: linear-gradient(180deg, #4ade80, #22c55e);
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
    transform: translateY(-2px);
  }

  .pets-details__action-btn:disabled {
    background: linear-gradient(180deg, rgba(100, 100, 100, 0.5), rgba(80, 80, 80, 0.5));
    border-color: rgba(100, 100, 100, 0.5);
    color: #666;
    cursor: not-allowed;
  }

  .pets-details__action-btn--unequip {
    background: linear-gradient(180deg, #ef4444, #b91c1c);
    border-color: rgba(239, 68, 68, 0.9);
  }

  /* Right Panel - Grid */
  .pets-right-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 12px;
    background: rgba(0, 0, 0, 0.3);
    overflow: hidden;
  }

  .pets-grid-container {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    min-height: 0;
  }

  .pets-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 10px;
    padding: 4px;
  }

  /* Pet tiles */
  .pet-tile {
    aspect-ratio: 1;
    border-radius: 10px;
    border: 3px solid rgba(0, 0, 0, 0.5);
    position: relative;
    cursor: pointer;
    padding: 6px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: all 0.2s ease;
  }

  .pet-tile:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
  }

  .pet-tile--common { background: linear-gradient(180deg, #6b7280, #4b5563); border-color: #6b7280; }
  .pet-tile--rare { background: linear-gradient(180deg, #3b82f6, #1d4ed8); border-color: #3b82f6; }
  .pet-tile--epic { background: linear-gradient(180deg, #a855f7, #6d28d9); border-color: #a855f7; }
  .pet-tile--legendary { background: linear-gradient(180deg, #facc15, #b45309); border-color: #facc15; }

  .pet-tile--equipped {
    outline: 3px solid rgba(255, 255, 255, 0.9);
    outline-offset: -5px;
  }

  .pet-tile--selected {
    outline: 3px solid #00d26a;
    outline-offset: -5px;
  }

  .pet-tile--delete-selected {
    outline: 3px solid #ff5252;
    outline-offset: -5px;
  }

  .pet-tile__img {
    width: 70%;
    height: 70%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .pet-tile__img-el {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .pet-tile__emoji {
    font-size: 32px;
  }

  .pet-tile__mult {
    position: absolute;
    bottom: 3px;
    right: 3px;
    padding: 2px 5px;
    border-radius: 6px;
    background: rgba(0, 0, 0, 0.7);
    color: #fff;
    font-weight: 800;
    font-size: 10px;
    border: 2px solid rgba(255, 255, 255, 0.3);
  }

  .pet-tile__delete-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    font-weight: 900;
    color: rgba(255, 0, 0, 0.9);
    text-shadow: 0 3px 0 rgba(0, 0, 0, 0.5);
    pointer-events: none;
  }

  .pets-empty {
    grid-column: 1 / -1;
    text-align: center;
    color: #a6b7d3;
    padding: 30px 16px;
    font-weight: 600;
    font-size: 13px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
  }

  .pets-empty__icon {
    font-size: 36px;
    opacity: 0.6;
  }

  .pets-empty__hint {
    font-size: 11px;
    color: #7a8ba3;
  }

  /* Floating bottom badges */
  .pets-bottom-badges {
    position: absolute;
    bottom: 0;
    right: 12px;
    transform: translateY(50%);
    display: flex;
    gap: 8px;
    z-index: 100;
  }

  .pets-badge {
    padding: 6px 14px;
    border-radius: 20px;
    border: 2px solid;
    font-size: 11px;
    font-weight: 700;
    font-family: "Fredoka", sans-serif;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
  }

  .pets-badge--green {
    background: linear-gradient(180deg, #22c55e, #15803d);
    border-color: rgba(34, 197, 94, 0.9);
    color: #fff;
  }

  .pets-badge--red {
    background: linear-gradient(180deg, #ef4444, #b91c1c);
    border-color: rgba(239, 68, 68, 0.9);
    color: #fff;
  }

  .pets-badge--icon {
    padding: 6px 10px;
    background: rgba(30, 30, 40, 0.95);
    border-color: rgba(139, 69, 19, 0.7);
    font-size: 14px;
  }

  .pets-badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.6);
  }

  .pets-badge--icon:hover {
    background: rgba(239, 68, 68, 0.3);
    border-color: rgba(239, 68, 68, 0.7);
  }

  .pets-badge--icon.active {
    background: rgba(239, 68, 68, 0.4);
    border-color: #ef4444;
  }

  /* Pet count badge at bottom center */
  .pets-count {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translate(-50%, 50%);
    font-size: 13px;
    color: #fff;
    font-weight: 700;
    background: linear-gradient(135deg, rgba(45, 106, 79, 0.95), rgba(34, 85, 65, 0.95));
    padding: 6px 16px;
    border-radius: 20px;
    border: 3px solid rgba(100, 200, 150, 0.8);
    z-index: 100;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .pets-count__mult {
    color: #ffd700;
    font-weight: 900;
  }

  /* Delete bar */
  .pets-delete-bar {
    position: absolute;
    bottom: 50px;
    left: 50%;
    transform: translateX(-50%);
    width: min(400px, 85%);
    border-radius: 12px;
    border: 3px solid rgba(239, 68, 68, 0.6);
    background: rgba(20, 20, 30, 0.95);
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    z-index: 10;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
  }

  .pets-delete-bar[hidden] {
    display: none !important;
  }

  .pets-delete-bar__text {
    font-size: 16px;
    font-weight: 900;
    color: #fff;
    text-align: center;
  }

  .pets-delete-bar__actions {
    display: flex;
    gap: 8px;
    justify-content: center;
  }

  .pets-delete-bar__btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: 2px solid;
    font-size: 12px;
    font-weight: 700;
    font-family: "Fredoka", sans-serif;
    cursor: pointer;
    min-width: 80px;
  }

  .pets-delete-bar__btn--green {
    background: linear-gradient(180deg, #22c55e, #15803d);
    border-color: rgba(34, 197, 94, 0.9);
    color: #fff;
  }

  .pets-delete-bar__btn--red {
    background: linear-gradient(180deg, #ef4444, #b91c1c);
    border-color: rgba(239, 68, 68, 0.9);
    color: #fff;
  }

  .pets-delete-bar__btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Scrollbar */
  .pets-grid-container::-webkit-scrollbar {
    width: 6px;
  }
  .pets-grid-container::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
  }
  .pets-grid-container::-webkit-scrollbar-thumb {
    background: rgba(139, 69, 19, 0.6);
    border-radius: 3px;
  }

  /* ========== MOBILE STYLES ========== */
  body.mobile .pets-wrapper {
    margin-top: 20px;
  }

  body.mobile .pets-container {
    min-height: 70vh;
    max-height: 75vh;
  }

  body.mobile .pets-title-container {
    padding: 5px 14px;
  }

  body.mobile .pets-title {
    font-size: 16px;
  }

  body.mobile .pets-close-btn {
    width: 32px;
    height: 32px;
    font-size: 14px;
  }

  /* Mobile: Keep side-by-side layout with smaller left panel */
  body.mobile .pets-left-panel {
    width: 130px;
    min-width: 130px;
    padding: 10px;
  }

  body.mobile .pets-details {
    gap: 6px;
  }

  body.mobile .pets-details__preview {
    width: 80px;
    height: 80px;
  }

  body.mobile .pets-details__icon-img {
    max-width: 60px;
    max-height: 60px;
  }

  body.mobile .pets-details__icon-emoji {
    font-size: 40px;
  }

  body.mobile .pets-details__name {
    font-size: 12px;
  }

  body.mobile .pets-details__stats {
    padding: 6px;
    gap: 3px;
  }

  body.mobile .pets-stat-row {
    font-size: 10px;
  }

  body.mobile .pets-details__action-btn {
    padding: 6px 10px;
    font-size: 11px;
  }

  body.mobile .pets-right-panel {
    padding: 10px;
  }

  body.mobile .pets-grid {
    grid-template-columns: repeat(auto-fill, minmax(65px, 1fr));
    gap: 8px;
  }

  body.mobile .pet-tile {
    padding: 4px;
  }

  body.mobile .pet-tile__emoji {
    font-size: 24px;
  }

  body.mobile .pet-tile__mult {
    font-size: 9px;
    padding: 1px 4px;
  }

  body.mobile .pets-bottom-badges {
    right: 8px;
    gap: 6px;
  }

  body.mobile .pets-badge {
    padding: 5px 10px;
    font-size: 10px;
  }

  body.mobile .pets-badge--icon {
    padding: 5px 8px;
    font-size: 12px;
  }

  body.mobile .pets-count {
    padding: 5px 12px;
    font-size: 11px;
    gap: 8px;
  }

  body.mobile .pets-delete-bar {
    bottom: 45px;
    padding: 8px;
  }

  body.mobile .pets-delete-bar__text {
    font-size: 14px;
  }

  body.mobile .pets-delete-bar__btn {
    padding: 6px 12px;
    font-size: 11px;
    min-width: 70px;
  }

  /* Mobile scrolling */
  body.mobile .pets-grid-container {
    touch-action: pan-y !important;
    -webkit-overflow-scrolling: touch !important;
  }
</style>

<script>
  (function() {
    const petsOverlay = document.getElementById("pets-modal");
    const petsCloseBtn = document.getElementById("pets-close-btn");
    const petsGrid = document.getElementById("pets-grid");
    const petsOwnedCount = document.getElementById("pets-owned-count");
    const petsMaxCount = document.getElementById("pets-max-count");
    const petsMultiplierSum = document.getElementById("pets-multiplier-sum");

    // Detail panel elements
    const petDetailName = document.getElementById("pet-detail-name");
    const petDetailImgEl = document.getElementById("pet-detail-img-el");
    const petDetailEmoji = document.getElementById("pet-detail-emoji");
    const petDetailMult = document.getElementById("pet-detail-mult");
    const petDetailStats = document.getElementById("pet-detail-stats");
    const petDetailAction = document.getElementById("pet-detail-action");

    // Badge elements (moved from footer)
    const petsEquipBest = document.getElementById("pets-equip-best");
    const petsUnequipAll = document.getElementById("pets-unequip-all");
    const petsTrashToggle = document.getElementById("pets-trash-toggle");

    // Delete bar elements
    const petsDeleteBar = document.getElementById("pets-delete-bar");
    const petsDeleteText = document.getElementById("pets-delete-text");
    const petsDeleteConfirm = document.getElementById("pets-delete-confirm");
    const petsDeleteCancel = document.getElementById("pets-delete-cancel");

    let petsData = null;
    let pets = [];
    let selectedPetId = null;
    let deleteMode = false;
    let petsToDelete = new Set();

    function openPetsModal() {
      petsOverlay.style.display = "flex";
      selectedPetId = null;
      deleteMode = false;
      petsToDelete.clear();

      const wrapper = document.querySelector(".pets-wrapper");
      wrapper.classList.remove("closing");
      void wrapper.offsetWidth;

      updateDeleteModeUI();
      hytopia.lockPointer(false, true);
      hytopia.sendData({ type: "GET_PETS_DATA" });
      if (window.setModalOpen) window.setModalOpen(true);
    }

    function closePetsModal() {
      const wrapper = document.querySelector(".pets-wrapper");
      wrapper.classList.add("closing");

      setTimeout(() => {
        petsOverlay.style.display = "none";
        petsOverlay.classList.remove("visible");
        wrapper.classList.remove("closing");
        deleteMode = false;
        petsToDelete.clear();
        updateDeleteModeUI();
      }, 400);

      hytopia.lockPointer(true);
      if (window.setModalOpen) window.setModalOpen(false);
    }

    function renderPetsGrid(data) {
      petsData = data;
      pets = data.pets || [];
      const maxPets = data.maxPets || 50;
      const maxEquipped = data.maxEquipped || 8;
      const equippedPets = pets.filter(p => p.equipped);

      // Update count badge
      petsOwnedCount.textContent = pets.length;
      petsMaxCount.textContent = maxPets;

      // Calculate total multiplier
      const totalMult = equippedPets.reduce((sum, p) => sum + (p.multiplier || 1), 0);
      petsMultiplierSum.textContent = totalMult > 0 ? totalMult.toFixed(1) : "0";

      if (pets.length === 0) {
        petsGrid.innerHTML = `
          <div class="pets-empty">
            <span class="pets-empty__icon">ðŸ¥š</span>
            <span>No pets yet!</span>
            <span class="pets-empty__hint">Visit an Egg Station to hatch pets</span>
          </div>
        `;
        renderPetDetail(null);
        return;
      }

      // Auto-select first pet if none selected
      if (!selectedPetId) {
        selectedPetId = pets[0].id;
      }

      // Sort: equipped first, then by multiplier desc
      const sortedPets = [...pets].sort((a, b) => {
        if (a.equipped !== b.equipped) return b.equipped - a.equipped;
        return (b.multiplier || 1) - (a.multiplier || 1);
      });

      petsGrid.innerHTML = sortedPets.map(pet => {
        const isSelected = pet.id === selectedPetId;
        const isEquipped = pet.equipped;
        const isDeleteSelected = petsToDelete.has(pet.id);
        const rarity = (pet.rarity || "common").toLowerCase();

        const cdn = (window.CDN_ASSETS_URL || "").replace(/\/$/, "");
        const iconPath = pet.icon ? (cdn ? `${cdn}/${pet.icon}` : `../${pet.icon}`) : null;

        let selectionClass = "";
        if (deleteMode && isDeleteSelected) selectionClass = "pet-tile--delete-selected";
        else if (!deleteMode && isSelected) selectionClass = "pet-tile--selected";

        return `
          <div class="pet-tile pet-tile--${rarity} ${isEquipped ? "pet-tile--equipped" : ""} ${selectionClass}" data-pet-id="${pet.id}">
            <div class="pet-tile__img">
              ${iconPath
                ? `<img class="pet-tile__img-el" src="${iconPath}" alt="${pet.name}" />`
                : `<span class="pet-tile__emoji">&#x1F43E;</span>`
              }
            </div>
            <div class="pet-tile__mult">x${pet.multiplier || 1}</div>
            ${deleteMode && isDeleteSelected ? '<div class="pet-tile__delete-overlay">âœ•</div>' : ''}
          </div>
        `;
      }).join("");

      // Add click handlers
      petsGrid.querySelectorAll(".pet-tile").forEach(tile => {
        tile.addEventListener("click", () => {
          const id = tile.dataset.petId;
          if (deleteMode) {
            if (petsToDelete.has(id)) {
              petsToDelete.delete(id);
            } else {
              petsToDelete.add(id);
            }
            updateDeleteModeUI();
            renderPetsGrid(petsData);
          } else {
            selectedPetId = id;
            const pet = pets.find(p => p.id === id);
            renderPetDetail(pet);
            renderPetsGrid(petsData);
          }
        });
      });

      // Update detail panel
      if (!deleteMode) {
        const selectedPet = pets.find(p => p.id === selectedPetId);
        renderPetDetail(selectedPet || null);
      } else {
        renderPetDetail(null);
      }
    }

    function renderPetDetail(pet) {
      if (!pet) {
        petDetailImgEl.style.display = "none";
        petDetailEmoji.style.display = "block";
        petDetailEmoji.innerHTML = "&#x1F43E;";
        petDetailName.textContent = "No Pet Selected";
        petDetailMult.textContent = "";
        petDetailStats.innerHTML = '<div class="pets-stat-row" style="justify-content: center; color: #7a8ba3;">Select a pet</div>';
        petDetailAction.textContent = "â€”";
        petDetailAction.disabled = true;
        petDetailAction.className = "pets-details__action-btn";
        return;
      }

      const cdn = (window.CDN_ASSETS_URL || "").replace(/\/$/, "");
      const iconPath = pet.icon ? (cdn ? `${cdn}/${pet.icon}` : `../${pet.icon}`) : null;

      if (iconPath) {
        petDetailImgEl.src = iconPath;
        petDetailImgEl.style.display = "block";
        petDetailEmoji.style.display = "none";
      } else {
        petDetailImgEl.style.display = "none";
        petDetailEmoji.style.display = "block";
        petDetailEmoji.innerHTML = "&#x1F43E;";
      }

      petDetailName.textContent = pet.name || "Pet";
      petDetailMult.textContent = `x${pet.multiplier || 1}`;

      const rarity = (pet.rarity || "common").toLowerCase();
      let statsHtml = '';
      statsHtml += `<div class="pets-stat-row"><span class="pets-stat-row__label">Multiplier</span><span class="pets-stat-row__value pets-stat-row__value--mult">x${pet.multiplier || 1}</span></div>`;
      statsHtml += `<div class="pets-stat-row"><span class="pets-stat-row__label">Rarity</span><span class="pets-stat-row__value pets-stat-row__value--rarity">${rarity.charAt(0).toUpperCase() + rarity.slice(1)}</span></div>`;
      petDetailStats.innerHTML = statsHtml;

      petDetailAction.disabled = false;
      if (pet.equipped) {
        petDetailAction.textContent = "Unequip";
        petDetailAction.className = "pets-details__action-btn pets-details__action-btn--unequip";
      } else {
        petDetailAction.textContent = "Equip";
        petDetailAction.className = "pets-details__action-btn";
      }
    }

    function updateDeleteModeUI() {
      petsTrashToggle.classList.toggle("active", deleteMode);

      if (deleteMode) {
        petsDeleteBar.hidden = false;
        petsDeleteText.textContent = `Delete ${petsToDelete.size} Pet${petsToDelete.size !== 1 ? 's' : ''}!`;
        petsDeleteConfirm.disabled = petsToDelete.size === 0;
        renderPetDetail(null);
      } else {
        petsDeleteBar.hidden = true;
        petsToDelete.clear();
      }
    }

    // Event listeners
    petsCloseBtn?.addEventListener("click", closePetsModal);

    petDetailAction?.addEventListener("click", () => {
      if (petDetailAction.disabled) return;
      if (!selectedPetId) return;
      const pet = pets.find(p => p.id === selectedPetId);
      if (!pet) return;

      if (pet.equipped) {
        hytopia.sendData({ type: "UNEQUIP_PET", petId: selectedPetId });
      } else {
        hytopia.sendData({ type: "EQUIP_PET", petId: selectedPetId });
      }
    });

    petsEquipBest?.addEventListener("click", () => {
      hytopia.sendData({ type: "EQUIP_BEST_PETS" });
    });

    petsUnequipAll?.addEventListener("click", () => {
      hytopia.sendData({ type: "UNEQUIP_ALL_PETS" });
    });

    petsTrashToggle?.addEventListener("click", () => {
      deleteMode = !deleteMode;
      petsToDelete.clear();
      updateDeleteModeUI();
      if (petsData) renderPetsGrid(petsData);
    });

    petsDeleteConfirm?.addEventListener("click", () => {
      if (petsToDelete.size === 0) return;
      hytopia.sendData({ type: "DELETE_PETS", petIds: Array.from(petsToDelete) });
      deleteMode = false;
      petsToDelete.clear();
      updateDeleteModeUI();
    });

    petsDeleteCancel?.addEventListener("click", () => {
      deleteMode = false;
      petsToDelete.clear();
      updateDeleteModeUI();
      if (petsData) renderPetsGrid(petsData);
    });

    // Listen for data from server
    hytopia.onData(data => {
      if (data.type === "PETS_DATA") {
        renderPetsGrid(data);
      }
      if (data.type === "OPEN_PETS_MODAL") {
        openPetsModal();
      }
    });

    // Global function to open modal
    window.openPetsModal = openPetsModal;

    // Attach click sounds
    if (typeof window.attachClickSounds === "function") {
      window.attachClickSounds(petsCloseBtn);
      window.attachClickSounds(petDetailAction);
      window.attachClickSounds(petsEquipBest);
      window.attachClickSounds(petsUnequipAll);
      window.attachClickSounds(petsTrashToggle);
      window.attachClickSounds(petsDeleteConfirm);
      window.attachClickSounds(petsDeleteCancel);
    }
  })();
</script>


<!-- Included from: ./components/MapsModal.html -->
<!-- Maps Modal -->
<div
  id="maps-modal"
  class="hud"
  style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.6);
    z-index: 11000;
  "
>
  <div class="maps-wrapper">
    <!-- Title container -->
    <div class="maps-title-container">
      <h2 class="maps-title">WORLDS</h2>
    </div>
    <!-- Close button -->
    <button id="maps-close-btn" class="maps-close-btn">X</button>

    <div class="maps-container">
      <div class="maps-content">
        <div id="maps-grid" class="maps-grid">
          <!-- World cards populated dynamically -->
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Support for .visible class from legacy code */
  #maps-modal.visible {
    display: flex !important;
  }

  .maps-wrapper {
    position: relative;
    width: 700px;
    max-width: 95vw;
    font-family: "Fredoka", sans-serif;
    margin-top: 40px;
  }

  .maps-container {
    background: linear-gradient(
      180deg,
      rgba(20, 25, 40, 0.95),
      rgba(15, 18, 30, 0.95)
    );
    border: 3px solid rgba(55, 214, 232, 0.6);
    border-radius: 16px;
    padding: 0;
    width: 100%;
    max-height: 75vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 0 30px rgba(55, 214, 232, 0.2), 0 0 60px rgba(0, 0, 0, 0.65);
    overflow: hidden;
    animation: mapsSlideInUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .maps-wrapper.closing .maps-container {
    animation: mapsSlideOutDown 0.4s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards;
  }

  @keyframes mapsSlideInUp {
    from {
      opacity: 0;
      transform: translateY(60px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  @keyframes mapsSlideOutDown {
    from {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
    to {
      opacity: 0;
      transform: translateY(60px) scale(0.95);
    }
  }

  .maps-title-container {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 100;
    background: linear-gradient(
      135deg,
      rgba(55, 214, 232, 0.95),
      rgba(37, 99, 235, 0.95)
    );
    border: 3px solid rgba(55, 214, 232, 0.9);
    border-radius: 12px;
    padding: 8px 24px;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.7);
  }

  .maps-title {
    font-size: 24px;
    font-weight: 900;
    color: #fff;
    margin: 0;
    -webkit-text-stroke: 2px #000;
    paint-order: stroke fill;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .maps-close-btn {
    position: absolute;
    top: 0;
    right: 0;
    transform: translate(50%, -50%);
    background: linear-gradient(
      135deg,
      rgba(255, 71, 87, 0.95),
      rgba(220, 50, 65, 0.95)
    );
    border: 3px solid rgba(255, 71, 87, 1);
    color: #fff;
    font-size: 18px;
    font-weight: 700;
    width: 40px;
    height: 40px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    z-index: 100;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.7);
  }

  .maps-close-btn:hover {
    background: linear-gradient(
      135deg,
      rgba(255, 91, 107, 1),
      rgba(240, 60, 75, 1)
    );
    border-color: #ff4757;
    transform: translate(50%, -50%) scale(1.1);
  }

  .maps-content {
    padding: 24px 20px 20px;
    overflow-y: auto;
  }

  .maps-grid {
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .maps-card {
    position: relative;
    display: grid;
    grid-template-columns: 1fr auto;
    grid-template-rows: auto auto;
    gap: 6px 16px;
    padding: 16px 18px;
    background: linear-gradient(
      135deg,
      rgba(30, 35, 55, 0.9),
      rgba(20, 25, 40, 0.9)
    );
    border: 2px solid rgba(55, 214, 232, 0.3);
    border-radius: 14px;
    transition: all 0.2s ease;
    overflow: hidden;
  }

  .maps-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
      120deg,
      rgba(55, 214, 232, 0.05),
      transparent 50%,
      rgba(255, 215, 0, 0.05)
    );
    pointer-events: none;
  }

  .maps-card:hover:not(.maps-card--locked) {
    border-color: rgba(55, 214, 232, 0.6);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
  }

  .maps-card--current {
    border-color: rgba(76, 175, 80, 0.8);
    box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
  }

  .maps-card--current::before {
    background: linear-gradient(
      120deg,
      rgba(76, 175, 80, 0.1),
      transparent 50%
    );
  }

  .maps-card--locked {
    opacity: 0.6;
    border-color: rgba(100, 100, 100, 0.4);
  }

  .maps-card__name {
    font-size: 20px;
    font-weight: 900;
    color: #fff;
    -webkit-text-stroke: 1px #000;
    paint-order: stroke fill;
    position: relative;
    z-index: 1;
  }

  .maps-card__info {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
    position: relative;
    z-index: 1;
  }

  .maps-card__badge {
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .maps-card__badge--multiplier {
    background: rgba(255, 215, 0, 0.15);
    border: 1px solid rgba(255, 215, 0, 0.5);
    color: #ffd700;
  }

  .maps-card__badge--current {
    background: rgba(76, 175, 80, 0.15);
    border: 1px solid rgba(76, 175, 80, 0.5);
    color: #4caf50;
  }

  .maps-card__badge--locked {
    background: rgba(255, 82, 82, 0.15);
    border: 1px solid rgba(255, 82, 82, 0.5);
    color: #ff5252;
  }

  .maps-card__actions {
    grid-column: 2;
    grid-row: 1 / span 2;
    display: flex;
    align-items: center;
    gap: 8px;
    position: relative;
    z-index: 1;
  }

  .maps-card__btn {
    padding: 10px 20px;
    border-radius: 10px;
    border: 2px solid;
    font-size: 14px;
    font-weight: 700;
    font-family: "Fredoka", sans-serif;
    cursor: pointer;
    transition: all 0.2s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .maps-card__btn--teleport {
    background: linear-gradient(180deg, #4be7f5, #37d6e8);
    border-color: rgba(55, 214, 232, 0.9);
    color: #0b1220;
    box-shadow: 0 4px 12px rgba(55, 214, 232, 0.3);
  }

  .maps-card__btn--teleport:hover:not(:disabled) {
    background: linear-gradient(180deg, #6df0fc, #4be7f5);
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(55, 214, 232, 0.5);
  }

  .maps-card__btn--teleport:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    filter: grayscale(0.5);
    transform: none;
  }

  .maps-card__btn--unlock {
    background: linear-gradient(180deg, #ffd700, #ffb700);
    border-color: rgba(255, 215, 0, 0.9);
    color: #0b1220;
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
  }

  .maps-card__btn--unlock:hover:not(:disabled) {
    background: linear-gradient(180deg, #ffed4e, #ffd700);
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(255, 215, 0, 0.5);
  }

  .maps-card__btn--unlock:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    filter: grayscale(0.5);
    transform: none;
  }

  .maps-empty {
    text-align: center;
    color: #cdd8f3;
    padding: 40px 0;
    font-weight: 700;
  }

  /* Scrollbar styling */
  .maps-content::-webkit-scrollbar {
    width: 8px;
  }

  .maps-content::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 4px;
  }

  .maps-content::-webkit-scrollbar-thumb {
    background: rgba(55, 214, 232, 0.4);
    border-radius: 4px;
  }

  .maps-content::-webkit-scrollbar-thumb:hover {
    background: rgba(55, 214, 232, 0.6);
  }

  /* Mobile scrolling support */
  body.mobile .maps-content,
  body.mobile .maps-grid {
    touch-action: pan-y !important;
    -webkit-overflow-scrolling: touch !important;
  }

  /* Mobile-specific responsive styles */
  body.mobile .maps-wrapper {
    margin-top: 20px;
  }

  body.mobile .maps-title-container {
    padding: 6px 16px;
  }

  body.mobile .maps-title {
    font-size: 18px;
    -webkit-text-stroke: 1.5px #000;
    letter-spacing: 1px;
  }

  body.mobile .maps-close-btn {
    width: 36px;
    height: 36px;
    font-size: 16px;
  }

  body.mobile .maps-content {
    padding: 20px 16px 16px;
  }

  body.mobile .maps-grid {
    gap: 10px;
  }

  body.mobile .maps-card {
    padding: 12px 14px;
    gap: 4px 12px;
  }

  body.mobile .maps-card__name {
    font-size: 16px;
  }

  body.mobile .maps-card__badge {
    padding: 3px 8px;
    font-size: 9px;
  }

  body.mobile .maps-card__btn {
    padding: 8px 14px;
    font-size: 12px;
  }
</style>

<script>
  (function() {
    const mapsOverlay = document.getElementById("maps-modal");
    const mapsCloseBtn = document.getElementById("maps-close-btn");
    const mapsGrid = document.getElementById("maps-grid");

    let mapsData = null;

    function openMapsModal() {
      mapsOverlay.style.display = "flex";

      const wrapper = document.querySelector(".maps-wrapper");
      wrapper.classList.remove("closing");
      void wrapper.offsetWidth;

      hytopia.lockPointer(false, true);
      hytopia.sendData({ type: "OPEN_WORLDS_PANEL" });
      if (window.setModalOpen) window.setModalOpen(true);
    }

    function closeMapsModal() {
      const wrapper = document.querySelector(".maps-wrapper");
      wrapper.classList.add("closing");

      setTimeout(() => {
        mapsOverlay.style.display = "none";
        mapsOverlay.classList.remove("visible");
        wrapper.classList.remove("closing");
      }, 400);

      hytopia.lockPointer(true);
      if (window.setModalOpen) window.setModalOpen(false);
    }

    function renderMapsGrid(data) {
      mapsData = data;
      const { worlds } = data;

      if (!worlds || worlds.length === 0) {
        mapsGrid.innerHTML = '<div class="maps-empty">No worlds available.</div>';
        return;
      }

      mapsGrid.innerHTML = worlds.map((world, index) => {
        // Support both old format (isCurrent, isUnlocked) and new format (unlocked)
        const isCurrent = world.isCurrent || false;
        const isUnlocked = world.isUnlocked !== undefined ? world.isUnlocked : (world.unlocked || false);
        const multiplier = world.trophyMultiplier || world.multiplier || 1;
        const winsRequired = world.unlockRequirement?.amount || world.winsRequired || 0;

        return `
          <div class="maps-card ${isCurrent ? 'maps-card--current' : ''} ${!isUnlocked ? 'maps-card--locked' : ''}"
               data-id="${world.id}">
            <div class="maps-card__name">${world.name}</div>
            <div class="maps-card__info">
              ${multiplier > 1 ? `<span class="maps-card__badge maps-card__badge--multiplier">x${multiplier} Trophies</span>` : ''}
              ${isCurrent ? '<span class="maps-card__badge maps-card__badge--current">Current</span>' : ''}
              ${!isUnlocked && winsRequired > 0 ? `<span class="maps-card__badge maps-card__badge--locked">${winsRequired} Wins Required</span>` : ''}
            </div>
            <div class="maps-card__actions">
              ${isUnlocked && !isCurrent
                ? `<button class="maps-card__btn maps-card__btn--teleport" data-action="teleport" data-id="${world.id}">Teleport</button>`
                : ''
              }
              ${!isUnlocked
                ? `<button class="maps-card__btn maps-card__btn--unlock" data-action="unlock" data-id="${world.id}">Unlock</button>`
                : ''
              }
              ${isCurrent ? '<span style="color: #4caf50; font-weight: 700;">You are here</span>' : ''}
            </div>
          </div>
        `;
      }).join('');

      // Add click handlers
      mapsGrid.querySelectorAll('.maps-card__btn').forEach(btn => {
        if (typeof window.attachClickSounds === "function") {
          window.attachClickSounds(btn);
        }

        btn.addEventListener('click', () => {
          if (btn.disabled) return;
          const action = btn.dataset.action;
          const worldId = btn.dataset.id;

          if (action === "teleport") {
            hytopia.sendData({
              type: "TELEPORT_TO_WORLD",
              payload: { worldId }
            });
            closeMapsModal();
          } else if (action === "unlock") {
            hytopia.sendData({
              type: "UNLOCK_WORLD",
              payload: { worldId }
            });
          }
        });
      });
    }

    // Event listeners
    mapsCloseBtn?.addEventListener("click", closeMapsModal);

    // Close when clicking outside
    mapsOverlay?.addEventListener("click", (e) => {
      if (e.target === mapsOverlay) {
        closeMapsModal();
      }
    });

    // Keyboard shortcuts
    document.addEventListener("keydown", (e) => {
      if (mapsOverlay.style.display !== "flex") return;
      if (e.key === "Escape") {
        closeMapsModal();
        e.preventDefault();
        e.stopPropagation();
      }
    });

    // Attach click sounds
    if (typeof window.attachClickSounds === "function") {
      window.attachClickSounds(mapsCloseBtn);
    }

    // Listen for data events
    hytopia.onData((data) => {
      if (data?.type === "WORLDS_PANEL_DATA") {
        renderMapsGrid({ worlds: data.worlds || [] });
      }

      if (data?.type === "OPEN_MAPS_MODAL") {
        openMapsModal();
      }

      if (data?.type === "WORLD_UNLOCK_SUCCESS" || data?.type === "WORLD_UNLOCKED") {
        hytopia.sendData({ type: "OPEN_WORLDS_PANEL" });
      }
    });

    // Expose globally
    window.openMapsModal = openMapsModal;
    window.closeMapsModal = closeMapsModal;
  })();
</script>


<!-- Included from: ./components/TrainingPrompt.html -->
<!-- Training Prompt -->
<div id="training-prompt" class="training-prompt">
  <div id="training-prompt-key" class="training-prompt__key">E</div>
  <div class="training-prompt__copy">
    <div id="training-prompt-title" class="training-prompt__title">Interact</div>
    <div id="training-prompt-subtitle" class="training-prompt__subtitle">0 Power OR 0 Rebirths</div>
  </div>
</div>


<!-- Included from: ./components/PowerGainLayer.html -->
<!-- Power Gain Floating Text Layer -->
<div id="power-gain-layer" class="power-gain-layer"></div>


<!-- Included from: ./components/MineResetTimer.html -->
<!-- Mine Reset Timer (Bottom Right - Compact) -->
<div id="mine-reset-timer" class="mine-reset-timer">
  <div id="mine-reset-timer-text" class="mine-reset-timer__text">02:00</div>
</div>

<!-- Mining Depth Counter (Right side, near progress bar) -->
<div id="mining-depth-counter" class="mining-depth-counter">
  <div id="mining-depth-counter-text" class="mining-depth-counter__text">0 / 1000</div>
</div>


<!-- Included from: ./components/BlockHealthBar.html -->
<!-- Mining Target Display (Bottom Center, Above Progress Bar) -->
<div id="block-health-bar" class="block-health-bar">
  <!-- Header row: name on left, reward on right (for mobile layout) -->
  <div class="block-health-bar__header">
    <div id="block-health-bar-name" class="block-health-bar__name">Diamond</div>
    <!-- Sell Value (for ores) or Gem Reward (for chests) -->
    <div id="block-reward-display" class="block-health-bar__reward"></div>
  </div>
  <div class="block-health-bar__container">
    <div class="block-health-bar__outline">
      <div id="block-health-bar-fill" class="block-health-bar__fill"></div>
    </div>
    <div id="block-health-bar-text" class="block-health-bar__text">0/100 HP</div>
  </div>
</div>


<!-- Included from: ./components/MiningHUD.html -->
<!-- Mining HUD -->
<div id="mining-hud" class="mining-hud">
  <!-- Bottom Middle Right: Damage Display -->
  <div id="damage-display" class="mining-hud__damage"></div>
</div>

<!-- Mined Ore Popup Layer -->
<div id="mined-ore-layer" class="mined-ore-layer"></div>

<!-- Damage Popup Layer -->
<div id="damage-popup-layer" class="damage-popup-layer"></div>


<!-- Included from: ./components/MerchantUI.html -->
<!-- Merchant Selling UI -->
<div id="merchant-ui" class="merchant-ui">
  <div class="merchant-ui__header">
    <div class="merchant-ui__title-group">
      <div class="merchant-ui__title">Ores</div>
      <div class="merchant-ui__subtitle">Ore Shop</div>
    </div>
    <button id="merchant-ui-close" class="merchant-ui__close">Ã—</button>
  </div>
  <div id="merchant-ui-content" class="merchant-ui__content">
    <!-- Ore items will be dynamically added here -->
  </div>
  <div class="merchant-ui__footer">
    <button id="merchant-ui-sell-all" class="merchant-ui__sell-all-button">Sell All</button>
  </div>
</div>


<!-- Included from: ./components/MineResetUpgradeUI.html -->
<!-- Mine Reset Upgrade UI -->
<div id="mine-reset-upgrade-ui" class="mine-reset-upgrade-ui">
  <div class="mine-reset-upgrade-ui__header">
    <div class="mine-reset-upgrade-ui__title-group">
      <div class="mine-reset-upgrade-ui__title">Mine Reset Upgrade</div>
      <div class="mine-reset-upgrade-ui__subtitle">Timer Shop</div>
    </div>
    <button id="mine-reset-upgrade-ui-close" class="mine-reset-upgrade-ui__close">Ã—</button>
  </div>
  <div class="mine-reset-upgrade-ui__body">
    <div class="mine-reset-upgrade-ui__description">
      Increase your mine reset timer from 2 minutes to 5 minutes!
    </div>
    <div class="mine-reset-upgrade-ui__button-container">
      <button id="mine-reset-upgrade-button" class="mine-reset-upgrade-ui__button">
        <span class="mine-reset-upgrade-ui__button-text">2M</span>
      </button>
    </div>
    <div class="mine-reset-upgrade-ui__status" id="mine-reset-upgrade-status">
      <!-- Status will be updated dynamically -->
    </div>
  </div>
</div>


<!-- Included from: ./components/GemTraderUI.html -->
<!-- Gem Trader Upgrades UI -->
<div id="gem-trader-ui" class="gem-trader-ui">
  <div class="gem-trader-ui__header">
    <button class="gem-trader-ui__help-button">?</button>
    <div class="gem-trader-ui__title-group">
      <div class="gem-trader-ui__title">Upgrades</div>
      <div class="gem-trader-ui__subtitle">Upgrades Shop</div>
    </div>
    <button id="gem-trader-ui-close" class="gem-trader-ui__close">Ã—</button>
  </div>
  <div id="gem-trader-ui-content" class="gem-trader-ui__content">
    <!-- Upgrade items will be dynamically added here -->
  </div>
</div>


<!-- Included from: ./components/ProgressBar.html -->
<!-- Progress Bar (Bottom) -->
<div id="progress-bar" class="progress-bar">
  <div class="progress-bar__container">
    <div class="progress-bar__outline">
      <div id="progress-bar-fill" class="progress-bar__fill"></div>
      <div id="progress-bar-marker" class="progress-bar__marker"></div>
    </div>
    <div class="progress-bar__markers">
      <span class="progress-bar__marker-label">0</span>
      <span class="progress-bar__marker-label">250</span>
      <span class="progress-bar__marker-label">500</span>
      <span class="progress-bar__marker-label">750</span>
      <span class="progress-bar__marker-label">1000</span>
    </div>
  </div>
</div>


<!-- Included from: ./components/MiningControls.html -->
<!-- Mining Controls (Visible when in mines) -->
<div id="mining-controls" class="mining-controls">
  <!-- Mining controls content here if needed -->
</div>

<!-- To Surface Button (Always Visible) -->
<button id="to-surface-button" class="mining-control-button mining-control-button--surface">
  To Surface
</button>


<!-- Included from: ./components/AutoControls.html -->
<!-- Auto Controls (Right Side) -->
<div class="auto-controls">
  <!-- Auto Mine Button -->
  <button id="auto-mine-button" class="auto-control-button auto-control-button--mine inactive">
    Auto Mine
  </button>
  <!-- Auto Train Button -->
  <button id="auto-train-button" class="auto-control-button auto-control-button--train">
    Auto Train
  </button>
</div>

<!-- Close the ui-root div that was opened in an earlier component -->
</div>


<!-- Included from: ./components/Styles.html -->
<style>
  :root {
    font-family: "Fredoka", sans-serif;
    color: #fff;
  }

  body {
    margin: 0;
    padding: 0;
  }

  body.loading .ui-root {
    pointer-events: none;
  }

  .loading-screen {
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 10000;
    display: none;
  }

  .loading-screen.visible {
    display: block;
  }

  .ui-root {
    position: fixed;
    inset: 0;
    pointer-events: none;
  }

  /* Ensure all interactive UI elements capture clicks and prevent them from reaching the game */
  .ui-root button,
  .ui-root .action-card,
  .ui-root .modal,
  .ui-root .pickaxe-card,
  .ui-root .rebirth-option,
  .ui-root .merchant-ui__item,
  .ui-root .gem-trader-ui__item {
    pointer-events: auto;
  }

  /* Mobile controls (existing boilerplate) */
  .mobile-controls {
    display: none;
  }

  body.mobile .mobile-controls {
    display: flex;
    gap: 14px;
    position: fixed;
    bottom: 40px;
    right: 40px;
    pointer-events: auto;
  }

  .mobile-button {
    background-color: rgba(0, 0, 0, 0.5);
    border-radius: 50%;
    align-items: center;
    justify-content: center;
    display: flex;
    width: 50px;
    height: 50px;
    transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    font-size: 14px;
    font-weight: bold;
    color: rgba(255, 255, 255, 0.8);
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    pointer-events: auto;
  }
  
  .mobile-button img {
    width: 22px;
    height: 22px;
  }

  .mobile-button.active {
    transform: scale(0.92);
    background-color: rgba(0, 0, 0, 0.75);
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
  }

  /* Stats HUD Container (Middle Right) */
  .stats-hud-container {
    position: fixed;
    top: 50%;
    right: 40px;
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    gap: 12px;
    z-index: 1000;
  }

  /* Stat HUD (Blue Box Style) */
  .stat-hud {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    min-width: 180px;
    border-radius: 12px;
    border: 3px solid #1a3a5c;
    background: linear-gradient(180deg, rgba(30, 60, 100, 0.95), rgba(20, 40, 70, 0.98));
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(4px);
  }

  .stat-hud__value {
    font-size: 24px;
    font-weight: 700;
    color: #ffd700;
    text-shadow: 
      0 0 8px rgba(255, 215, 0, 0.6),
      0 2px 4px rgba(0, 0, 0, 0.8),
      -1px -1px 0 rgba(0, 0, 0, 0.5),
      1px -1px 0 rgba(0, 0, 0, 0.5),
      -1px 1px 0 rgba(0, 0, 0, 0.5),
      1px 1px 0 rgba(0, 0, 0, 0.5);
    flex: 1;
    text-align: left;
  }

  .stat-hud--money .stat-hud__value {
    color: #ffd700;
  }

  .stat-hud--gems .stat-hud__value {
    color: #4caf50;
  }

  .stat-hud--power .stat-hud__value {
    color: #ff5252;
  }

  .stat-hud--rebirths .stat-hud__value {
    color: #4caf50;
  }

  .stat-hud--wins .stat-hud__value {
    color: #ffd700;
  }

  .stat-hud__icon {
    font-size: 32px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.6));
    margin-left: 12px;
  }

  /* Left-side action buttons */
  .left-actions {
    position: fixed;
    left: 32px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    gap: 12px;
    z-index: 1000;
  }

  .action-card {
    width: 72px;
    height: 72px;
    border-radius: 12px;
    border: 3px solid #1a3a5c;
    background: linear-gradient(180deg, rgba(30, 60, 100, 0.95), rgba(20, 40, 70, 0.98));
    box-shadow: 0 4px 18px rgba(0, 0, 0, 0.45);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    cursor: pointer;
    transition: transform 0.12s ease, box-shadow 0.12s ease;
    pointer-events: auto;
  }

  .action-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 22px rgba(0, 0, 0, 0.55);
  }

  .action-card:active {
    transform: translateY(0);
    box-shadow: 0 3px 12px rgba(0, 0, 0, 0.45);
  }

  .action-card__icon {
    font-size: 32px;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.6));
  }

  .action-card__badge {
    position: absolute;
    top: -6px;
    right: -6px;
    width: 22px;
    height: 22px;
    background: #e53935;
    color: #fff;
    border-radius: 50%;
    border: 2px solid #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 800;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
  }

  /* Pets action button accent */
  .action-card--pets {
    border-color: #2d6a4f;
    background: linear-gradient(180deg, rgba(45, 106, 79, 0.95), rgba(26, 77, 56, 0.98));
  }

  /* Egg + Pets UI helpers (use existing modal styles as the base) */
  .egg-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 14px;
  }

  .egg-results__title {
    font-weight: 800;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 8px;
  }

  .egg-results__list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 320px;
    overflow: auto;
    padding-right: 4px;
  }

  .egg-result-item {
    background: rgba(0, 0, 0, 0.25);
    border: 2px solid rgba(255, 255, 255, 0.12);
    border-radius: 10px;
    padding: 10px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: rgba(255, 255, 255, 0.92);
  }

  .egg-result-item__name {
    font-weight: 800;
  }

  .egg-result-item__mult {
    color: #ffd700;
    font-weight: 900;
  }

  .egg-shop {
    margin-top: 14px;
    padding-top: 10px;
    border-top: 2px solid rgba(255, 255, 255, 0.12);
  }

  .egg-shop__header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 8px;
  }

  .egg-shop__title {
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: rgba(255, 255, 255, 0.95);
  }

  .egg-shop__subtitle {
    font-size: 12px;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.6);
  }

  .egg-shop-grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 10px;
    max-height: 320px;
    overflow: auto;
    padding-right: 4px;
  }

  .egg-shop-empty {
    opacity: 0.7;
    font-size: 13px;
  }

  .egg-shop-card {
    border: 2px solid rgba(255, 255, 255, 0.12);
    border-radius: 12px;
    background: rgba(0, 0, 0, 0.25);
    padding: 8px 6px 10px;
    position: relative;
    cursor: pointer;
    color: rgba(255, 255, 255, 0.92);
    transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
  }

  .egg-shop-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 14px rgba(0, 0, 0, 0.35);
  }

  .egg-shop-card.is-auto-delete {
    border-color: rgba(239, 68, 68, 0.7);
    box-shadow: 0 0 12px rgba(239, 68, 68, 0.35);
  }

  .egg-shop-card__chance {
    position: absolute;
    top: 6px;
    left: 6px;
    padding: 2px 6px;
    border-radius: 999px;
    background: rgba(0, 0, 0, 0.45);
    font-size: 12px;
    font-weight: 800;
  }

  .egg-shop-card__auto {
    position: absolute;
    top: 6px;
    right: 6px;
    width: 22px;
    height: 22px;
    border-radius: 6px;
    background: rgba(239, 68, 68, 0.9);
    color: #fff;
    font-weight: 900;
    display: none;
    align-items: center;
    justify-content: center;
  }

  .egg-shop-card.is-auto-delete .egg-shop-card__auto {
    display: flex;
  }

  .egg-shop-card__thumb {
    width: 64px;
    height: 64px;
    margin: 18px auto 6px;
    border-radius: 10px;
    background: rgba(0, 0, 0, 0.35);
    border: 2px solid rgba(255, 255, 255, 0.12);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    overflow: hidden;
  }

  .egg-shop-card__thumb img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .egg-shop-card__name {
    text-align: center;
    font-size: 12px;
    font-weight: 800;
    line-height: 1.1;
  }

  .egg-shop-card--common {
    border-color: rgba(148, 163, 184, 0.6);
  }

  .egg-shop-card--rare {
    border-color: rgba(59, 130, 246, 0.7);
  }

  .egg-shop-card--epic {
    border-color: rgba(168, 85, 247, 0.75);
  }

  .egg-shop-card--legendary {
    border-color: rgba(245, 158, 11, 0.8);
  }

  .pets-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 12px;
    max-height: 420px;
    overflow: auto;
    padding-right: 4px;
  }

  .pet-row {
    background: rgba(0, 0, 0, 0.25);
    border: 2px solid rgba(255, 255, 255, 0.12);
    border-radius: 12px;
    padding: 10px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: rgba(255, 255, 255, 0.92);
    gap: 10px;
  }

  .pet-row__left {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .pet-row__name {
    font-weight: 900;
  }

  .pet-row__meta {
    opacity: 0.85;
    font-size: 13px;
  }

  .pet-row__btn {
    border-radius: 10px;
    border: 2px solid rgba(255, 255, 255, 0.18);
    background: rgba(255, 255, 255, 0.06);
    color: #fff;
    font-weight: 900;
    padding: 8px 10px;
    cursor: pointer;
  }

  .pet-row__btn:hover {
    background: rgba(255, 255, 255, 0.12);
  }

  /* Pets grid UI (reference-style) */
  .pets-topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
    gap: 12px;
  }

  .pets-topbar__left {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .pets-pill {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    border-radius: 14px;
    border: 3px solid rgba(0, 0, 0, 0.25);
    background: rgba(20, 40, 70, 0.35);
    color: #fff;
    font-weight: 900;
    text-shadow: 0 2px 0 rgba(0, 0, 0, 0.55);
  }

  .pets-pill__icon {
    font-size: 18px;
  }

  .pets-mult {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 14px;
    border-radius: 16px;
    border: 3px solid rgba(0, 0, 0, 0.25);
    background: rgba(20, 40, 70, 0.35);
    color: #ffcc00;
    font-weight: 900;
    text-shadow: 0 2px 0 rgba(0, 0, 0, 0.55);
    font-size: 20px;
  }

  .pets-content {
    display: flex;
    gap: 16px;
    flex: 1;
    min-height: 0; /* allow children to scroll */
  }

  .pets-grid {
    display: grid;
    /* Fixed 4 columns for consistent spacing, scroll vertically */
    grid-template-columns: repeat(4, 1fr);
    gap: 14px;
    padding: 16px;
    border-radius: 18px;
    border: 4px solid rgba(0, 0, 0, 0.25);
    background: rgba(10, 20, 40, 0.18);
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    min-height: 0;
    align-content: start; /* Start items at the top */
    grid-auto-rows: min-content; /* Prevent row overlap */
  }

  .pet-detail {
    width: 360px;
    flex: 0 0 360px;
    border-radius: 18px;
    border: 4px solid rgba(0, 0, 0, 0.25);
    background: rgba(20, 40, 70, 0.35);
    padding: 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }

  .pet-detail__close {
    align-self: flex-start;
    width: 48px;
    height: 48px;
    border-radius: 14px;
    border: 4px solid rgba(0, 0, 0, 0.35);
    background: linear-gradient(180deg, #ef4444, #b91c1c);
    color: #fff;
    font-weight: 1000;
    font-size: 28px;
    cursor: pointer;
  }

  .pet-detail__name {
    font-size: 30px;
    font-weight: 1000;
    color: #fff;
    text-shadow: 0 3px 0 rgba(0, 0, 0, 0.55);
    text-align: center;
  }

  .pet-detail__card {
    width: 240px;
    height: 240px;
    border-radius: 18px;
    border: 5px solid rgba(0, 0, 0, 0.65);
    background: rgba(0, 0, 0, 0.12);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
  }

  .pet-detail__image {
    width: 82%;
    height: 82%;
    border-radius: 14px;
    background: rgba(0, 0, 0, 0.12);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 44px;
    color: #fff;
  }

  .pet-detail__img-el {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }

  .pet-detail__mult {
    position: absolute;
    bottom: 10px;
    right: 10px;
    padding: 6px 10px;
    border-radius: 14px;
    background: rgba(0, 0, 0, 0.65);
    color: #fff;
    font-weight: 1000;
    font-size: 26px;
    border: 3px solid rgba(255, 255, 255, 0.35);
    text-shadow: 0 2px 0 rgba(0, 0, 0, 0.55);
  }

  .pet-detail__rarity {
    font-size: 28px;
    font-weight: 1000;
    color: #ff4dff;
    text-shadow: 0 3px 0 rgba(0, 0, 0, 0.55);
  }

  .pet-detail__action {
    width: 100%;
    border-radius: 16px;
    border: 5px solid rgba(0, 0, 0, 0.35);
    padding: 16px 18px;
    font-weight: 1100;
    font-size: 24px;
    cursor: pointer;
    color: #fff;
    text-shadow: 0 2px 0 rgba(0, 0, 0, 0.55);
  }

  .pet-detail__action--equip {
    background: linear-gradient(180deg, #22c55e, #15803d);
  }

  .pet-detail__action--unequip {
    background: linear-gradient(180deg, #ef4444, #b91c1c);
  }

  .pet-tile {
    width: 100%;
    aspect-ratio: 1 / 1;
    border-radius: 18px;
    border: 5px solid rgba(0, 0, 0, 0.65);
    position: relative;
    cursor: pointer;
    padding: 0;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 18px rgba(0, 0, 0, 0.35);
    box-sizing: border-box;
  }

  .pet-tile--common { background: linear-gradient(180deg, #3b82f6, #1d4ed8); }
  .pet-tile--rare { background: linear-gradient(180deg, #22c55e, #15803d); }
  .pet-tile--epic { background: linear-gradient(180deg, #a855f7, #6d28d9); }
  .pet-tile--legendary { background: linear-gradient(180deg, #facc15, #b45309); }

  .pet-tile--equipped {
    outline: 4px solid rgba(255, 255, 255, 0.85);
    outline-offset: -6px;
  }

  .pet-tile__img {
    width: 84%;
    height: 84%;
    border-radius: 12px;
    background: rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 34px;
  }

  .pet-tile__img-el {
    width: 100%;
    height: 100%;
    object-fit: contain;
    image-rendering: auto;
    display: block;
  }

  .pet-tile__mult {
    position: absolute;
    bottom: 8px;
    right: 8px;
    padding: 4px 8px;
    border-radius: 12px;
    background: rgba(0, 0, 0, 0.65);
    color: #fff;
    font-weight: 900;
    font-size: 22px;
    text-shadow: 0 2px 0 rgba(0, 0, 0, 0.55);
    border: 3px solid rgba(255, 255, 255, 0.35);
  }

  .pets-footer {
    display: flex;
    justify-content: center;
    gap: 14px;
    margin-top: 12px;
  }

  .pets-footer__btn {
    border-radius: 14px;
    border: 4px solid rgba(0, 0, 0, 0.35);
    padding: 12px 18px;
    font-weight: 1000;
    font-size: 18px;
    cursor: pointer;
    color: #fff;
    text-shadow: 0 2px 0 rgba(0, 0, 0, 0.55);
    min-width: 240px;
  }

  /* Make Pets modal match the roomy "Frontiers" style panel */
  .pets-modal .pickaxe-modal__container {
    width: min(1180px, 94vw);
    height: min(780px, 86vh);
    max-height: 86vh;
  }

  .pets-modal .pickaxe-modal__header {
    justify-content: center;
    position: relative;
    padding: 18px 18px;
  }

  .pets-modal .pickaxe-modal__title {
    font-size: 44px;
    letter-spacing: 1px;
  }

  .pets-modal .pickaxe-modal__close {
    position: absolute;
    right: 14px;
    top: 14px;
    width: 54px;
    height: 54px;
    border-radius: 14px;
    font-size: 34px;
  }

  .pets-modal .pickaxe-modal__body {
    display: flex;
    flex-direction: column;
    height: calc(100% - 68px);
    padding: 16px 18px 18px;
    gap: 12px;
  }

  .pets-topbar {
    margin-bottom: 0;
  }

  /* Scrollbar similar to the reference */
  .pets-grid::-webkit-scrollbar {
    width: 12px;
  }
  .pets-grid::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.25);
    border-radius: 10px;
    border: 3px solid rgba(0, 0, 0, 0.25);
  }
  .pets-grid::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.15);
    border-radius: 10px;
  }

  .pets-footer__btn--green {
    background: linear-gradient(180deg, #22c55e, #15803d);
  }

  .pets-footer__btn--red {
    background: linear-gradient(180deg, #ef4444, #b91c1c);
  }

  .pets-footer__icon {
    width: 72px;
    height: 56px;
    border-radius: 14px;
    border: 4px solid rgba(0, 0, 0, 0.35);
    background: rgba(20, 40, 70, 0.35);
    cursor: pointer;
    font-size: 26px;
    color: #fff;
    text-shadow: 0 2px 0 rgba(0, 0, 0, 0.55);
  }

  .pets-delete-bar {
    position: absolute;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%);
    width: min(520px, 92%);
    border-radius: 18px;
    border: 4px solid rgba(0, 0, 0, 0.35);
    background: rgba(20, 40, 70, 0.55);
    padding: 14px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    z-index: 5;
  }

  /* Ensure HTML `hidden` attribute always wins (prevents showing until delete mode). */
  .pets-delete-bar[hidden] {
    display: none !important;
  }

  .pets-delete-bar__text {
    font-size: 24px;
    font-weight: 1100;
    color: #fff;
    text-shadow: 0 3px 0 rgba(0, 0, 0, 0.55);
    text-align: center;
  }

  .pets-delete-bar__actions {
    display: flex;
    gap: 12px;
    justify-content: center;
  }

  .pets-delete-bar__btn {
    border-radius: 16px;
    border: 5px solid rgba(0, 0, 0, 0.35);
    padding: 14px 18px;
    font-weight: 1100;
    font-size: 20px;
    cursor: pointer;
    color: #fff;
    text-shadow: 0 2px 0 rgba(0, 0, 0, 0.55);
    min-width: 170px;
  }

  .pets-delete-bar__btn--green {
    background: linear-gradient(180deg, #22c55e, #15803d);
  }

  .pets-delete-bar__btn--red {
    background: linear-gradient(180deg, #ef4444, #b91c1c);
  }

  .pets-delete-bar__btn:disabled {
    opacity: 0.55;
    cursor: not-allowed;
    filter: grayscale(0.2);
  }

  .pet-tile__delete-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 80px;
    font-weight: 1100;
    color: rgba(255, 0, 0, 0.9);
    text-shadow:
      0 6px 0 rgba(0, 0, 0, 0.55),
      -3px -3px 0 rgba(0, 0, 0, 0.55),
      3px -3px 0 rgba(0, 0, 0, 0.55),
      -3px 3px 0 rgba(0, 0, 0, 0.55),
      3px 3px 0 rgba(0, 0, 0, 0.55);
    pointer-events: none;
  }

  /* Modals */
  .modal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1200;
    background: rgba(0, 0, 0, 0.55);
    pointer-events: auto;
  }

  .modal.visible {
    display: flex;
  }

  .modal__body {
    padding: 16px;
  }

  .modal__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 16px;
    border-bottom: 3px solid #1a3a5c;
  }

  .modal__title {
    font-size: 24px;
    font-weight: 800;
    color: #fff;
    text-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
  }

  .modal__close {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    border: 3px solid #c0392b;
    background: linear-gradient(180deg, #e74c3c, #c0392b);
    color: #fff;
    font-size: 20px;
    font-weight: 800;
    cursor: pointer;
    box-shadow: 0 3px 12px rgba(0, 0, 0, 0.4);
  }

  .maps-modal .pickaxe-modal__container {
    width: min(880px, 95vw);
    height: min(640px, 88vh);
    max-height: 88vh;
    background:
      radial-gradient(circle at top left, rgba(55, 214, 232, 0.12), transparent 60%),
      radial-gradient(circle at bottom right, rgba(244, 196, 78, 0.12), transparent 65%),
      linear-gradient(180deg, rgba(12, 16, 28, 0.98), rgba(8, 12, 22, 0.98));
    border: 2px solid rgba(55, 214, 232, 0.35);
  }

  .maps-modal .pickaxe-modal__header {
    justify-content: space-between;
    align-items: center;
    padding: 18px 22px;
    border-bottom: 2px solid rgba(55, 214, 232, 0.25);
  }

  .maps-modal .pickaxe-modal__title {
    font-size: 38px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: #f8fafc;
    text-shadow: 0 0 18px rgba(55, 214, 232, 0.35);
  }

  .maps-modal .pickaxe-modal__close {
    position: static;
  }

  .maps-modal .pickaxe-modal__body {
    display: flex;
    flex-direction: column;
    padding: 20px 22px 26px;
    overflow-y: auto;
    gap: 16px;
  }

  .maps-list {
    display: flex;
    flex-direction: column;
    gap: 18px;
  }

  .maps-card {
    background:
      linear-gradient(135deg, rgba(20, 26, 42, 0.95), rgba(12, 16, 28, 0.98));
    border: 2px solid rgba(42, 51, 80, 0.9);
    border-radius: 18px;
    padding: 18px 20px;
    display: grid;
    grid-template-columns: 1fr auto;
    grid-template-rows: auto auto;
    gap: 10px 18px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 12px 26px rgba(0, 0, 0, 0.45);
    transition: transform 0.16s ease, border-color 0.16s ease, box-shadow 0.16s ease;
  }

  .maps-card::after {
    content: '';
    position: absolute;
    inset: 0;
    background:
      linear-gradient(120deg, rgba(55, 214, 232, 0.08), transparent 50%),
      linear-gradient(300deg, rgba(244, 196, 78, 0.08), transparent 55%);
    opacity: 0.8;
    pointer-events: none;
  }

  .maps-card:hover {
    border-color: rgba(55, 214, 232, 0.65);
    transform: translateY(-3px);
    box-shadow: 0 16px 30px rgba(0, 0, 0, 0.55);
  }

  .maps-card--current {
    border-color: rgba(34, 197, 94, 0.9);
    box-shadow: 0 0 18px rgba(34, 197, 94, 0.35);
  }

  .maps-card--locked {
    opacity: 0.7;
    border-color: rgba(42, 51, 80, 0.5);
  }

  .maps-card__name {
    font-size: 26px;
    font-weight: 900;
    color: #f8fafc;
    text-shadow: 0 0 12px rgba(15, 23, 42, 0.8);
    z-index: 1;
  }

  .maps-card__info {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
    z-index: 1;
  }

  .maps-card__multiplier {
    font-size: 14px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: #fbbf24;
    background: rgba(251, 191, 36, 0.12);
    border: 1px solid rgba(251, 191, 36, 0.4);
    padding: 4px 10px;
    border-radius: 999px;
  }

  .maps-card__current {
    font-size: 13px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: #22c55e;
    background: rgba(34, 197, 94, 0.15);
    border: 1px solid rgba(34, 197, 94, 0.45);
    padding: 4px 10px;
    border-radius: 999px;
  }

  .maps-card__actions {
    grid-column: 2;
    grid-row: 1 / span 2;
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 1;
  }

  .maps-card__btn {
    padding: 12px 22px;
    border-radius: 12px;
    border: 2px solid rgba(15, 23, 42, 0.6);
    font-weight: 900;
    font-size: 16px;
    cursor: pointer;
    color: #0b1220;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    transition: transform 0.16s ease, filter 0.16s ease;
  }

  .maps-card__btn--teleport {
    background: linear-gradient(180deg, #4be7f5, #37d6e8);
    box-shadow: 0 8px 18px rgba(55, 214, 232, 0.35);
  }

  .maps-card__btn--teleport:hover:not(:disabled) {
    filter: brightness(1.08);
    transform: translateY(-1px);
  }

  .maps-card__btn--teleport:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .maps-card__btn--unlock {
    background: linear-gradient(180deg, #f7d35c, #f59e0b);
    box-shadow: 0 8px 18px rgba(245, 158, 11, 0.35);
  }

  .maps-card__btn--unlock:hover {
    filter: brightness(1.08);
    transform: translateY(-1px);
  }

  .action-card--maps {
    background: linear-gradient(180deg, #1e40af, #1e3a8a);
  }

  .rebirth-modal__container {
    width: 700px;
    max-width: 95vw;
    max-height: 85vh;
    background: rgba(21, 26, 60, 0.98);
    border: 3px solid #4a90e2;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    overflow: hidden;
    margin: auto;
  }

  .rebirth-modal__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 2px solid #4a90e2;
    background: rgba(21, 26, 60, 0.98);
  }

  .rebirth-modal__title {
    font-size: 24px;
    font-weight: 700;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .rebirth-modal__close {
    width: 32px;
    height: 32px;
    background: rgba(244, 67, 54, 0.8);
    border: 2px solid #f44336;
    border-radius: 6px;
    color: #fff;
    font-size: 20px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .rebirth-modal__close:hover {
    background: rgba(244, 67, 54, 1);
    transform: scale(1.1);
  }

  .pickaxe-modal__container {
    width: 1800px;
    max-width: 95vw;
    max-height: 85vh;
    background: rgba(21, 26, 60, 0.98);
    border: 3px solid #4a90e2;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    overflow: hidden;
    margin: auto; /* Ensure it's centered */
  }

  .pickaxe-modal__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 2px solid #4a90e2;
    background: rgba(21, 26, 60, 0.98);
  }

  .pickaxe-modal__title {
    font-size: 24px;
    font-weight: 700;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .pickaxe-modal__close {
    width: 32px;
    height: 32px;
    background: rgba(244, 67, 54, 0.8);
    border: 2px solid #f44336;
    border-radius: 6px;
    color: #fff;
    font-size: 20px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .pickaxe-modal__close:hover {
    background: rgba(244, 67, 54, 1);
    transform: scale(1.1);
  }

  .pickaxe-modal__body {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  .pickaxe-modal__left-panel {
    width: 300px;
    min-width: 300px;
    padding: 20px;
    border-right: 2px solid #4a90e2;
    background: rgba(15, 20, 50, 0.95);
    display: flex;
    flex-direction: column;
  }

  .pickaxe-modal__right-panel {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    overflow-x: hidden;
    background: rgba(21, 26, 60, 0.98);
  }

  .rebirth-modal__body {
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    background: rgba(21, 26, 60, 0.98);
    overflow-y: auto;
    max-height: calc(85vh - 80px);
  }

  .rebirth-modal__instruction {
    font-size: 18px;
    font-weight: 700;
    color: #ffd700;
    text-align: center;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
  }

  .rebirth-modal__explanation {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    border: 2px solid #1a3a5c;
  }

  .rebirth-icon {
    font-size: 24px;
  }

  .rebirth-text {
    font-size: 18px;
    font-weight: 700;
    color: #fff;
  }

  .rebirth-equals {
    font-size: 18px;
    font-weight: 700;
    color: #fff;
  }

  .power-icon {
    font-size: 24px;
  }

  .power-text {
    font-size: 18px;
    font-weight: 700;
    color: #ff5252;
  }

  .rebirth-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .rebirth-option {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: rgba(30, 40, 80, 0.8);
    border: 2px solid #1a3a5c;
    border-radius: 12px;
    transition: all 0.2s ease;
  }

  .rebirth-option:hover:not(.unavailable) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  }

  .rebirth-option--max {
    border: 3px solid;
    border-image: linear-gradient(90deg, #ff0000, #ff8800, #ffd700, #4caf50, #2196f3, #9c27b0) 1;
    background: rgba(30, 40, 80, 0.9);
  }

  .rebirth-option.unavailable {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .rebirth-option__info {
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex: 1;
  }

  .rebirth-option__title {
    font-size: 18px;
    font-weight: 700;
    color: #4caf50;
  }

  .rebirth-option__cost {
    font-size: 16px;
    font-weight: 700;
    color: #ff5252;
  }

  .rebirth-option__action {
    margin-left: 20px;
  }

  .rebirth-button {
    padding: 12px 24px;
    border-radius: 8px;
    border: 2px solid #4caf50;
    background: linear-gradient(180deg, #66bb6a, #2e7d32);
    color: #fff;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  }

  .rebirth-button:hover:not(.disabled) {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(76, 175, 80, 0.5);
  }

  .rebirth-button.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    filter: grayscale(0.5);
  }

  .rebirth-button--max {
    padding: 12px 24px;
    border-radius: 8px;
    border: 3px solid #000;
    background: linear-gradient(180deg, #ffd700, #ffaa00);
    color: #000;
    font-size: 16px;
    font-weight: 800;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  }

  .rebirth-button--max:hover:not(.disabled) {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(255, 215, 0, 0.6);
  }

  .rebirth-button--max.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    filter: grayscale(0.5);
  }

  .pickaxe-details {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    padding: 20px;
    background: rgba(30, 40, 80, 0.8);
    border: 2px solid #4a90e2;
    border-radius: 12px;
  }

  .pickaxe-details__icon {
    width: 120px;
    height: 120px;
    border-radius: 12px;
    border: 3px solid #1a3a5c;
    background: linear-gradient(180deg, rgba(30, 60, 100, 0.95), rgba(20, 40, 70, 0.95));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 64px;
    box-shadow: inset 0 0 12px rgba(0, 0, 0, 0.4);
  }

  .pickaxe-details__name {
    font-size: 22px;
    font-weight: 700;
    color: #fff;
    text-align: center;
  }

  .pickaxe-details__badge {
    margin-top: 8px;
    padding: 6px 16px;
    background: linear-gradient(180deg, rgba(76, 175, 80, 0.9), rgba(46, 125, 50, 0.95));
    border: 2px solid #4caf50;
    border-radius: 8px;
    color: #fff;
    font-size: 14px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .pickaxe-details__stats {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 8px;
  }

  .pickaxe-stat {
    font-size: 14px;
    font-weight: 700;
    padding: 4px 8px;
    border-radius: 6px;
    background: rgba(0, 0, 0, 0.3);
  }

  .pickaxe-stat--power {
    color: #ff5252;
  }

  .pickaxe-stat--luck {
    color: #4caf50;
  }

  .pickaxe-stat--speed {
    color: #87ceeb;
  }

  .pickaxe-stat--damage {
    color: #ffd700;
  }

  .pickaxe-stat--sell {
    color: #ffd700;
  }

  .pickaxe-details__cost {
    font-size: 16px;
    color: #e0f2ff;
    margin-top: 4px;
  }

  .pickaxe-details__action-button {
    width: 100%;
    padding: 12px 20px;
    margin-top: 16px;
    border-radius: 8px;
    border: 2px solid #4caf50;
    background: linear-gradient(180deg, #66bb6a, #2e7d32);
    color: #fff;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .pickaxe-details__action-button:hover:not(.disabled) {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(76, 175, 80, 0.5);
  }

  .pickaxe-details__action-button.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    filter: grayscale(0.5);
  }

  .pickaxe-actions {
    margin: 12px 0;
    display: flex;
    justify-content: flex-start;
  }

  .primary-button {
    padding: 12px 20px;
    border-radius: 12px;
    border: 3px solid #4caf50;
    background: linear-gradient(180deg, #66bb6a, #2e7d32);
    color: #fff;
    font-size: 16px;
    font-weight: 800;
    cursor: pointer;
    box-shadow: 0 4px 14px rgba(0, 0, 0, 0.45);
  }

  .primary-button.disabled {
    opacity: 0.6;
    cursor: not-allowed;
    filter: grayscale(0.2);
  }

  .pickaxe-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    width: 100%;
    overflow-x: hidden;
    min-width: 0; /* Prevent grid from overflowing */
    padding-right: 8px; /* Add padding for scrollbar */
  }

  .pickaxe-card {
    position: relative;
    border-radius: 12px;
    border: 3px solid #1a3a5c;
    background: linear-gradient(180deg, rgba(30, 60, 100, 0.95), rgba(20, 40, 70, 0.98));
    padding: 16px;
    color: #fff;
    cursor: pointer;
    box-shadow: 0 3px 12px rgba(0, 0, 0, 0.4);
    transition: transform 0.12s ease, box-shadow 0.12s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    min-height: 140px;
    min-width: 0; /* Prevent cards from overflowing grid */
    max-width: 100%; /* Ensure cards don't exceed grid cell */
    justify-content: space-between;
    box-sizing: border-box; /* Include padding and border in width calculation */
  }

  .pickaxe-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 18px rgba(0, 0, 0, 0.45);
  }

  .pickaxe-card.selected {
    border-color: #ffd700;
    box-shadow: 0 0 0 2px #ffd700, 0 5px 18px rgba(0, 0, 0, 0.45);
  }

  .pickaxe-card__name {
    font-size: 14px;
    font-weight: 700;
    margin-top: 8px;
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
    width: 100%;
  }

  .pickaxe-card__icon {
    font-size: 48px;
    margin: 4px 0;
  }

  .pickaxe-card__icon-img {
    width: 48px;
    height: 48px;
    object-fit: contain;
    image-rendering: pixelated;
  }

  .pickaxe-details__icon-img {
    width: 72px;
    height: 72px;
    object-fit: contain;
    image-rendering: pixelated;
  }

  .pickaxe-card__cost {
    color: #ffd700;
    font-weight: 700;
  }

  .pickaxe-card__lock {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.55);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    color: #fff;
  }

  .pickaxe-card__checkmark {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    background: #4caf50;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-weight: 800;
    font-size: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
  }

  .pickaxe-card__buy-button {
    width: 100%;
    padding: 8px 12px;
    margin-top: 8px;
    border-radius: 8px;
    border: 2px solid #4caf50;
    background: linear-gradient(180deg, #66bb6a, #2e7d32);
    color: #fff;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: transform 0.1s ease;
  }

  .pickaxe-card__buy-button:hover {
    transform: scale(1.05);
  }

  .pickaxe-card.purchased {
    /* Normal appearance for purchased pickaxes */
    opacity: 1;
    cursor: pointer;
  }

  .pickaxe-card.equipped {
    border-color: #4caf50;
    box-shadow: 0 0 0 2px #4caf50, 0 5px 18px rgba(0, 0, 0, 0.45);
    opacity: 1;
  }

  .pickaxe-card.next-tier {
    /* Greyed out but purchasable (next tier) */
    opacity: 0.5;
    filter: grayscale(0.3);
    cursor: pointer;
  }

  .pickaxe-card.locked {
    /* Greyed out with lock (future tiers) */
    opacity: 0.4;
    filter: grayscale(0.6);
    cursor: not-allowed;
  }

  /* Rebirth UI */
  .rebirth-summary {
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding: 10px 12px;
    border: 2px solid #1a3a5c;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.05);
    margin-bottom: 12px;
  }

  .rebirth-summary__row {
    display: flex;
    justify-content: space-between;
    font-size: 16px;
    color: #e0f2ff;
  }

  .rebirth-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .rebirth-card {
    border-radius: 12px;
    border: 3px solid #1a3a5c;
    background: linear-gradient(180deg, rgba(30, 60, 100, 0.95), rgba(20, 40, 70, 0.98));
    padding: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: #fff;
    box-shadow: 0 3px 12px rgba(0, 0, 0, 0.4);
  }

  .rebirth-card__title {
    font-size: 18px;
    font-weight: 800;
  }

  .rebirth-card__cost {
    color: #ff5252;
    font-weight: 800;
    margin-top: 4px;
  }

  .rebirth-card__bonus {
    color: #4caf50;
    font-weight: 700;
  }

  .rebirth-card__action {
    margin-left: 12px;
  }

  /* Power gain floating text */
  .power-gain-layer {
    position: fixed;
    inset: 0;
    pointer-events: none;
    overflow: hidden;
  }

  .power-gain {
    position: absolute;
    display: flex;
    align-items: center;
    gap: 8px;
    color: #ff5252;
    font-size: 34px;
    font-weight: 800;
    text-shadow: 0 4px 18px rgba(0, 0, 0, 0.4);
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.8);
    transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.6s, filter 0.6s;
    pointer-events: none;
    z-index: 10000;
    white-space: nowrap;
  }

  .power-gain__icon {
    font-size: 32px;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
  }

  .power-gain__text {
    color: #ff5252;
    text-shadow: 
      0 0 10px rgba(255, 82, 82, 0.8),
      0 2px 4px rgba(0, 0, 0, 0.8),
      -1px -1px 0 rgba(0, 0, 0, 0.5),
      1px -1px 0 rgba(0, 0, 0, 0.5),
      -1px 1px 0 rgba(0, 0, 0, 0.5),
      1px 1px 0 rgba(0, 0, 0, 0.5);
  }

  .power-gain.active {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.05);
    filter: drop-shadow(0 0 12px rgba(255, 99, 132, 0.9));
  }

  /* Training prompt */
  .training-prompt {
    position: fixed;
    left: 50%;
    bottom: 120px;
    transform: translate(-50%, 20px);
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 24px;
    border-radius: 18px;
    border: 3px solid rgba(255, 255, 255, 0.9);
    background: rgba(21, 26, 60, 0.92);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.55);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease, transform 0.2s ease;
  }

  .training-prompt.visible {
    opacity: 1;
    transform: translate(-50%, 0);
  }

  .training-prompt.locked {
    border-color: rgba(255, 255, 255, 0.4);
    background: rgba(50, 50, 70, 0.8);
  }

  .training-prompt__key {
    width: 48px;
    height: 48px;
    border-radius: 14px;
    background: rgba(0, 0, 0, 0.4);
    border: 2px solid rgba(255, 255, 255, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: 700;
  }

  .training-prompt__title {
    font-size: 16px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .training-prompt__subtitle {
    font-size: 13px;
    opacity: 0.8;
  }

  /* Scene UI prompt */
  .scene-training-prompt {
    font-family: "Fredoka", sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    padding: 8px 14px;
    border-radius: 12px;
    border: 2px solid rgba(255, 255, 255, 0.9);
    background: rgba(23, 27, 61, 0.95);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.55);
    color: #fff;
    text-transform: uppercase;
    opacity: 1; /* Start visible */
    transition: opacity 0.15s ease;
    pointer-events: none;
    transform: scale(0.65); /* Make it smaller for compactness */
    min-width: 120px;
  }

  .scene-training-prompt:not(.visible) {
    opacity: 0;
  }

  .scene-training-prompt.visible {
    opacity: 1;
  }

  .scene-training-prompt.locked {
    border-color: rgba(255, 255, 255, 0.4);
    background: rgba(60, 60, 80, 0.9);
  }

  .scene-training-prompt__icon {
    font-size: 22px;
    line-height: 1;
    margin-bottom: 2px;
  }

  .scene-training-prompt__copy {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1px;
    width: 100%;
  }

  .scene-training-prompt__requirement {
    font-size: 13px;
    font-weight: 800;
    color: #fff;
    text-shadow:
      0 0 8px rgba(255, 255, 255, 0.8),
      0 1px 3px rgba(0, 0, 0, 0.8),
      -1px -1px 0 rgba(0, 0, 0, 0.5),
      1px -1px 0 rgba(0, 0, 0, 0.5),
      -1px 1px 0 rgba(0, 0, 0, 0.5),
      1px 1px 0 rgba(0, 0, 0, 0.5);
    letter-spacing: 0.3px;
  }

  .scene-training-prompt__or {
    font-size: 10px;
    font-weight: 700;
    color: #4a9eff;
    text-shadow:
      0 0 6px rgba(74, 158, 255, 0.6),
      0 1px 3px rgba(0, 0, 0, 0.8);
    letter-spacing: 0.5px;
  }

  .scene-training-prompt__rebirth {
    font-size: 13px;
    font-weight: 800;
    color: #4caf50;
    text-shadow:
      0 0 8px rgba(76, 175, 80, 0.8),
      0 1px 3px rgba(0, 0, 0, 0.8),
      -1px -1px 0 rgba(0, 0, 0, 0.5),
      1px -1px 0 rgba(0, 0, 0, 0.5),
      -1px 1px 0 rgba(0, 0, 0, 0.5),
      1px 1px 0 rgba(0, 0, 0, 0.5);
    letter-spacing: 0.3px;
  }

  .scene-training-prompt__power-gain {
    font-size: 13px;
    font-weight: 800;
    color: #ff5252;
    text-shadow:
      0 0 8px rgba(255, 82, 82, 0.8),
      0 1px 3px rgba(0, 0, 0, 0.8),
      -1px -1px 0 rgba(0, 0, 0, 0.5),
      1px -1px 0 rgba(0, 0, 0, 0.5),
      -1px 1px 0 rgba(0, 0, 0, 0.5),
      1px 1px 0 rgba(0, 0, 0, 0.5);
    letter-spacing: 0.3px;
    margin-top: 1px;
  }

  /* ========== Training Rock Two-Mode Display ========== */

  /* Far mode - floating bubble with rock info (default behavior) */
  .scene-training-prompt.mode-far {
    animation: training-float 2s ease-in-out infinite;
  }

  /* Close mode - interaction prompt */
  .scene-training-prompt.mode-close {
    padding: 10px 16px;
    min-width: auto;
    animation: training-bounce 1s ease-in-out infinite;
  }

  .scene-training-prompt.mode-close .scene-training-prompt__content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }

  .scene-training-prompt__interaction {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
  }

  .scene-training-prompt__key {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: 700;
    background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
    border: 3px solid #333;
    color: #333;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .scene-training-prompt__action {
    font-size: 16px;
    font-weight: 600;
    color: #fff;
    -webkit-text-stroke: 2px #000;
    paint-order: stroke fill;
  }

  /* Hide far mode content in close mode */
  .scene-training-prompt.mode-close .scene-training-prompt__icon,
  .scene-training-prompt.mode-close .scene-training-prompt__copy {
    display: none;
  }

  /* Hide close mode content in far mode */
  .scene-training-prompt.mode-far .scene-training-prompt__interaction {
    display: none;
  }

  /* ========== Training Rock Animations ========== */

  @keyframes training-float {
    0%, 100% { transform: scale(0.65) translateY(0px); }
    50% { transform: scale(0.65) translateY(-3px); }
  }

  @keyframes training-bounce {
    0%, 100% { transform: scale(0.65) translateY(0); }
    50% { transform: scale(0.65) translateY(-8px); }
  }

  /* ========== Mobile Styles for Training Rock ========== */

  /* Mobile: Show TAP instead of E key */
  body.mobile .scene-training-prompt.mode-close .scene-training-prompt__key {
    font-size: 0; /* Hide the "E" */
    width: auto;
    padding: 0 12px;
  }

  body.mobile .scene-training-prompt.mode-close .scene-training-prompt__key::before {
    content: "TAP";
    font-size: 14px;
  }

  /* Scene UI: Egg labels (name + cost, like the reference image) */
  .scene-egg-prompt {
    font-family: "Fredoka", sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    padding: 4px 8px;
    border-radius: 14px;
    background: rgba(0, 0, 0, 0); /* floating text only */
    color: #fff;
    opacity: 1;
    transition: opacity 0.15s ease;
    pointer-events: none;
    transform: scale(0.9);
    min-width: 140px;
  }

  .scene-egg-prompt:not(.visible) {
    opacity: 0;
  }

  .scene-egg-prompt__icon {
    display: none; /* egg model exists in-world; label should be text-only */
  }

  .scene-egg-prompt__copy {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
  }

  .scene-egg-prompt__title {
    font-size: 28px;
    font-weight: 900;
    color: #ffffff;
    text-shadow:
      0 3px 0 rgba(0, 0, 0, 0.65),
      -2px -2px 0 rgba(0, 0, 0, 0.65),
      2px -2px 0 rgba(0, 0, 0, 0.65),
      -2px 2px 0 rgba(0, 0, 0, 0.65),
      2px 2px 0 rgba(0, 0, 0, 0.65);
  }

  .scene-egg-prompt__cost {
    font-size: 20px;
    font-weight: 900;
    color: #ffcc00;
    text-shadow:
      0 3px 0 rgba(0, 0, 0, 0.65),
      -2px -2px 0 rgba(0, 0, 0, 0.65),
      2px -2px 0 rgba(0, 0, 0, 0.65),
      -2px 2px 0 rgba(0, 0, 0, 0.65),
      2px 2px 0 rgba(0, 0, 0, 0.65);
  }


  /* Mining HUD */
  .mining-hud {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .mining-hud.visible {
    opacity: 1;
  }

  /* Old current ore display removed - now using mining target display */

  /* Bottom Middle Right: Damage Display */
  .mining-hud__damage {
    position: fixed;
    right: 40px;
    bottom: 200px;
    padding: 8px 16px;
    border-radius: 10px;
    background: rgba(185, 0, 0, 0.8);
    border: 2px solid rgba(255, 0, 0, 0.5);
    color: #fff;
    font-size: 20px;
    font-weight: 800;
    text-shadow: 
      0 0 10px rgba(255, 0, 0, 0.8),
      0 2px 4px rgba(0, 0, 0, 0.8),
      -1px -1px 0 rgba(0, 0, 0, 0.5),
      1px -1px 0 rgba(0, 0, 0, 0.5),
      -1px 1px 0 rgba(0, 0, 0, 0.5),
      1px 1px 0 rgba(0, 0, 0, 0.5);
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
  }

  .mining-hud__damage.visible {
    opacity: 1;
  }

  /* Mined Ore Popup Layer */
  .mined-ore-layer {
    position: fixed;
    inset: 0;
    pointer-events: none;
    overflow: hidden;
  }

  /* Mined Ore Floating Popup - Positioned above block health bar */
  .mined-ore-popup {
    position: fixed;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 8px 16px;
    color: #fff;
    font-size: 22px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 
      -2px -2px 0 #000,
      2px -2px 0 #000,
      -2px 2px 0 #000,
      2px 2px 0 #000,
      0 0 10px rgba(0, 0, 0, 0.8);
    opacity: 0;
    pointer-events: none;
    z-index: 1001;
  }

  /* Float up animation */
  .mined-ore-popup.active {
    animation: orePopupFloatUp 0.4s ease-out forwards;
  }

  /* Fade out animation */
  .mined-ore-popup.fade-out {
    animation: orePopupFadeOut 0.3s ease-out forwards;
  }

  @keyframes orePopupFloatUp {
    0% {
      opacity: 0;
      transform: translateX(-50%) translateY(30px) scale(0.8);
    }
    50% {
      opacity: 1;
      transform: translateX(-50%) translateY(-10px) scale(1.1);
    }
    100% {
      opacity: 1;
      transform: translateX(-50%) translateY(-20px) scale(1);
    }
  }

  @keyframes orePopupFadeOut {
    0% {
      opacity: 1;
      transform: translateX(-50%) translateY(-20px);
    }
    100% {
      opacity: 0;
      transform: translateX(-50%) translateY(-40px);
    }
  }

  .mined-ore-popup__text {
    /* Color is set dynamically based on ore type */
    font-weight: 800;
  }

  /* Damage Popup Layer */
  .damage-popup-layer {
    position: fixed;
    inset: 0;
    pointer-events: none;
    overflow: hidden;
    z-index: 1000;
  }

  /* Damage Popup (To the right of HP bar) */
  .damage-popup {
    position: fixed;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    pointer-events: none;
    opacity: 0;
    transform: translateY(0) scale(0.9);
    transition: opacity 0.4s ease, transform 1.5s ease-out;
  }

  .damage-popup.active {
    opacity: 1;
    transform: translateY(-80px) scale(1);
  }

  .damage-popup__text {
    color: #ff0000;
    font-size: 32px;
    font-weight: 800;
    font-family: "Fredoka", sans-serif;
    text-shadow:
      -2px -2px 0 #000,
      2px -2px 0 #000,
      -2px 2px 0 #000,
      2px 2px 0 #000,
      0 0 10px rgba(0, 0, 0, 0.8),
      0 4px 8px rgba(0, 0, 0, 0.6);
    letter-spacing: 1px;
    white-space: nowrap;
  }

  /* Mobile damage popup - styled like power gain */
  .damage-popup.mobile {
    position: absolute;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.6s, filter 0.6s;
    z-index: 10000;
  }

  .damage-popup.mobile.active {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.05);
    filter: drop-shadow(0 0 12px rgba(255, 0, 0, 0.9));
  }

  .damage-popup__icon {
    font-size: 32px;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
  }

  .damage-popup.mobile .damage-popup__text {
    font-size: 34px;
    text-shadow:
      0 0 10px rgba(255, 0, 0, 0.8),
      0 2px 4px rgba(0, 0, 0, 0.8),
      -1px -1px 0 rgba(0, 0, 0, 0.5),
      1px -1px 0 rgba(0, 0, 0, 0.5),
      -1px 1px 0 rgba(0, 0, 0, 0.5),
      1px 1px 0 rgba(0, 0, 0, 0.5);
  }

  /* Mine Reset Timer (Bottom Right - Compact) */
  .mine-reset-timer {
    position: fixed;
    bottom: 20px;
    right: 20px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 1001;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .mine-reset-timer.visible {
    opacity: 1;
  }

  .mine-reset-timer__text {
    padding: 6px 12px;
    border-radius: 8px;
    background: rgba(0, 0, 0, 0.75);
    border: 2px solid rgba(255, 255, 255, 0.6);
    color: #fff;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 1px;
    text-shadow:
      -1px -1px 0 #000,
      1px -1px 0 #000,
      -1px 1px 0 #000,
      1px 1px 0 #000;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .mine-reset-timer__text::before {
    content: "â±";
    font-size: 12px;
  }

  /* Mining Depth Counter (Right side, above progress bar) */
  .mining-depth-counter {
    position: fixed;
    right: 10px;
    top: calc(50% - 180px);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 1001;
  }

  .mining-depth-counter.visible {
    opacity: 1;
  }

  .mining-depth-counter__text {
    padding: 4px 10px;
    border-radius: 6px;
    background: rgba(0, 0, 0, 0.75);
    border: 2px solid rgba(255, 255, 255, 0.6);
    color: #fff;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-shadow:
      -1px -1px 0 #000,
      1px -1px 0 #000,
      -1px 1px 0 #000,
      1px 1px 0 #000;
    text-align: center;
    white-space: nowrap;
  }

  /* Block Health Bar (Bottom Center) */
  .block-health-bar {
    position: fixed;
    bottom: 120px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    opacity: 0;
    pointer-events: none;
    /* Removed transition to prevent UI disappearing when switching ores quickly */
    z-index: 1000;
  }

  .block-health-bar.visible {
    opacity: 1;
    /* Instant show - no transition */
  }

  .block-health-bar__header {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
  }

  .block-health-bar__name {
    font-size: 24px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: #fff;
    text-shadow:
      -2px -2px 0 #000,
      2px -2px 0 #000,
      -2px 2px 0 #000,
      2px 2px 0 #000,
      0 0 10px rgba(0, 0, 0, 0.8);
  }

  .block-health-bar__container {
    position: relative;
    width: 300px;
  }

  .block-health-bar__outline {
    width: 100%;
    height: 32px;
    border: 3px solid #1a3a5c;
    background: #0d2440;
    border-radius: 6px;
    position: relative;
    overflow: hidden;
  }

  .block-health-bar__fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: linear-gradient(90deg, #4caf50 0%, #66bb6a 100%);
    transition: width 0.3s ease;
    border-radius: 3px;
  }

  .block-health-bar__text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 14px;
    font-weight: 700;
    color: #fff;
    text-shadow: 
      -1px -1px 0 #000,
      1px -1px 0 #000,
      -1px 1px 0 #000,
      1px 1px 0 #000,
      0 0 8px rgba(0, 0, 0, 0.8);
    white-space: nowrap;
    pointer-events: none;
    z-index: 1;
  }

  .block-health-bar__reward {
    display: none;
    align-items: center;
    gap: 6px;
    font-size: 18px;
    font-weight: 700;
    margin-top: 4px;
    text-shadow: 
      -1px -1px 0 #000,
      1px -1px 0 #000,
      -1px 1px 0 #000,
      1px 1px 0 #000,
      0 0 8px rgba(0, 0, 0, 0.8);
  }

  /* Progress Bar (Bottom) */
  .progress-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 20px 40px;
    pointer-events: none;
    z-index: 1000;
  }

  .progress-bar__container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .progress-bar__outline {
    position: relative;
    width: 100%;
    height: 40px;
    border: 4px solid #1a3a5c;
    background: #0d2440;
    border-radius: 8px;
    overflow: visible;
  }

  .progress-bar__fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: linear-gradient(90deg, #4caf50 0%, #66bb6a 50%, #81c784 100%);
    border-radius: 4px;
    transition: width 0.3s ease;
    width: 0%;
  }

  .progress-bar__marker {
    position: absolute;
    top: -8px;
    width: 24px;
    height: 56px;
    background: radial-gradient(circle, #fff 0%, #ffd166 50%, #ff4b5c 100%);
    border: 3px solid #1a3a5c;
    border-radius: 12px;
    transform: translateX(-50%);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    transition: left 0.3s ease;
    left: 0%;
  }

  .progress-bar__markers {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
    padding: 0 8px;
  }

  .progress-bar__marker-label {
    font-size: 14px;
    font-weight: 700;
    color: #fff;
    text-shadow: 
      -1px -1px 0 #000,
      1px -1px 0 #000,
      -1px 1px 0 #000,
      1px 1px 0 #000;
  }

  /* Mining Controls */
  .mining-controls {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 16px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 900;
  }

  .mining-controls.visible {
    opacity: 1;
    pointer-events: auto;
  }

  /* To Surface button is always visible, positioned at top of HUD */
  #to-surface-button {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    opacity: 1 !important;
    pointer-events: auto !important;
    z-index: 901;
  }

  .mining-control-button {
    padding: 12px 24px;
    border-radius: 12px;
    border: 3px solid rgba(255, 255, 255, 0.9);
    background: rgba(21, 26, 60, 0.92);
    color: #fff;
    font-size: 16px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor: pointer;
    pointer-events: auto;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  }

  .mining-control-button:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
  }

  .mining-control-button:active {
    transform: scale(0.98);
  }

  .mining-control-button--surface {
    background: linear-gradient(180deg, rgba(76, 175, 80, 0.9), rgba(46, 125, 50, 0.95));
    border-color: #4caf50;
  }

  /* Auto Controls (Right Side) */
  .auto-controls {
    position: fixed;
    right: 40px;
    bottom: 200px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    pointer-events: auto;
    z-index: 900;
  }

  .auto-control-button {
    padding: 14px 20px;
    border-radius: 12px;
    border: 3px solid rgba(255, 255, 255, 0.9);
    background: rgba(21, 26, 60, 0.92);
    color: #fff;
    font-size: 16px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    min-width: 140px;
  }

  .auto-control-button:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
  }

  .auto-control-button:active {
    transform: scale(0.98);
  }

  /* Green when inactive (off) */
  .auto-control-button.inactive {
    background: linear-gradient(180deg, rgba(76, 175, 80, 0.9), rgba(46, 125, 50, 0.95));
    border-color: #4caf50;
  }

  /* Red when active (on) */
  .auto-control-button.active {
    background: linear-gradient(180deg, rgba(244, 67, 54, 0.9), rgba(183, 28, 28, 0.95));
    border-color: #f44336;
  }

  /* Merchant Selling UI */
  .merchant-ui {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 500px;
    max-height: 600px;
    background: rgba(21, 26, 60, 0.98);
    border: 3px solid #4a90e2;
    border-radius: 12px;
    display: none;
    flex-direction: column;
    z-index: 1000;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
  }

  .merchant-ui.visible {
    display: flex;
  }

.merchant-ui__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 2px solid #4a90e2;
}

.merchant-ui__title-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.merchant-ui__title {
  font-size: 24px;
  font-weight: 700;
  color: #fff;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.merchant-ui__subtitle {
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: #9aa3b2;
}

.merchant-ui__close {
  width: 32px;
  height: 32px;
  background: rgba(244, 67, 54, 0.8);
  border: 2px solid #f44336;
    border-radius: 6px;
    color: #fff;
    font-size: 20px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .merchant-ui__close:hover {
    background: rgba(244, 67, 54, 1);
    transform: scale(1.1);
  }

  .merchant-ui__content {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    max-height: 450px;
  }

  .merchant-ui__ore-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 15px;
    margin: 8px 0;
    background: linear-gradient(180deg, rgba(20, 58, 86, 0.98), rgba(16, 45, 68, 0.98));
    border: 2px solid #1f5f8e;
    border-radius: 10px;
    min-height: 60px;
    box-shadow: 0 4px 12px rgba(8, 20, 32, 0.5);
  }

  .merchant-ui__ore-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .merchant-ui__ore-name {
    font-size: 18px;
    font-weight: 800;
    color: #f8fafc;
    text-shadow:
      -1px -1px 0 rgba(0, 0, 0, 0.6),
      1px -1px 0 rgba(0, 0, 0, 0.6),
      -1px 1px 0 rgba(0, 0, 0, 0.6),
      1px 1px 0 rgba(0, 0, 0, 0.6),
      0 0 10px rgba(0, 0, 0, 0.6);
    -webkit-text-stroke: 1px rgba(0, 0, 0, 0.55);
  }

  .merchant-ui__ore-name.stone { color: #9e9e9e; }
  .merchant-ui__ore-name.coal { color: #424242; }
  .merchant-ui__ore-name.copper { color: #b87333; }
  .merchant-ui__ore-name.iron { color: #d4d4d4; }
  .merchant-ui__ore-name.silver { color: #c0c0c0; }
  .merchant-ui__ore-name.gold { color: #ffd700; }
  .merchant-ui__ore-name.platinum { color: #e5e4e2; }
  .merchant-ui__ore-name.titanium { color: #878681; }
  .merchant-ui__ore-name.emerald { color: #50c878; }
  .merchant-ui__ore-name.ruby { color: #e0115f; }
  .merchant-ui__ore-name.sapphire { color: #0f52ba; }
  .merchant-ui__ore-name.topaz { color: #ffc87c; }
  .merchant-ui__ore-name.diamond { color: #b9f2ff; }
  .merchant-ui__ore-name.mithrial { color: #9b59b6; }
  .merchant-ui__ore-name.adamantite { color: #4a90e2; }
  .merchant-ui__ore-name.cosmic { color: #ff00ff; }

  .merchant-ui__ore-quantity {
    font-size: 14px;
    color: #aaa;
  }

  .merchant-ui__ore-value {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 16px;
    font-weight: 600;
    color: #ffd700;
    margin-right: 15px;
  }

  .merchant-ui__coin-icon {
    width: 20px;
    height: 20px;
    background: #ffd700;
    border-radius: 50%;
    display: inline-block;
  }

  .merchant-ui__sell-button {
    padding: 8px 16px;
    background: linear-gradient(180deg, rgba(76, 175, 80, 0.9), rgba(46, 125, 50, 0.95));
    border: 2px solid #4caf50;
    border-radius: 6px;
    color: #fff;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    text-transform: uppercase;
  }

  .merchant-ui__sell-button:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
  }

  .merchant-ui__sell-button:active {
    transform: scale(0.98);
  }

  .merchant-ui__footer {
    padding: 15px 20px;
    border-top: 2px solid #4a90e2;
    display: flex;
    justify-content: center;
  }

  .merchant-ui__sell-all-button {
    padding: 12px 40px;
    background: linear-gradient(180deg, rgba(76, 175, 80, 0.9), rgba(46, 125, 50, 0.95));
    border: 3px solid #4caf50;
    border-radius: 8px;
    color: #fff;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .merchant-ui__sell-all-button:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(76, 175, 80, 0.5);
  }

  .merchant-ui__sell-all-button:active {
    transform: scale(0.98);
  }

  /* Scrollbar styling */
  .merchant-ui__content::-webkit-scrollbar {
    width: 8px;
  }

  .merchant-ui__content::-webkit-scrollbar-track {
    background: rgba(30, 40, 80, 0.5);
    border-radius: 4px;
  }

  .merchant-ui__content::-webkit-scrollbar-thumb {
    background: #4a90e2;
    border-radius: 4px;
  }

  .merchant-ui__content::-webkit-scrollbar-thumb:hover {
    background: #5aa0f2;
  }

  /* Mine Reset Upgrade UI */
  .mine-reset-upgrade-ui {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 400px;
    background: rgba(21, 26, 60, 0.98);
    border: 3px solid #4caf50;
    border-radius: 12px;
    display: none;
    flex-direction: column;
    z-index: 1000;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
  }

  .mine-reset-upgrade-ui.visible {
    display: flex;
  }

.mine-reset-upgrade-ui__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 2px solid #4caf50;
}

.mine-reset-upgrade-ui__title-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.mine-reset-upgrade-ui__title {
  font-size: 24px;
  font-weight: 700;
  color: #fff;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.mine-reset-upgrade-ui__subtitle {
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: #9aa3b2;
}

.mine-reset-upgrade-ui__close {
  width: 32px;
  height: 32px;
  border: none;
  background: rgba(244, 67, 54, 0.8);
    color: #fff;
    font-size: 24px;
    font-weight: 700;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    line-height: 1;
  }

  .mine-reset-upgrade-ui__close:hover {
    background: rgba(244, 67, 54, 1);
    transform: scale(1.1);
  }

  .mine-reset-upgrade-ui__body {
    padding: 30px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
  }

  .mine-reset-upgrade-ui__description {
    font-size: 16px;
    color: #fff;
    text-align: center;
    line-height: 1.5;
  }

  .mine-reset-upgrade-ui__button-container {
    display: flex;
    justify-content: center;
    width: 100%;
  }

  .mine-reset-upgrade-ui__button {
    padding: 18px 40px;
    border-radius: 12px;
    border: 3px solid #4caf50;
    background: linear-gradient(180deg, rgba(76, 175, 80, 0.9), rgba(46, 125, 50, 0.95));
    color: #fff;
    font-size: 24px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 2px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    min-width: 200px;
    pointer-events: auto;
  }

  .mine-reset-upgrade-ui__button:hover:not(.disabled):not(.bought) {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(76, 175, 80, 0.5);
    background: linear-gradient(180deg, rgba(96, 195, 100, 0.95), rgba(66, 145, 70, 1));
  }

  .mine-reset-upgrade-ui__button:active:not(.disabled):not(.bought) {
    transform: scale(0.98);
  }

  .mine-reset-upgrade-ui__button.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    filter: grayscale(0.5);
    background: linear-gradient(180deg, rgba(100, 100, 100, 0.9), rgba(70, 70, 70, 0.95));
    border-color: #666;
  }

  .mine-reset-upgrade-ui__button.bought {
    opacity: 0.5;
    cursor: not-allowed;
    filter: grayscale(0.8);
    background: linear-gradient(180deg, rgba(100, 100, 100, 0.9), rgba(70, 70, 70, 0.95));
    border-color: #666;
    pointer-events: none;
  }

  .mine-reset-upgrade-ui__button.bought:hover {
    transform: none !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4) !important;
    background: linear-gradient(180deg, rgba(100, 100, 100, 0.9), rgba(70, 70, 70, 0.95)) !important;
  }

  .mine-reset-upgrade-ui__button-text {
    display: block;
    text-shadow: 
      -1px -1px 0 #000,
      1px -1px 0 #000,
      -1px 1px 0 #000,
      1px 1px 0 #000;
  }

  .mine-reset-upgrade-ui__status {
    font-size: 14px;
    text-align: center;
    padding: 10px;
    border-radius: 8px;
    min-height: 20px;
  }

  .mine-reset-upgrade-ui__status--can-afford {
    color: #4caf50;
  }

  .mine-reset-upgrade-ui__status--cannot-afford {
    color: #f44336;
  }

  .mine-reset-upgrade-ui__status--bought {
    color: #4caf50;
    font-weight: 700;
  }

  /* Gem Trader Upgrades UI */
  .gem-trader-ui {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 600px;
    max-height: 700px;
    background: rgba(21, 26, 60, 0.98);
    border: 3px solid #4caf50;
    border-radius: 12px;
    display: none;
    flex-direction: column;
    z-index: 1000;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
  }

  .gem-trader-ui.visible {
    display: flex;
  }

.gem-trader-ui__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 2px solid #4caf50;
}

.gem-trader-ui__title-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
  align-items: center;
}

.gem-trader-ui__help-button {
  width: 32px;
  height: 32px;
  border: none;
  background: rgba(76, 175, 80, 0.8);
    color: #fff;
    font-size: 20px;
    font-weight: 700;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .gem-trader-ui__help-button:hover {
    background: rgba(76, 175, 80, 1);
    transform: scale(1.05);
  }

.gem-trader-ui__title {
  font-size: 28px;
  font-weight: 700;
  color: #fff;
  text-transform: uppercase;
  letter-spacing: 1px;
  text-shadow: -1px -1px 0 rgba(0, 0, 0, 0.5),
    1px -1px 0 rgba(0, 0, 0, 0.5),
    -1px 1px 0 rgba(0, 0, 0, 0.5),
    1px 1px 0 rgba(0, 0, 0, 0.5);
}

.gem-trader-ui__subtitle {
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: #9aa3b2;
}

  .gem-trader-ui__close {
    width: 32px;
    height: 32px;
    border: none;
    background: rgba(244, 67, 54, 0.8);
    color: #fff;
    font-size: 24px;
    font-weight: 700;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    line-height: 1;
  }

  .gem-trader-ui__close:hover {
    background: rgba(244, 67, 54, 1);
    transform: scale(1.1);
  }

  .gem-trader-ui__content {
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .gem-trader-ui__upgrade-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: rgba(30, 35, 70, 0.8);
    border-radius: 8px;
    border: 2px solid rgba(76, 175, 80, 0.3);
  }

  .gem-trader-ui__icon-container {
    position: relative;
    width: 64px;
    height: 64px;
    flex-shrink: 0;
  }

  .gem-trader-ui__icon {
    font-size: 48px;
    width: 64px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .gem-trader-ui__arrow-overlay {
    position: absolute;
    top: -4px;
    right: -4px;
    font-size: 16px;
    color: #ff9800;
    font-weight: 700;
    text-shadow: -1px -1px 0 rgba(0, 0, 0, 0.8),
      1px -1px 0 rgba(0, 0, 0, 0.8),
      -1px 1px 0 rgba(0, 0, 0, 0.8),
      1px 1px 0 rgba(0, 0, 0, 0.8);
  }

  .gem-trader-ui__details {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .gem-trader-ui__upgrade-title {
    font-size: 20px;
    font-weight: 700;
    color: #fff;
  }

  .gem-trader-ui__effect {
    font-size: 16px;
    color: #4caf50;
    font-weight: 600;
  }

  .gem-trader-ui__level-cost-container {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
  }

  .gem-trader-ui__level-progress {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 14px;
    color: #4caf50;
    font-weight: 600;
  }

  .gem-trader-ui__level-arrow {
    color: #ff9800;
  }

  .gem-trader-ui__cost {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 14px;
    color: #4caf50;
    font-weight: 600;
  }

  .gem-trader-ui__gem-icon {
    font-size: 16px;
  }

  .gem-trader-ui__upgrade-button {
    width: 48px;
    height: 48px;
    border: none;
    border-radius: 8px;
    font-size: 28px;
    font-weight: 700;
    color: #fff;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .gem-trader-ui__upgrade-button.can-afford {
    background: rgba(76, 175, 80, 0.9);
    border: 2px solid #4caf50;
  }

  .gem-trader-ui__upgrade-button.can-afford:hover {
    background: rgba(76, 175, 80, 1);
    transform: scale(1.1);
  }

  .gem-trader-ui__upgrade-button.cannot-afford {
    background: rgba(244, 67, 54, 0.7);
    border: 2px solid #f44336;
    cursor: not-allowed;
    opacity: 0.6;
  }

  .gem-trader-ui__upgrade-button:disabled {
    cursor: not-allowed;
    opacity: 0.6;
  }

  .gem-trader-ui__content::-webkit-scrollbar {
    width: 8px;
  }

  .gem-trader-ui__content::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
  }

  .gem-trader-ui__content::-webkit-scrollbar-thumb {
    background: rgba(76, 175, 80, 0.6);
    border-radius: 4px;
  }

  .gem-trader-ui__content::-webkit-scrollbar-thumb:hover {
    background: rgba(76, 175, 80, 0.8);
  }

  /* ============================================
   * MOBILE RESPONSIVE STYLES
   * ============================================ */

  /*
   * Safe Area Support for Mobile Devices
   * Ensures UI elements respect device safe areas (notches, home indicators, etc.)
   */
  body.mobile {
    padding-top: env(safe-area-inset-top);
    padding-right: env(safe-area-inset-right);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: env(safe-area-inset-left);
  }

  /* Mobile controls with safe area support */
  body.mobile .mobile-controls {
    display: flex;
    gap: 14px;
    position: fixed;
    bottom: calc(40px + env(safe-area-inset-bottom));
    right: calc(40px + env(safe-area-inset-right));
    pointer-events: auto;
  }

  /* Left actions - mobile positioning with safe area */
  body.mobile .left-actions {
    left: calc(12px + env(safe-area-inset-left));
    top: 50%;
    transform: translateY(-50%);
    gap: 8px;
  }

  body.mobile .action-card {
    width: 56px;
    height: 56px;
    border-radius: 10px;
  }

  body.mobile .action-card__icon {
    font-size: 26px;
  }

  body.mobile .action-card__badge {
    width: 18px;
    height: 18px;
    font-size: 11px;
    top: -4px;
    right: -4px;
  }

  /* Stats HUD - mobile compact icon style (similar to Pets repo) */
  body.mobile .stats-hud-container {
    position: fixed;
    top: calc(12px + env(safe-area-inset-top));
    right: calc(12px + env(safe-area-inset-right));
    transform: none;
    flex-direction: row;
    flex-wrap: wrap;
    gap: 6px;
    max-width: 200px;
    justify-content: flex-end;
  }

  body.mobile .stat-hud {
    min-width: auto;
    padding: 6px 10px;
    border-radius: 8px;
    border-width: 2px;
    gap: 4px;
    flex-direction: row-reverse;
  }

  body.mobile .stat-hud__value {
    font-size: 13px;
    text-shadow:
      0 0 4px rgba(255, 215, 0, 0.4),
      0 1px 2px rgba(0, 0, 0, 0.8);
  }

  body.mobile .stat-hud__icon {
    font-size: 16px;
    width: 20px;
    height: 20px;
    margin-left: 0;
    margin-right: 0;
  }

  /* Hide HUD elements when modals are open */
  body.modal-open .left-actions,
  body.modal-open .stats-hud-container,
  body.modal-open .mobile-controls,
  body.modal-open .depth-bar-container,
  body.modal-open .training-prompt,
  body.modal-open .auto-controls,
  body.modal-open .mining-controls,
  body.modal-open .progress-bar,
  body.modal-open .mining-hud,
  body.modal-open .mine-reset-timer,
  body.modal-open .mining-depth-counter {
    display: none !important;
  }

  /* Progress Bar (Depth) - mobile vertical style on right side */
  body.mobile .progress-bar {
    position: fixed;
    bottom: auto;
    left: auto;
    right: calc(10px + env(safe-area-inset-right));
    top: 50%;
    transform: translateY(-50%);
    padding: 0;
    width: auto;
    height: auto;
    z-index: 1000;
  }

  body.mobile .progress-bar__container {
    max-width: none;
    margin: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  body.mobile .progress-bar__outline {
    width: 20px;
    height: 140px;
    border-width: 3px;
    border-radius: 10px;
    position: relative;
    background: rgba(11, 15, 26, 0.9);
    border-color: rgba(82, 196, 255, 0.4);
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
  }

  body.mobile .progress-bar__fill {
    position: absolute;
    top: auto;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
    height: 0%;
    background: linear-gradient(0deg, #4caf50 0%, #66bb6a 50%, #81c784 100%);
    border-radius: 7px;
    transition: height 0.3s ease;
  }

  body.mobile .progress-bar__marker {
    position: absolute;
    top: auto;
    left: -4px;
    width: 28px;
    height: 16px;
    border-radius: 8px;
    border-width: 2px;
    transform: translateY(50%);
    transition: bottom 0.3s ease;
    bottom: 0%;
  }

  /* Position markers to the left of vertical bar on mobile */
  body.mobile .progress-bar__markers {
    display: flex;
    flex-direction: column-reverse;
    justify-content: space-between;
    position: absolute;
    right: 100%;
    margin-right: 6px;
    top: 0;
    bottom: 0;
    height: 100%;
    padding: 0;
  }

  body.mobile .progress-bar__marker-label {
    font-size: 9px;
    line-height: 1;
    color: rgba(255, 255, 255, 0.8);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
    text-align: right;
  }

  /* Depth bar - mobile positioning (legacy, may not be used) */
  body.mobile .depth-bar-container {
    bottom: calc(12px + env(safe-area-inset-bottom));
    left: calc(12px + env(safe-area-inset-left));
    right: calc(12px + env(safe-area-inset-right));
  }

  body.mobile .depth-bar {
    height: 20px;
  }

  body.mobile .depth-bar__label {
    font-size: 11px;
  }

  /* Auto controls - mobile positioning (bottom center) */
  body.mobile .auto-controls {
    top: auto;
    right: auto;
    bottom: calc(20px + env(safe-area-inset-bottom));
    left: 50%;
    transform: translateX(-50%);
    flex-direction: row;
    gap: 8px;
  }

  body.mobile .auto-btn {
    padding: 8px 14px;
    font-size: 12px;
    border-radius: 8px;
  }

  /* To Surface button - mobile positioning */
  body.mobile .to-surface-btn {
    top: calc(12px + env(safe-area-inset-top));
    padding: 10px 18px;
    font-size: 13px;
  }

  /* Mine Reset Timer - mobile positioning (bottom right, compact) */
  body.mobile .mine-reset-timer {
    bottom: calc(12px + env(safe-area-inset-bottom));
    right: calc(12px + env(safe-area-inset-right));
  }

  body.mobile .mine-reset-timer__text {
    padding: 5px 10px;
    font-size: 12px;
    border-width: 2px;
    border-radius: 6px;
  }

  body.mobile .mine-reset-timer__text::before {
    font-size: 10px;
  }

  /* Mining Depth Counter - mobile positioning (above progress bar on right) */
  body.mobile .mining-depth-counter {
    right: calc(10px + env(safe-area-inset-right));
    top: calc(50% - 100px);
  }

  body.mobile .mining-depth-counter__text {
    padding: 3px 8px;
    font-size: 10px;
    border-width: 1px;
    border-radius: 4px;
  }

  /* ============================================
   * MOBILE MODAL STYLES
   * ============================================ */

  /* Base modal - mobile sizing */
  body.mobile .modal {
    padding: 8px;
  }

  /* Pickaxe/Miner modal - mobile sizing */
  body.mobile .pickaxe-modal__container {
    width: 95vw;
    max-width: 95vw;
    height: auto;
    max-height: 85vh;
    min-height: 0;
  }

  body.mobile .pickaxe-modal__header {
    padding: 12px 14px;
  }

  body.mobile .pickaxe-modal__title {
    font-size: 20px;
  }

  body.mobile .pickaxe-modal__close {
    width: 32px;
    height: 32px;
    font-size: 16px;
  }

  body.mobile .pickaxe-modal__body {
    padding: 10px;
    gap: 10px;
    flex-direction: column;
  }

  /* Pickaxe/Miner selected panel - mobile */
  body.mobile .pickaxe-modal__selected {
    width: 100%;
    min-width: 0;
    padding: 12px;
    flex-shrink: 0;
  }

  body.mobile .pickaxe-modal__selected-image {
    width: 80px;
    height: 80px;
  }

  body.mobile .pickaxe-modal__selected-name {
    font-size: 16px;
  }

  body.mobile .pickaxe-modal__selected-stat {
    font-size: 13px;
    padding: 4px 10px;
  }

  /* Pickaxe/Miner grid - mobile */
  body.mobile .pickaxe-grid-container {
    flex: 1;
    min-height: 150px;
    max-height: 40vh;
  }

  body.mobile .pickaxe-grid {
    grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
    gap: 8px;
    padding: 8px;
  }

  body.mobile .pickaxe-card {
    padding: 8px;
    min-width: 0;
  }

  body.mobile .pickaxe-card__image {
    width: 48px;
    height: 48px;
  }

  body.mobile .pickaxe-card__name {
    font-size: 11px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }

  body.mobile .pickaxe-card__price {
    font-size: 12px;
    padding: 3px 8px;
  }

  body.mobile .pickaxe-card__price-icon {
    font-size: 14px;
  }

  /* Maps modal - mobile sizing */
  body.mobile .maps-modal .pickaxe-modal__container {
    width: 95vw;
    height: auto;
    max-height: 85vh;
  }

  body.mobile .maps-modal .pickaxe-modal__title {
    font-size: 24px;
    letter-spacing: 1px;
  }

  body.mobile .map-list {
    gap: 10px;
    padding: 10px;
  }

  body.mobile .map-card {
    padding: 14px 16px;
  }

  body.mobile .map-card__name {
    font-size: 18px;
  }

  body.mobile .map-card__requirement {
    font-size: 12px;
    padding: 4px 10px;
  }

  body.mobile .map-card__button {
    padding: 8px 16px;
    font-size: 13px;
  }

  /* Rebirth modal - mobile sizing */
  body.mobile .rebirth-modal__container {
    width: 95vw;
    max-width: 95vw;
    max-height: 85vh;
  }

  body.mobile .rebirth-modal__title {
    font-size: 22px;
  }

  body.mobile .rebirth-modal__header {
    padding: 12px 14px;
  }

  body.mobile .rebirth-modal__close {
    width: 32px;
    height: 32px;
    font-size: 16px;
  }

  body.mobile .rebirth-modal__body {
    padding: 12px;
    gap: 10px;
  }

  body.mobile .rebirth-modal__instruction {
    font-size: 14px;
  }

  body.mobile .rebirth-option {
    padding: 12px 14px;
  }

  body.mobile .rebirth-option__info h4 {
    font-size: 15px;
  }

  body.mobile .rebirth-option__info p {
    font-size: 12px;
  }

  body.mobile .rebirth-option__button {
    padding: 8px 14px;
    font-size: 12px;
  }

  /* Pets modal - mobile sizing */
  body.mobile .pets-modal__container {
    width: 95vw;
    max-width: 95vw;
    max-height: 85vh;
  }

  body.mobile .pets-modal__header {
    padding: 12px 14px;
  }

  body.mobile .pets-modal__title {
    font-size: 20px;
  }

  body.mobile .pets-modal__close {
    width: 32px;
    height: 32px;
    font-size: 16px;
  }

  body.mobile .pets-modal__stats {
    padding: 8px 12px;
    gap: 10px;
    font-size: 12px;
  }

  body.mobile .pets-modal__body {
    padding: 10px;
    gap: 10px;
    flex-direction: column;
  }

  /* Pets grid - mobile */
  body.mobile .pets-grid-container {
    max-height: 35vh;
  }

  body.mobile .pets-grid {
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    gap: 8px;
    padding: 8px;
  }

  body.mobile .pet-card {
    padding: 6px;
  }

  body.mobile .pet-card__image {
    width: 44px;
    height: 44px;
  }

  body.mobile .pet-card__name {
    font-size: 9px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  body.mobile .pet-card__rarity {
    font-size: 8px;
    padding: 2px 6px;
  }

  /* Pets equipped slots - mobile */
  body.mobile .pets-equipped-container {
    width: 100%;
  }

  body.mobile .pets-equipped-grid {
    grid-template-columns: repeat(4, 1fr);
    gap: 6px;
  }

  body.mobile .pet-equipped-slot {
    width: 100%;
    aspect-ratio: 1;
    min-height: 50px;
  }

  body.mobile .pet-equipped-slot__image {
    width: 36px;
    height: 36px;
  }

  /* Pets action buttons - mobile */
  body.mobile .pets-actions {
    gap: 6px;
    padding: 8px;
  }

  body.mobile .pets-action-btn {
    padding: 8px 12px;
    font-size: 12px;
  }

  /* Egg shop modal - mobile sizing */
  body.mobile .egg-shop-modal__container {
    width: 95vw;
    max-width: 95vw;
    max-height: 85vh;
  }

  body.mobile .egg-shop-modal__header {
    padding: 12px 14px;
  }

  body.mobile .egg-shop-modal__title {
    font-size: 20px;
  }

  body.mobile .egg-shop-modal__body {
    padding: 10px;
  }

  body.mobile .egg-card {
    padding: 10px;
  }

  body.mobile .egg-card__image {
    width: 60px;
    height: 60px;
  }

  body.mobile .egg-card__name {
    font-size: 14px;
  }

  body.mobile .egg-card__price {
    font-size: 13px;
  }

  /* Merchant/Gem trader modal - mobile sizing */
  body.mobile .merchant-ui__container,
  body.mobile .gem-trader-ui__container {
    width: 95vw;
    max-width: 95vw;
    max-height: 85vh;
  }

  body.mobile .merchant-ui__header,
  body.mobile .gem-trader-ui__header {
    padding: 12px 14px;
  }

  body.mobile .merchant-ui__title,
  body.mobile .gem-trader-ui__title {
    font-size: 20px;
  }

  body.mobile .merchant-ui__close,
  body.mobile .gem-trader-ui__close {
    width: 32px;
    height: 32px;
    font-size: 16px;
  }

  body.mobile .merchant-ui__content,
  body.mobile .gem-trader-ui__content {
    padding: 10px;
    gap: 8px;
    max-height: 60vh;
  }

  body.mobile .merchant-ui__item,
  body.mobile .gem-trader-ui__item {
    padding: 10px;
  }

  body.mobile .merchant-ui__item-name,
  body.mobile .gem-trader-ui__upgrade-name {
    font-size: 14px;
  }

  body.mobile .merchant-ui__item-desc,
  body.mobile .gem-trader-ui__upgrade-desc {
    font-size: 11px;
  }

  body.mobile .merchant-ui__sell-button,
  body.mobile .gem-trader-ui__upgrade-button {
    padding: 8px 14px;
    font-size: 12px;
  }

  /* ============================================
   * MOBILE TOUCH SCROLLING SUPPORT
   * ============================================ */

  /* Enable touch scrolling for all modal content areas */
  body.mobile .pickaxe-grid-container,
  body.mobile .pickaxe-grid-container *,
  body.mobile .pickaxe-grid {
    touch-action: pan-y !important;
    -webkit-overflow-scrolling: touch !important;
  }

  body.mobile .pets-grid-container,
  body.mobile .pets-grid-container *,
  body.mobile .pets-grid {
    touch-action: pan-y !important;
    -webkit-overflow-scrolling: touch !important;
  }

  body.mobile .map-list,
  body.mobile .map-list * {
    touch-action: pan-y !important;
    -webkit-overflow-scrolling: touch !important;
  }

  body.mobile .rebirth-modal__body,
  body.mobile .rebirth-modal__body * {
    touch-action: pan-y !important;
    -webkit-overflow-scrolling: touch !important;
  }

  body.mobile .merchant-ui__content,
  body.mobile .merchant-ui__content *,
  body.mobile .gem-trader-ui__content,
  body.mobile .gem-trader-ui__content * {
    touch-action: pan-y !important;
    -webkit-overflow-scrolling: touch !important;
  }

  body.mobile .egg-shop-modal__body,
  body.mobile .egg-shop-modal__body * {
    touch-action: pan-y !important;
    -webkit-overflow-scrolling: touch !important;
  }

  /* Training prompt - mobile positioning */
  body.mobile .training-prompt {
    bottom: calc(50px + env(safe-area-inset-bottom));
    font-size: 13px;
    padding: 10px 16px;
    max-width: 90vw;
  }

  /* Block Health Bar - mobile positioning (just above auto buttons) */
  body.mobile .block-health-bar {
    bottom: calc(90px + env(safe-area-inset-bottom));
    gap: 4px;
  }

  body.mobile .block-health-bar__header {
    justify-content: space-between;
    width: 100%;
    gap: 12px;
  }

  body.mobile .block-health-bar__name {
    font-size: 16px;
    letter-spacing: 1px;
  }

  body.mobile .block-health-bar__container {
    width: 220px;
  }

  body.mobile .block-health-bar__outline {
    height: 24px;
    border-width: 2px;
  }

  body.mobile .block-health-bar__text {
    font-size: 11px;
  }

  body.mobile .block-health-bar__reward {
    font-size: 14px;
    margin-top: 0;
    gap: 4px;
  }


<!-- Included from: ./components/ThemeStyles.html -->

  body.mobile .training-prompt__title {
    font-size: 14px;
  }

  body.mobile .training-prompt__requirement {
    font-size: 11px;
  }

</style>
<style>
/* Fredoka font is loaded dynamically at the top of this file */

:root {
  --od-bg: #0d0f1a;
  --od-card: #141a2a;
  --od-card-elevated: #1b2236;
  --od-border: #2a3350;
  --od-primary: #f4c44e;
  --od-primary-strong: #f7d35c;
  --od-secondary: #37d6e8;
  --od-secondary-strong: #4be7f5;
  --od-accent: #2bd67f;
  --od-epic: #a855f7;
  --od-legendary-start: #f7d35c;
  --od-legendary-end: #f59e0b;
  --od-danger: #ef4444;
  --od-warning: #f59e0b;
  --od-success: #22c55e;
  --od-muted: #9aa3b2;
  --od-text: #f8f3e6;
  --od-shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
  --od-shadow-soft: 0 6px 18px rgba(0, 0, 0, 0.35);
  --od-inset: inset 0 2px 6px rgba(0, 0, 0, 0.35);
}

.ui-root {
  color: var(--od-text);
  font-family: "Fredoka", sans-serif;
  text-rendering: optimizeLegibility;
}

.ui-root button,
.ui-root .stat-hud__value,
.ui-root .pickaxe-details__name,
.ui-root .pickaxe-details__stats,
.ui-root .pickaxe-details__action-button,
.ui-root .rebirth-button,
.ui-root .mine-reset-upgrade-ui__button,
.ui-root .merchant-ui__sell-all-button,
.ui-root .auto-control-button,
.ui-root .mining-control-button {
  font-family: "Fredoka", sans-serif;
}

.ui-root .merchant-ui__title,
.ui-root .mine-reset-upgrade-ui__title,
.ui-root .gem-trader-ui__title,
.ui-root .pickaxe-modal__title,
.ui-root .rebirth-modal__title,
.ui-root .maps-modal__title,
.ui-root .pets-modal .pickaxe-modal__title {
  font-family: "Fredoka", sans-serif;
  letter-spacing: 1px;
}

/* Global interactive polish */
.ui-root button {
  box-shadow: var(--od-shadow-soft);
  border-color: var(--od-border);
}

.ui-root button:hover {
  filter: brightness(1.05);
}

.ui-root button:active {
  transform: translateY(1px);
  box-shadow: none;
}

/* Stat HUD */
.stat-hud {
  background: linear-gradient(180deg, rgba(20, 26, 42, 0.98), rgba(12, 16, 28, 0.95));
  border: 2px solid var(--od-border);
  box-shadow: var(--od-shadow);
}

.stat-hud__value {
  font-weight: 700;
  letter-spacing: 0.5px;
  text-shadow: 0 0 12px rgba(244, 196, 78, 0.3);
}

.stat-hud__icon {
  filter: drop-shadow(0 3px 8px rgba(0, 0, 0, 0.5));
}

.stat-hud--money .stat-hud__value,
.stat-hud--wins .stat-hud__value {
  color: var(--od-primary);
}

.stat-hud--gems .stat-hud__value {
  color: var(--od-epic);
}

.stat-hud--power .stat-hud__value {
  color: var(--od-secondary);
}

.stat-hud--rebirths .stat-hud__value {
  color: var(--od-accent);
}

/* Action cards */
.action-card {
  background: linear-gradient(180deg, rgba(20, 26, 42, 0.95), rgba(13, 17, 30, 0.98));
  border: 2px solid var(--od-border);
  box-shadow: var(--od-shadow-soft);
}

.action-card--miner {
  border-color: rgba(55, 214, 232, 0.5);
}

.action-card--pickaxe {
  border-color: rgba(244, 196, 78, 0.6);
}

.action-card--rebirth {
  border-color: rgba(245, 158, 11, 0.6);
}

.action-card--pets {
  border-color: rgba(43, 214, 127, 0.6);
}

.action-card--maps {
  border-color: rgba(88, 118, 255, 0.6);
}

.action-card__badge {
  background: radial-gradient(circle, var(--od-primary), var(--od-legendary-end));
  color: #1a1202;
  box-shadow: 0 0 10px rgba(244, 196, 78, 0.6);
}

/* Mining HUD */
.mining-hud__damage {
  background: linear-gradient(180deg, rgba(20, 26, 42, 0.98), rgba(12, 16, 28, 0.95));
  border: 2px solid rgba(55, 214, 232, 0.5);
  box-shadow: var(--od-shadow-soft);
}

.block-health-bar__name {
  font-family: "Fredoka", sans-serif;
  color: var(--od-text);
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.7);
}

.block-health-bar__outline {
  background: rgba(10, 14, 24, 0.95);
  border: 2px solid var(--od-border);
}

.block-health-bar__fill {
  background: linear-gradient(90deg, var(--od-success), #6ee7b7);
  box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
}

.block-health-bar__text {
  font-family: "Fredoka", sans-serif;
  text-shadow: 0 0 6px rgba(0, 0, 0, 0.6);
}

.mining-depth-counter__text {
  background: linear-gradient(180deg, rgba(20, 26, 42, 0.98), rgba(12, 16, 28, 0.95));
  border: 2px solid rgba(55, 214, 232, 0.5);
}

.progress-bar__outline {
  border: 2px solid var(--od-border);
  background: rgba(11, 15, 26, 0.95);
  box-shadow: var(--od-shadow-soft);
}

.progress-bar__fill {
  background: linear-gradient(90deg, var(--od-secondary), var(--od-accent), var(--od-primary));
  box-shadow: 0 0 12px rgba(55, 214, 232, 0.5);
}

.progress-bar__marker {
  background: radial-gradient(circle, #ffffff 0%, var(--od-primary) 45%, var(--od-legendary-end) 100%);
  border: 2px solid var(--od-border);
}

.progress-bar__marker-label {
  font-family: "Fredoka", sans-serif;
}

/* Controls */
.mining-control-button {
  background: linear-gradient(180deg, rgba(20, 26, 42, 0.98), rgba(12, 16, 28, 0.95));
  border: 2px solid rgba(55, 214, 232, 0.6);
  text-shadow: 0 0 8px rgba(55, 214, 232, 0.4);
}

.mining-control-button--surface {
  background: linear-gradient(180deg, var(--od-accent), #1f9f62);
  border-color: rgba(43, 214, 127, 0.8);
}

.auto-control-button {
  background: linear-gradient(180deg, rgba(20, 26, 42, 0.98), rgba(12, 16, 28, 0.95));
  border: 2px solid rgba(244, 196, 78, 0.5);
}

.auto-control-button.inactive {
  background: linear-gradient(180deg, var(--od-accent), #1f9f62);
  border-color: rgba(43, 214, 127, 0.8);
}

.auto-control-button.active {
  background: linear-gradient(180deg, var(--od-danger), #b91c1c);
  border-color: rgba(239, 68, 68, 0.9);
}

/* Modals */
.modal {
  background: rgba(6, 8, 16, 0.7);
  backdrop-filter: blur(2px);
}

.pickaxe-modal__container,
.rebirth-modal__container,
.pets-modal .pickaxe-modal__container,
.maps-modal .pickaxe-modal__container {
  background: linear-gradient(180deg, rgba(20, 26, 42, 0.98), rgba(12, 16, 28, 0.96));
  border: 2px solid var(--od-border);
  box-shadow: var(--od-shadow);
}

.pickaxe-modal__header,
.rebirth-modal__header,
.maps-modal .pickaxe-modal__header {
  border-bottom: 2px solid var(--od-border);
}

.pickaxe-modal__close,
.rebirth-modal__close,
.maps-modal__close,
.merchant-ui__close,
.mine-reset-upgrade-ui__close,
.gem-trader-ui__close,
.pet-detail__close {
  background: rgba(239, 68, 68, 0.85);
  border: 2px solid rgba(239, 68, 68, 0.9);
}

.pickaxe-details__icon,
.pickaxe-details__badge {
  background: rgba(15, 20, 32, 0.85);
  border: 2px solid var(--od-border);
  box-shadow: var(--od-shadow-soft);
}

.pickaxe-details__action-button {
  background: linear-gradient(180deg, var(--od-primary), var(--od-legendary-end));
  border: none;
  color: #1a1202;
  text-transform: uppercase;
}

.pickaxe-details__action-button.disabled {
  background: rgba(120, 120, 120, 0.4);
  color: #e5e7eb;
}

.pickaxe-grid {
  gap: 18px;
}

.pickaxe-card {
  background: linear-gradient(180deg, rgba(20, 26, 42, 0.95), rgba(12, 16, 28, 0.98));
  border: 2px solid var(--od-border);
  box-shadow: var(--od-shadow-soft);
}

.pickaxe-card__cost {
  color: var(--od-primary);
}

.pickaxe-card__checkmark {
  background: var(--od-accent);
  border: 2px solid rgba(43, 214, 127, 0.9);
}

.pickaxe-card.equipped {
  border-color: rgba(43, 214, 127, 0.9);
  box-shadow: 0 0 16px rgba(43, 214, 127, 0.6);
}

.pickaxe-card.selected {
  border-color: rgba(244, 196, 78, 0.9);
  box-shadow: 0 0 16px rgba(244, 196, 78, 0.6);
}

/* Rebirth */
.rebirth-option {
  background: rgba(18, 24, 38, 0.95);
  border: 2px solid var(--od-border);
}

.rebirth-button {
  background: linear-gradient(180deg, var(--od-primary), var(--od-legendary-end));
  color: #1a1202;
  border: none;
}

.rebirth-button--max {
  background: linear-gradient(180deg, var(--od-epic), #6d28d9);
}

.rebirth-button.disabled {
  background: rgba(120, 120, 120, 0.4);
  color: #e5e7eb;
}

/* Pets */
.pets-pill,
.pets-mult {
  background: rgba(18, 24, 38, 0.95);
  border: 2px solid var(--od-border);
}

.pet-detail {
  background: rgba(18, 24, 38, 0.95);
  border: 2px solid var(--od-border);
  box-shadow: var(--od-shadow-soft);
}

.pet-detail__card,
.pet-tile {
  box-shadow: var(--od-inset);
}

.pet-detail__action--equip {
  background: linear-gradient(180deg, var(--od-accent), #1f9f62);
}

.pet-detail__action--unequip {
  background: linear-gradient(180deg, var(--od-danger), #b91c1c);
}

.pets-delete-bar {
  background: rgba(18, 24, 38, 0.98);
  border: 2px solid var(--od-border);
  box-shadow: var(--od-shadow);
}

.pets-delete-bar__btn--green {
  background: linear-gradient(180deg, var(--od-accent), #1f9f62);
}

.pets-delete-bar__btn--red {
  background: linear-gradient(180deg, var(--od-danger), #b91c1c);
}

/* Egg modal */
.egg-results__title,
.egg-result-item__name,
.egg-result-item__mult {
  font-family: "Fredoka", sans-serif;
}

/* Egg hatch overlay */
  .egg-hatch-overlay {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    z-index: 1400;
  }

  .egg-hatch-overlay[hidden] {
    display: none;
  }

  .egg-modal.hatch-hidden {
    opacity: 0;
    pointer-events: none;
  }

.egg-hatch-slots {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 28px;
}

.egg-hatch-slot {
  width: 200px;
  height: 240px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.egg-hatch-egg {
  width: 120px;
  height: 160px;
  border-radius: 55% 55% 45% 45%;
  background: radial-gradient(circle at 30% 30%, #fff7e1 0%, #f3d1a0 45%, #cfa86d 100%);
  border: 4px solid rgba(17, 24, 39, 0.7);
  box-shadow: 0 10px 22px rgba(0, 0, 0, 0.45);
  animation: eggShake 2s ease-in-out;
}

.egg-hatch-slot.is-cracking .egg-hatch-egg {
  opacity: 0;
  transform: scale(0.85);
  transition: opacity 0.25s ease, transform 0.25s ease;
}

.egg-hatch-particles {
  position: absolute;
  width: 180px;
  height: 180px;
  border-radius: 50%;
  opacity: 0;
  background:
    radial-gradient(circle, rgba(255, 214, 102, 0.9) 0%, rgba(255, 214, 102, 0.3) 35%, transparent 60%),
    radial-gradient(circle, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.2) 40%, transparent 65%);
  filter: blur(0.5px);
}

.egg-hatch-slot.is-cracking .egg-hatch-particles {
  animation: eggBurst 0.6s ease-out forwards;
}

.egg-hatch-result {
  position: absolute;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  opacity: 0;
  transform: scale(0.9);
  transition: opacity 0.35s ease, transform 0.35s ease;
  text-align: center;
}

.egg-hatch-slot.is-revealed .egg-hatch-result {
  opacity: 1;
  transform: scale(1);
}

.egg-hatch-result__thumb {
  width: 120px;
  height: 120px;
  border-radius: 16px;
  background: rgba(18, 24, 38, 0.9);
  border: 3px solid rgba(244, 196, 78, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 42px;
  color: #fff;
  box-shadow: 0 10px 22px rgba(0, 0, 0, 0.35);
  overflow: hidden;
}

.egg-hatch-result__thumb img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.egg-hatch-result__name {
  font-size: 18px;
  font-weight: 800;
  color: #f8fafc;
  text-shadow:
    -1px -1px 0 rgba(0, 0, 0, 0.7),
    1px -1px 0 rgba(0, 0, 0, 0.7),
    -1px 1px 0 rgba(0, 0, 0, 0.7),
    1px 1px 0 rgba(0, 0, 0, 0.7);
}

@keyframes eggShake {
  0% { transform: rotate(0deg); }
  10% { transform: rotate(2deg); }
  20% { transform: rotate(-2deg); }
  30% { transform: rotate(3deg); }
  40% { transform: rotate(-3deg); }
  50% { transform: rotate(2deg); }
  60% { transform: rotate(-2deg); }
  70% { transform: rotate(2deg); }
  80% { transform: rotate(-2deg); }
  90% { transform: rotate(1deg); }
  100% { transform: rotate(0deg); }
}

@keyframes eggBurst {
  0% { opacity: 0; transform: scale(0.6); }
  60% { opacity: 1; transform: scale(1); }
  100% { opacity: 0; transform: scale(1.3); }
}

/* Merchant */
.merchant-ui,
.mine-reset-upgrade-ui,
.gem-trader-ui {
  background: linear-gradient(180deg, rgba(20, 26, 42, 0.98), rgba(12, 16, 28, 0.96));
  border: 2px solid var(--od-border);
  box-shadow: var(--od-shadow);
}

.merchant-ui__header,
.mine-reset-upgrade-ui__header,
.gem-trader-ui__header {
  border-bottom: 2px solid var(--od-border);
}

.merchant-ui__ore-item,
.gem-trader-ui__upgrade-item {
  background: linear-gradient(180deg, rgba(20, 58, 86, 0.98), rgba(16, 45, 68, 0.98));
  border: 2px solid rgba(31, 95, 142, 0.8);
}

.merchant-ui__sell-button,
.merchant-ui__sell-all-button,
.mine-reset-upgrade-ui__button {
  background: linear-gradient(180deg, var(--od-primary), var(--od-legendary-end));
  color: #1a1202;
  border: none;
}

.gem-trader-ui__upgrade-button.can-afford {
  background: linear-gradient(180deg, var(--od-accent), #1f9f62);
}

.gem-trader-ui__upgrade-button.cannot-afford {
  background: linear-gradient(180deg, var(--od-danger), #b91c1c);
}

.gem-trader-ui__effect,
.gem-trader-ui__level-progress,
.gem-trader-ui__cost {
  color: var(--od-accent);
}

/* Scene UI prompts */
.scene-training-prompt,
.scene-egg-prompt {
  background: rgba(18, 24, 38, 0.92);
  border: 2px solid var(--od-border);
  box-shadow: var(--od-shadow-soft);
  font-family: "Fredoka", sans-serif;
}

.scene-training-prompt__requirement,
.scene-training-prompt__rebirth,
.scene-training-prompt__power-gain,
.scene-egg-prompt__title,
.scene-egg-prompt__cost {
  color: var(--od-primary);
}

.scene-training-prompt__or {
  color: var(--od-muted);
}

/* Scene UI: Shop labels */
.scene-shop-prompt {
  background: rgba(18, 24, 38, 0.92);
  border: 2px solid var(--od-border);
  box-shadow: var(--od-shadow-soft);
  font-family: "Fredoka", sans-serif;
  display: flex;
  flex-direction: column;
  gap: 2px;
  min-width: 180px;
  padding: 6px 10px;
  border-radius: 12px;
  color: var(--od-text);
  text-align: center;
  text-transform: uppercase;
  letter-spacing: 1px;
  transition: opacity 0.2s ease;
}

.scene-shop-prompt:not(.visible) {
  opacity: 0;
}

.scene-shop-prompt__title {
  font-size: 20px;
  font-weight: 900;
  color: var(--od-primary);
}

.scene-shop-prompt__subtitle {
  font-size: 12px;
  font-weight: 700;
  color: var(--od-muted);
}

.scene-shop-prompt--ore {
  border-color: rgba(244, 196, 78, 0.7);
}

.scene-shop-prompt--timer {
  border-color: rgba(43, 214, 127, 0.7);
}

.scene-shop-prompt--upgrades {
  border-color: rgba(168, 85, 247, 0.7);
}

/* Scrollable panels: enable wheel + touch drag */
.merchant-ui__content,
.gem-trader-ui__content,
.pets-grid,
.pickaxe-modal__right-panel,
.rebirth-modal__body,
.maps-modal .pickaxe-modal__body,
.egg-results__list,
.egg-shop-grid,
.pickaxe-modal__body {
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
}

/* Scrollbars */
.ui-root ::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

.ui-root ::-webkit-scrollbar-track {
  background: rgba(18, 24, 38, 0.9);
  border-radius: 4px;
}

.ui-root ::-webkit-scrollbar-thumb {
  background: rgba(244, 196, 78, 0.5);
  border-radius: 4px;
}

.ui-root ::-webkit-scrollbar-thumb:hover {
  background: rgba(244, 196, 78, 0.8);
}
</style>

<!-- Livereload - Development Only -->
<script>
  (function() {
    const script = document.createElement('script');
    script.src = 'http://localhost:35729/livereload.js?snipver=1';
    script.async = true;
    document.head.appendChild(script);
  })();
</script>