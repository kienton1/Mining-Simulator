<!--
  SceneUI Templates
  Registers templates for training:prompt, egg:prompt, and shop:prompt
  These are used by the server to create floating UI elements attached to world objects
-->

<script>
  // Register SceneUI templates as soon as hytopia is available
  // This ensures templates are available when server creates SceneUIs
  (function registerSceneUITemplates() {
    if (window.__trainingSceneTemplatesRegistered) return;

    // Wait for hytopia to be available
    if (typeof hytopia === 'undefined') {
      setTimeout(registerSceneUITemplates, 10);
      return;
    }

    window.__trainingSceneTemplatesRegistered = true;
    if (!window.__sceneUiReadySent && typeof hytopia?.sendData === 'function') {
      window.__sceneUiReadySent = true;
      hytopia.sendData({ type: 'SCENE_UI_READY' });
    }

    // Training rock prompt template
    // Uses playerStates dictionary for player-specific visibility
    // Two-mode display: 'far' mode shows rock info, 'close' mode shows interaction prompt
    hytopia.registerSceneUITemplate('training:prompt', (_id, onState) => {
      const root = document.createElement('div');
      root.className = 'scene-training-prompt'; // Start hidden until player state is checked

      // Create content container for mode-based rendering
      const content = document.createElement('div');
      content.className = 'scene-training-prompt__content';
      root.appendChild(content);

      // Helper to get current player ID from DOM (set by PlayerId.html component)
      function getCurrentPlayerId() {
        const playerIdElement = document.getElementById('playerId');
        return playerIdElement?.dataset?.playerId;
      }

      // Handle state updates
      onState(state => {
        const data = state || {};

        // Check player-specific visibility using playerStates dictionary
        const currentPlayerId = getCurrentPlayerId();
        const playerStates = data.playerStates || {};

        console.log('[TrainingUI] State update received:', {
          currentPlayerId,
          playerStatesKeys: Object.keys(playerStates),
          playerStates: JSON.stringify(playerStates),
        });

        // If playerStates exists and we have a player ID, use player-specific visibility
        if (currentPlayerId && Object.keys(playerStates).length > 0) {
          const playerState = playerStates[currentPlayerId];
          console.log('[TrainingUI] Player state for', currentPlayerId, ':', playerState);

          // Only show if this player's state says visible
          if (playerState?.visible === true) {
            root.classList.add('visible');
            root.style.display = 'flex';

            // Toggle locked state based on player's canTrain
            if (playerState.canTrain === false) {
              root.classList.add('locked');
            } else {
              root.classList.remove('locked');
            }

            // Determine mode (far or close)
            const mode = playerState.mode || 'far';
            console.log('[TrainingUI] Mode for player', currentPlayerId, ':', mode, '(raw:', playerState.mode, ')');

            // Remove existing mode classes
            root.classList.remove('mode-far', 'mode-close');
            root.classList.add('mode-' + mode);
            console.log('[TrainingUI] Applied classes:', root.className);

            // Render content based on mode
            if (mode === 'close') {
              console.log('[TrainingUI] Rendering CLOSE mode content');
              // Close mode - show interaction key + "Train" text
              content.innerHTML = `
                <div class="scene-training-prompt__interaction">
                  <div class="scene-training-prompt__key">E</div>
                  <div class="scene-training-prompt__action">Train</div>
                </div>
              `;
            } else {
              console.log('[TrainingUI] Rendering FAR mode content');
              // Far mode - show rock info (icon, requirements, power gain)
              const rockName = playerState.rockName || data.rockName || 'Training Rock';
              const powerGain = playerState.powerGain || data.powerGainText || '+1 Power';
              const requirementText = data.requirementText || '0 Required';
              const rebirthText = data.rebirthText || '0 Rebirths';
              const powerGainText = data.powerGainText || '+1 Power';

              content.innerHTML = `
                <div class="scene-training-prompt__icon">\uD83D\uDCA5</div>
                <div class="scene-training-prompt__copy">
                  <div class="scene-training-prompt__requirement">${requirementText}</div>
                  <div class="scene-training-prompt__or">OR</div>
                  <div class="scene-training-prompt__rebirth">${rebirthText}</div>
                  <div class="scene-training-prompt__power-gain">${powerGainText}</div>
                </div>
              `;
            }
          } else {
            root.classList.remove('visible');
            root.style.display = 'none';
          }
        } else {
          // Fallback: use global visible flag if no playerStates (backwards compatibility)
          if (data.visible === false) {
            root.classList.remove('visible');
            root.style.display = 'none';
          } else {
            root.classList.add('visible');
            root.style.display = 'flex';

            // Default to far mode for backwards compatibility
            root.classList.remove('mode-far', 'mode-close');
            root.classList.add('mode-far');

            const requirementText = data.requirementText || '0 Required';
            const rebirthText = data.rebirthText || '0 Rebirths';
            const powerGainText = data.powerGainText || '+1 Power';

            content.innerHTML = `
              <div class="scene-training-prompt__icon">\uD83D\uDCA5</div>
              <div class="scene-training-prompt__copy">
                <div class="scene-training-prompt__requirement">${requirementText}</div>
                <div class="scene-training-prompt__or">OR</div>
                <div class="scene-training-prompt__rebirth">${rebirthText}</div>
                <div class="scene-training-prompt__power-gain">${powerGainText}</div>
              </div>
            `;
          }

          // Toggle locked state
          if (data.canTrain === false) {
            root.classList.add('locked');
          } else {
            root.classList.remove('locked');
          }
        }
      });

      return root;
    });

    // Egg station prompt template
    hytopia.registerSceneUITemplate('egg:prompt', (_id, onState) => {
      const root = document.createElement('div');
      root.className = 'scene-egg-prompt visible';

      const icon = document.createElement('div');
      icon.className = 'scene-egg-prompt__icon';
      icon.textContent = '\uD83E\uDD5A'; // ðŸ¥š
      root.appendChild(icon);

      const copy = document.createElement('div');
      copy.className = 'scene-egg-prompt__copy';
      root.appendChild(copy);

      const title = document.createElement('div');
      title.className = 'scene-egg-prompt__title';
      title.textContent = 'Egg';
      copy.appendChild(title);

      const subtitle = document.createElement('div');
      subtitle.className = 'scene-egg-prompt__subtitle';
      subtitle.textContent = 'Open eggs here';
      copy.appendChild(subtitle);

      const cost = document.createElement('div');
      cost.className = 'scene-egg-prompt__cost';
      cost.textContent = '0 gold';
      copy.appendChild(cost);

      onState(state => {
        const data = state || {};
        if (data.title !== undefined) title.textContent = data.title;
        if (data.subtitle !== undefined) {
          subtitle.textContent = data.subtitle;
          // Hide subtitle if empty so this looks like the reference (name + cost only).
          subtitle.style.display = data.subtitle ? 'block' : 'none';
        }
        if (data.costText !== undefined) cost.textContent = data.costText;

        if (data.visible === false) root.classList.remove('visible');
        else root.classList.add('visible');
      });

      return root;
    });

    // Shop prompt template (merchant, gem trader, timer upgrade)
    hytopia.registerSceneUITemplate('shop:prompt', (_id, onState) => {
      const root = document.createElement('div');
      root.className = 'scene-shop-prompt visible';

      const title = document.createElement('div');
      title.className = 'scene-shop-prompt__title';
      title.textContent = 'Shop';
      root.appendChild(title);

      const subtitle = document.createElement('div');
      subtitle.className = 'scene-shop-prompt__subtitle';
      subtitle.textContent = 'Interact to open';
      root.appendChild(subtitle);

      onState(state => {
        const data = state || {};
        if (data.title !== undefined) title.textContent = data.title;
        if (data.subtitle !== undefined) subtitle.textContent = data.subtitle;

        if (data.kind) {
          root.classList.remove('scene-shop-prompt--ore', 'scene-shop-prompt--timer', 'scene-shop-prompt--upgrades');
          root.classList.add(`scene-shop-prompt--${data.kind}`);
        }

        if (data.visible === false) root.classList.remove('visible');
        else root.classList.add('visible');
      });

      return root;
    });

    // Tutorial marker template (player-specific)
    hytopia.registerSceneUITemplate('tutorial:marker', (_id, onState) => {
      const root = document.createElement('div');
      root.className = 'scene-tutorial-marker';

      const arrow = document.createElement('div');
      arrow.className = 'scene-tutorial-marker__arrow';
      arrow.textContent = 'â¬‡';
      root.appendChild(arrow);

      const label = document.createElement('div');
      label.className = 'scene-tutorial-marker__label';
      root.appendChild(label);

      const title = document.createElement('div');
      title.className = 'scene-tutorial-marker__title';
      title.textContent = 'Objective';
      label.appendChild(title);

      const subtitle = document.createElement('div');
      subtitle.className = 'scene-tutorial-marker__subtitle';
      subtitle.textContent = '';
      label.appendChild(subtitle);

      function getCurrentPlayerId() {
        const playerIdElement = document.getElementById('playerId');
        return playerIdElement?.dataset?.playerId;
      }

      onState(state => {
        const data = state || {};
        const currentPlayerId = getCurrentPlayerId();
        const playerStates = data.playerStates || {};
        const playerState = currentPlayerId ? playerStates[currentPlayerId] : null;

        if (playerState?.visible) {
          root.classList.add('visible');
          root.style.display = 'flex';
        } else {
          root.classList.remove('visible');
          root.style.display = 'none';
        }

        if (data.kind) {
          root.classList.remove('scene-tutorial-marker--mine', 'scene-tutorial-marker--shop', 'scene-tutorial-marker--training', 'scene-tutorial-marker--egg');
          root.classList.add(`scene-tutorial-marker--${data.kind}`);
        }

        if (data.title !== undefined) title.textContent = data.title;
        if (data.subtitle !== undefined) {
          subtitle.textContent = data.subtitle;
          subtitle.style.display = data.subtitle ? 'block' : 'none';
        }
      });

      return root;
    });

  })();
</script>
